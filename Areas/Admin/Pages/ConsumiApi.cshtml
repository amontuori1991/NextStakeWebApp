@page
@model NextStakeWebApp.Areas.Admin.Pages.ConsumiApiModel
@using System.Text.Json
@{
    Layout = "/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "Consumi API";

    var percCap = Model.DailyCap > 0
        ? Math.Min(100, Math.Round(Model.TodayTotal * 100.0 / Model.DailyCap, 1))
        : 0;
}

<div class="container py-4 consumi-page">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">📊 Consumi API</h3>

        <div class="btn-group btn-group-sm theme-toggle" role="group" aria-label="Tema">
            <button type="button" class="btn btn-outline-secondary" data-theme-choice="dark">Dark</button>
            <button type="button" class="btn btn-outline-secondary" data-theme-choice="light">Light</button>
        </div>
    </div>

    <p class="text-muted mb-3">Storico chiamate API</p>

    <div class="row g-4 flex-column-reverse flex-lg-row">

        <!-- Tabella -->
        <div class="col-lg-6 d-flex align-items-center justify-content-center">
            <div class="card h-100 w-100">
                <div class="card-header">
                    Storico chiamate API
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Contatore</th>
                                    <th>Origine</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.Records.Any())
                                {
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            Nessun dato disponibile
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var r in Model.Records.OrderByDescending(x => x.Date))
                                    {
                                        <tr>
                                            <td>@r.Date.ToString("dd/MM/yyyy")</td>
                                            <td>@r.Counter</td>
                                            <td>@r.Origin</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafico a torta -->
        <div class="col-lg-6">
            <div class="card h-100 w-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Distribuzione per origine (giorno più recente)</span>
                    <span class="badge bg-secondary">
                        Tetto giornaliero: @Model.DailyCap
                    </span>
                </div>
                <div class="card-body d-flex flex-column">

                    <div class="mb-2 small text-muted">
                        @if (Model.TodayTotal > 0)
                        {
                            <text>Ultimo giorno registrato: @Model.TodayTotal chiamate (@percCap% del tetto).</text>
                        }
                        else
                        {
                            <text>Nessun dato per il giorno più recente.</text>
                        }
                    </div>

                    @if (Model.TodayTotal > 0)
                    {
                        <div class="usage-progress mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Utilizzo giornaliero</span>
                                <span>@percCap% (@Model.TodayTotal / @Model.DailyCap)</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar"
                                     style="width:@percCap%"></div>
                            </div>
                        </div>
                    }

                    <div class="chart-wrapper">
                        <canvas id="apiUsagePie"></canvas>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<style>
    /* === Stesso sistema temi globali === */
    :root[data-theme="dark"] {
        --bg: linear-gradient(135deg, #252e40 0%, #1a2230 100%);
        --text: #e9edf3;
        --muted: rgba(255,255,255,.6);
        --card: rgba(255,255,255,0.06);
        --border: rgba(255,255,255,0.16);
    }

    :root[data-theme="light"] {
        --bg: #f0f2f5;
        --text: #1a2230;
        --muted: #566079;
        --card: #ffffff;
        --border: rgba(0,0,0,0.10);
    }

    html[data-theme] body {
        background: var(--bg);
        color: var(--text);
    }

    .consumi-page {
        color: var(--text);
    }

        .consumi-page .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 10px 26px rgba(0,0,0,.25);
            backdrop-filter: blur(6px);
        }

        .consumi-page .card-header {
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            background: transparent;
        }

        .consumi-page .text-muted {
            color: var(--muted) !important;
        }

    .theme-toggle .btn.active {
        background: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }

    /* === Tabella leggibile in dark / light === */
    :root[data-theme="dark"] .consumi-page .table {
        --bs-table-color: #e9edf3;
        --bs-table-bg: transparent;
        --bs-table-striped-bg: rgba(255,255,255,.03);
        --bs-table-border-color: rgba(255,255,255,.18);
        --bs-table-hover-bg: rgba(255,255,255,.08);
    }

    :root[data-theme="light"] .consumi-page .table {
        --bs-table-color: #1a2230;
        --bs-table-bg: transparent;
        --bs-table-striped-bg: rgba(0,0,0,.015);
        --bs-table-border-color: rgba(0,0,0,.06);
        --bs-table-hover-bg: rgba(0,0,0,.03);
    }

    .consumi-page table th {
        font-size: .85rem;
        text-transform: uppercase;
        letter-spacing: .04em;
    }

    .consumi-page table td {
        font-size: .9rem;
    }
    /* === Forza il colore del testo tabella in base al tema === */
    :root[data-theme="dark"] .consumi-page .table thead th,
    :root[data-theme="dark"] .consumi-page .table tbody td {
        color: #e9edf3 !important; /* testo chiaro */
    }

    :root[data-theme="light"] .consumi-page .table thead th,
    :root[data-theme="light"] .consumi-page .table tbody td {
        color: #1a2230 !important; /* testo scuro */
    }

    /* === Barra di avanzamento === */
    .consumi-page .usage-progress .progress {
        height: 0.6rem;
        border-radius: 999px;
        overflow: hidden;
    }

    :root[data-theme="dark"] .consumi-page .usage-progress .progress {
        background-color: rgba(255,255,255,.12);
    }

    :root[data-theme="light"] .consumi-page .usage-progress .progress {
        background-color: rgba(0,0,0,.08);
    }

    /* === Grafico centrato, un po' più grande ma responsive === */
    .chart-wrapper {
        max-width: 360px;
        width: 100%;
        margin: 0 auto;
        padding: 1rem 0 0.5rem;
    }

        .chart-wrapper canvas {
            width: 100% !important;
            height: auto !important;
        }

    @@media (max-width: 768px) {
        .chart-wrapper {
            max-width: 260px;
        }
    }
</style>

<!-- Chart.js + plugin etichette -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
    // === Toggle tema (usa data-theme su <html>) ===
    (function () {
        function currentTheme() {
            const cookieMatch = document.cookie.match(/(?:^|;\s*)theme=([^;]+)/);
            const cookieValue = cookieMatch ? decodeURIComponent(cookieMatch[1]) : null;
            const stored = cookieValue || localStorage.getItem('theme');
            return (stored === 'light' || stored === 'dark') ? stored : 'dark';
        }

        function applyTheme(choice) {
            const applied = (choice === 'light') ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', applied);
            document.body.setAttribute('data-theme', applied);
        }

        function persist(choice) {
            const applied = (choice === 'light') ? 'light' : 'dark';
            localStorage.setItem('theme', applied);
            document.cookie = "theme=" + encodeURIComponent(applied)
                + "; path=/; max-age=31536000; samesite=lax";
        }

        const btns = document.querySelectorAll('.consumi-page [data-theme-choice]');
        const initial = currentTheme();
        applyTheme(initial);

        btns.forEach(b => {
            if (b.getAttribute('data-theme-choice') === initial) {
                b.classList.add('active');
            }
            b.addEventListener('click', () => {
                const choice = b.getAttribute('data-theme-choice');
                applyTheme(choice);
                persist(choice);
                btns.forEach(x => x.classList.remove('active'));
                b.classList.add('active');
            });
        });
    })();

    // === Grafico a torta: Disponibile + origini ===
    (function () {
        const canvas = document.getElementById('apiUsagePie');
        if (!canvas) return;

        const originLabels = @Html.Raw(JsonSerializer.Serialize(Model.TodayUsage.Select(x => x.Origin)));
        const originCounters = @Html.Raw(JsonSerializer.Serialize(Model.TodayUsage.Select(x => x.Counter)));
        const dailyCap = @Model.DailyCap;

        if (!originCounters.length || dailyCap === 0) {
            return; // nessun dato → niente grafico
        }

        const usedToday = originCounters.reduce((a, b) => a + b, 0);
        const remaining = Math.max(0, dailyCap - usedToday);

        const labels = ['Disponibile', ...originLabels];
        const data = [remaining, ...originCounters];

        const colors = [
            '#6c757d', // Disponibile
            '#0d6efd', '#6610f2', '#198754', '#dc3545', '#fd7e14',
            '#20c997', '#6f42c1', '#0dcaf0', '#ffc107'
        ];

        Chart.register(ChartDataLabels);

        function getTextColor() {
            const computed = getComputedStyle(document.documentElement);
            const c = computed.getPropertyValue('--text').trim();
            return c || '#ffffff';
        }

        new Chart(canvas, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10,
                            padding: 14,
                            color: getTextColor()
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const val = context.raw || 0;
                                const perc = dailyCap ? (val / dailyCap * 100) : 0;
                                return `${context.label}: ${val} chiamate (${perc.toFixed(2)}% del tetto)`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: function (value) {
                            if (!dailyCap) return '';
                            const perc = value / dailyCap * 100;
                            return perc >= 1 ? perc.toFixed(1) + '%' : '';
                        }
                    }
                }
            }
        });
    })();
</script>
