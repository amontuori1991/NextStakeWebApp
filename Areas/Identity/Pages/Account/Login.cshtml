@page
@model NextStakeWebApp.Areas.Identity.Pages.Account.LoginModel
@{
    ViewData["Title"] = "Accedi";
}

<div id="login-page" class="ns-login-wrapper d-flex align-items-center justify-content-center">
    <div id="snow-container-login"></div>
    <div class="ns-login-card">
        <div class="ns-login-header">
            <img src="~/icons/favicon_grinch.svg" alt="NextStake Logo" class="ns-login-logo" />
            <h1 class="ns-title">NextStake</h1>
            <p class="ns-subtitle">Accedi al tuo account</p>
        </div>

        <form method="post" novalidate>
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="ns-field">
                <label asp-for="Input.Login" class="ns-label">Email o Nome utente</label>
                <input asp-for="Input.Login" autocomplete="username" class="ns-input" />
                <span asp-validation-for="Input.Login" class="text-danger ns-validation"></span>
            </div>

            <div class="ns-field">
                <label asp-for="Input.Password" class="ns-label">Password</label>
                <input asp-for="Input.Password" autocomplete="current-password" class="ns-input" />
                <span asp-validation-for="Input.Password" class="text-danger ns-validation"></span>
            </div>

            <div class="ns-remember">
                <input asp-for="Input.RememberMe" id="rememberCheck" class="ns-checkbox" />
                <label asp-for="Input.RememberMe" for="rememberCheck" class="ns-remember-label">Ricordami</label>
            </div>

            <button type="submit" class="ns-btn">Accedi</button>

            <div class="text-center mt-3">
                <a asp-page="./ForgotPassword" class="d-block mb-2">Hai dimenticato la password?</a>
                <span class="text-light small">
                    Se non sei ancora registrato,
                    <a asp-page="./Register" class="text-decoration-underline text-info fw-semibold">
                        clicca qui
                    </a>
                </span>
            </div>

        </form>

        <!-- Hint PWA / Aggiungi alla Home -->
        <div id="pwa-install-hint" class="ns-pwa-hint d-none">
            <div class="ns-pwa-hint-icon">📱</div>
            <div class="ns-pwa-hint-text" id="pwa-install-text">
                Puoi aggiungere NextStake alla schermata Home e usarlo come un'app.
            </div>
            <button type="button" id="pwa-install-btn">
                Installa
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- ❄ Neve solo sulla pagina di login -->
    <script>
        (function () {
            function initLoginSnow() {
                const SNOW_COUNT = 50;
                const container = document.getElementById('snow-container-login');
                if (!container) return;

                for (let i = 0; i < SNOW_COUNT; i++) {
                    createSnowflake();
                }

                function createSnowflake() {
                    const flake = document.createElement('div');
                    flake.className = 'snowflake-login';
                    flake.textContent = '❄';

                    const size = Math.random() * 12 + 8; // 8px - 20px
                    flake.style.fontSize = size + 'px';

                    flake.style.left = Math.random() * 100 + 'vw';
                    flake.style.animationDuration = (Math.random() * 10 + 10) + 's';
                    flake.style.opacity = Math.random();
                    flake.style.transform = `translateX(${Math.random() * 40 - 20}px)`;

                    container.appendChild(flake);

                    flake.addEventListener('animationend', () => {
                        flake.remove();
                        createSnowflake();
                    });
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLoginSnow);
            } else {
                initLoginSnow();
            }
        })();
    </script>

    <!-- 📱 Banner "Installa app" / Aggiungi alla Home -->
    <script>
        (function () {
            const hint = document.getElementById('pwa-install-hint');
            const btn  = document.getElementById('pwa-install-btn');
            const text = document.getElementById('pwa-install-text');

            if (!hint) return;

            function showBanner(message) {
                if (message && text) text.textContent = message;
                hint.classList.remove('d-none');
            }

            function hideBanner() {
                hint.classList.add('d-none');
            }

            // Già installata come PWA?
            const isStandalone =
                window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true;

            if (isStandalone) {
                // Se è già "app", non mostrare il suggerimento
                return;
            }

            let deferredPrompt = null;

            // Browser che supportano l'evento PWA nativo
            window.addEventListener('beforeinstallprompt', function (e) {
                e.preventDefault();
                deferredPrompt = e;
                showBanner('Puoi installare NextStake come app.');

                if (btn) {
                    btn.onclick = async function () {
                        if (!deferredPrompt) return;

                        deferredPrompt.prompt();
                        const choice = await deferredPrompt.userChoice;
                        deferredPrompt = null;

                        if (choice.outcome === 'accepted') {
                            hideBanner();
                        }
                    };
                }
            });

            // Fallback: se entro 4 secondi non arriva beforeinstallprompt,
            // mostriamo comunque istruzioni manuali
            setTimeout(function () {
                if (deferredPrompt || isStandalone) return;

                const ua = navigator.userAgent || '';
                let helpText = '';

                if (/iPhone|iPad|iPod/i.test(ua)) {
                    helpText = 'Su iOS: apri il menu di condivisione di Safari e tocca "Aggiungi alla schermata Home".';
                } else if (/Android/i.test(ua)) {
                    helpText = 'Su Android: apri il menu ⋮ del browser e scegli "Aggiungi alla schermata Home" o "Installa app".';
                } else {
                    helpText = 'Dal browser desktop puoi usare "Installa app" o aggiungerlo alla barra delle applicazioni.';
                }

                showBanner(helpText);

                if (btn) {
                    // In modalità fallback il bottone chiude solo il banner
                    btn.onclick = function () {
                        hideBanner();
                    };
                }
            }, 4000);
        })();
    </script>
}



@section Styles {
    <style>
        /* ——— Palette ——— */
        :root {
            --ns-bg: #252e40;
            --ns-bg-2: #1a2230;
            --ns-card: rgba(255,255,255,0.06);
            --ns-card-border: rgba(255,255,255,0.18);
            --ns-text: #ffffff;
            --ns-text-dim: rgba(255,255,255,0.75);
            --ns-input-bg: rgba(255,255,255,0.12);
            --ns-input-border: rgba(255,255,255,0.22);
            --ns-accent: #00c3ff;
            --ns-accent-hover: #00a8db;
        }

        /* ——— Reset pagina login e isolamento ——— */
        #login-page,
        #login-page * {
            box-sizing: border-box;
        }

        #login-page {
            min-height: 100vh !important;
            width: 100%;
            padding: 32px 16px !important;
            background: linear-gradient(135deg, var(--ns-bg) 0%, var(--ns-bg-2) 100%) !important;
            font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif !important;
        }
            /* nasconde navbar/header solo qui */
            #login-page .navbar, header.navbar, .topbar, nav.navbar {
                display: none !important;
            }

            /* ——— Card ——— */
            #login-page .ns-login-card {
                max-width: 520px !important; /* più grande */
                width: 100%;
                margin: 0 auto;
                background: var(--ns-card) !important;
                border: 1px solid var(--ns-card-border) !important;
                color: var(--ns-text) !important;
                padding: 32px !important;
                border-radius: 18px !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                opacity: 0;
                transform: translateY(10px);
                animation: ns-fadeUp .6s ease-out forwards;
            }

            /* ——— Header ——— */
            #login-page .ns-login-header {
                text-align: center;
                margin-bottom: 20px;
            }

            #login-page .ns-login-logo {
                width: 300px;
                height: auto;
                display: inline-block;
                padding: 12px;
                border-radius: 20px;
                background: rgba(255,255,255,0.05);
                box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                transition: transform .25s ease, box-shadow .25s ease;
            }

                #login-page .ns-login-logo:hover {
                    transform: scale(1.05);
                    box-shadow: 0 8px 28px rgba(0,0,0,0.45);
                }



            #login-page .ns-title {
                margin: 14px 0 2px;
                font-size: 28px;
                font-weight: 800;
                color: var(--ns-text);
            }

            #login-page .ns-subtitle {
                margin: 0 0 8px;
                font-size: 15px;
                color: var(--ns-text-dim);
            }

            /* ——— Campi ——— */
            #login-page .ns-field {
                margin-bottom: 16px;
            }

            #login-page .ns-label {
                display: block;
                font-size: 14px;
                color: var(--ns-text-dim);
                margin-bottom: 6px;
            }

            #login-page .ns-input {
                width: 100%;
                height: 56px; /* alto */
                border-radius: 10px;
                padding: 14px 14px;
                font-size: 17px;
                color: var(--ns-text);
                background: var(--ns-input-bg);
                border: 1px solid var(--ns-input-border);
                outline: none;
                transition: all .15s ease;
            }

                #login-page .ns-input:focus {
                    border-color: var(--ns-accent) !important;
                    box-shadow: 0 0 0 4px rgba(0,195,255,.23) !important;
                }

            #login-page .ns-validation {
                font-size: 14px;
                margin-top: 6px;
                display: block;
            }

            /* ——— Remember ——— */
            #login-page .ns-remember {
                display: flex;
                align-items: center;
                gap: 10px;
                margin: 4px 0 18px;
            }

            #login-page .ns-checkbox {
                width: 20px;
                height: 20px;
                accent-color: var(--ns-accent);
            }

            #login-page .ns-remember-label {
                color: var(--ns-text-dim);
                font-size: 15px;
            }

            /* ——— Bottone ——— */
            #login-page .ns-btn {
                display: inline-block;
                width: 100%;
                border: none;
                border-radius: 10px;
                padding: 14px 16px;
                font-size: 18px;
                font-weight: 700;
                color: #fff;
                background: var(--ns-accent);
                transition: transform .12s ease, background-color .12s ease, box-shadow .12s ease;
            }

                #login-page .ns-btn:hover {
                    background: var(--ns-accent-hover);
                    transform: translateY(-1px);
                }

                #login-page .ns-btn:active {
                    transform: translateY(0);
                }

            /* ——— Link ——— */
            #login-page .ns-links {
                text-align: center;
                margin-top: 14px;
            }

            #login-page .ns-link {
                color: var(--ns-text-dim);
                font-size: 14px;
                text-decoration: none;
            }

                #login-page .ns-link:hover {
                    text-decoration: underline;
                    color: #ffffff;
                }

        /* ——— Animazione ——— */
        @@keyframes ns-fadeUp {
            to

        {
            opacity: 1;
            transform: translateY(0);
        }

        }

        /* ——— Mobile ——— */
        @@media (max-width: 576px) {
            #login-page

        {
            padding: 18px 12px !important;
        }

        #login-page .ns-login-card {
            padding: 24px !important;
        }

        #login-page .ns-input {
            height: 54px;
            font-size: 16px;
        }

        #login-page .ns-title {
            font-size: 24px;
        }

        }

        #login-page a.text-info {
            color: #00bfff !important;
            transition: color .2s ease;
        }

            #login-page a.text-info:hover {
                color: #66d0ff !important;
            }
        /* --- Neve pagina login --- */
        #snow-container-login {
            pointer-events: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            overflow: hidden;
        }

        .snowflake-login {
            position: absolute;
            top: -10px;
            color: #ffffff;
            font-size: 1rem;
            user-select: none;
            animation: fall-login linear infinite;
            opacity: 0.9;
            filter: drop-shadow(0 0 3px rgba(255,255,255,0.6));
        }

        @@keyframes fall-login {
            to {
                transform: translateY(110vh);
            }
        }
        /* --- Hint PWA / Aggiungi alla Home --- */
        #login-page .ns-pwa-hint {
            margin-top: 20px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(0,0,0,0.35);
            border: 1px dashed rgba(255,255,255,0.35);
            color: var(--ns-text-dim);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #login-page .ns-pwa-hint-icon {
            font-size: 20px;
        }

        #login-page .ns-pwa-hint-text {
            flex: 1;
        }

        #login-page #pwa-install-btn {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            background: var(--ns-accent);
            color: #fff;
            font-weight: 600;
            white-space: nowrap;
        }

            #login-page #pwa-install-btn:hover {
                background: var(--ns-accent-hover);
            }

        @@media (max-width: 576px) {
            #login-page .ns-pwa-hint

        {
            flex-direction: column;
            align-items: flex-start;
        }

        #login-page #pwa-install-btn {
            width: 100%;
            text-align: center;
        }

        }
    </style>
}
