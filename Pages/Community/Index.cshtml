@page
@model NextStakeWebApp.Pages.Community.IndexModel
@{
    ViewData["Title"] = "Community";
}

<div class="container py-4">
    <h3 class="mb-2">🌍 Community</h3>
    <div class="text-muted mb-3">
        Qui trovi le schedine pubblicate dagli utenti.
    </div>

    <form method="get" class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2 align-items-center">
            <label class="form-label m-0">Filtra per autore:</label>

            <select class="form-select" style="max-width:280px" name="UserFilter" onchange="this.form.submit()">
                @foreach (var opt in Model.AuthorOptions)
                {
                    <option value="@opt.Value" selected="@(opt.Value == (Model.UserFilter ?? ""))">
                        @opt.Text
                    </option>
                }
            </select>

            @if (!string.IsNullOrWhiteSpace(Model.UserFilter))
            {
                <a class="btn btn-outline-secondary" asp-page="/Community/Index">Reset</a>
            }
        </div>
    </form>

    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        <div class="alert alert-info">@Model.StatusMessage</div>
    }

    @if (Model.PublicSlips.Count == 0)
    {
        <div class="text-muted">Nessuna schedina pubblicata al momento.</div>
    }
    else
    {
        <div class="accordion" id="communityAccordion">

            @foreach (var s in Model.PublicSlips)
            {
                var collapseId = $"comments_{s.Id}";
                var likeCnt = Model.LikeCounts.TryGetValue(s.Id, out var lc) ? lc : 0;
                var commentCnt = s.Comments?.Count ?? 0;
                var liked = Model.LikedByMe.Contains(s.Id);
                var saved = Model.SavedByMe.Contains(s.Id);

                <div class="card mb-3">

                    <!-- HEADER -->
                    <div class="card-header d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <strong>@(string.IsNullOrWhiteSpace(s.Title) ? $"Schedina #{s.Id}" : s.Title)</strong>
                                <span class="badge bg-secondary">@s.Type</span>
                                <span class="badge bg-success">PUBBLICA</span>

                                @if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Win)
                                {
                                    <span class="badge bg-success">Vincente</span>
                                }
                                else if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Loss)
                                {
                                    <span class="badge bg-danger">Perdente</span>
                                }
                                else if (s.ArchivedAtUtc != null)
                                {
                                    <span class="badge bg-secondary">Archiviata</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Da assegnare</span>
                                }
                            </div>

                            @{
                                Model.AuthorMap.TryGetValue(s.UserId, out var author);
                            }
                            <div class="small text-muted">
                                Pubblicata da <strong>@(author ?? "Utente")</strong>
                            </div>

                            @if (User?.Identity?.IsAuthenticated ?? false)
                            {
                                var isFollowing = Model.FollowedUserIds.Contains(s.UserId);

                                <div class="mt-1">
                                    @if (!isFollowing)
                                    {
                                        <form method="post" asp-page-handler="Follow" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="targetUserId" value="@s.UserId" />
                                            <button class="btn btn-sm btn-outline-success">➕ Segui</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form method="post" asp-page-handler="Unfollow" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="targetUserId" value="@s.UserId" />
                                            <button class="btn btn-sm btn-outline-secondary">✓ Seguito</button>
                                        </form>
                                    }
                                </div>
                            }
                        </div>

                        <div class="text-muted small">
                            @s.UpdatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </div>

                    <!-- BODY -->
                    <div class="card-body">

                        <!-- SELEZIONI -->
                        @if (s.Selections.Count > 0)
                        {
                            <ul class="list-group mb-3">
                                @foreach (var sel in s.Selections.OrderBy(x => x.Id))
                                {
                                    Model.MatchMap.TryGetValue(sel.MatchId, out var mi);

                                    <li class="list-group-item">
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <strong>@(mi?.HomeName ?? "Casa")</strong>
                                            <span class="text-muted">vs</span>
                                            <strong>@(mi?.AwayName ?? "Ospite")</strong>

                                            @if (mi?.StatusShort is "FT" or "AET" or "PEN"
                                                                        && mi.HomeGoal.HasValue && mi.AwayGoal.HasValue)
                                            {
                                                <span class="badge bg-light text-dark ms-2">
                                                    @mi.HomeGoal - @mi.AwayGoal
                                                </span>
                                            }

                                            <span class="ms-2"><strong>Pick:</strong> @sel.Pick</span>
                                            @{
                                                var outcome = BetPickEvaluator.EvaluateSelectionOutcome(
                                                sel,
                                                mi?.StatusShort,
                                                mi?.HomeGoal,
                                                mi?.AwayGoal
                                                );
                                            }

                                            @if (outcome == BetPickEvaluator.SelectionOutcome.Won)
                                            {
                                                <span class="badge bg-success ms-2">✅ Vinta</span>
                                            }
                                            else if (outcome == BetPickEvaluator.SelectionOutcome.Lost)
                                            {
                                                <span class="badge bg-danger ms-2">❌ Persa</span>
                                            }
                                            else if (outcome == BetPickEvaluator.SelectionOutcome.Pending)
                                            {
                                                <span class="badge bg-secondary ms-2">⏳ In corso</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary ms-2">❓ Non valutabile</span>
                                            }

                                            @if (sel.ManualOutcome == 1)
                                            {
                                                <span class="badge bg-success ms-2">✅ Esito manuale: Vinta</span>
                                            }
                                            else if (sel.ManualOutcome == 2)
                                            {
                                                <span class="badge bg-danger ms-2">❌ Esito manuale: Persa</span>
                                            }

                                        </div>
                                    </li>
                                }
                            </ul>
                        }

                        <!-- CONTATORI -->
                        <div class="d-flex justify-content-between small text-muted mb-2">
                            <div>👍 <strong>@likeCnt</strong></div>
                            <div>💬 <strong>@commentCnt</strong> commenti</div>
                        </div>

                        <hr />

                        <!-- AZIONI -->
                        <div class="d-flex justify-content-around mb-2">

                            @* LIKE *@
                            @if (User?.Identity?.IsAuthenticated ?? false)
                            {
                                <form method="post" asp-page-handler="ToggleLike" class="m-0">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="slipId" value="@s.Id" />
                                    <input type="hidden" name="userFilter" value="@Model.UserFilter" />
                                    <button class="btn btn-sm @(liked ? "btn-primary" : "btn-outline-primary")">
                                        👍 Mi piace
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-primary" disabled>👍 Mi piace</button>
                            }

                            @* COMMENTI *@
                            <button class="btn btn-sm btn-outline-secondary"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId">
                                💬 Commenta
                            </button>

                            @* COPIA / RIMUOVI *@
                            @if (User?.Identity?.IsAuthenticated ?? false)
                            {
                                if (!saved)
                                {
                                    <!-- COPIA -->
                                    <form method="post" asp-page-handler="SaveToMySlips" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="slipId" value="@s.Id" />
                                        <input type="hidden" name="userFilter" value="@Model.UserFilter" />
                                        <button class="btn btn-sm btn-outline-success">
                                            📌 Copia
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <!-- RIMUOVI (APRE MODAL) -->
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#unsaveModal_@s.Id">
                                        🗑 Rimuovi
                                    </button>
                                }
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-success" disabled>📌 Copia</button>
                            }

                        </div>
                        @if (saved && (User?.Identity?.IsAuthenticated ?? false))
                        {
                            <div class="modal fade" id="unsaveModal_@s.Id" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <h5 class="modal-title">Rimuovere la schedina?</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>

                                        <div class="modal-body">
                                            <p class="mb-2">
                                                Vuoi rimuovere questa schedina dalle tue?
                                            </p>
                                            <p class="text-muted small mb-0">
                                                👉 Potrai sempre salvarla di nuovo dalla Community.
                                            </p>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn btn-outline-secondary"
                                                    data-bs-dismiss="modal">
                                                Annulla
                                            </button>

                                            <form method="post"
                                                  asp-page-handler="Unsave"
                                                  class="m-0">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="slipId" value="@s.Id" />
                                                <input type="hidden" name="userFilter" value="@Model.UserFilter" />
                                                <button type="submit" class="btn btn-danger">
                                                    🗑 Rimuovi
                                                </button>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        }



                        <!-- COMMENTI COLLASSABILI -->
                        <div id="@collapseId"
                             class="accordion-collapse collapse"
                             data-bs-parent="#communityAccordion">

                            <div class="border rounded p-2 mt-2">

                                @if (commentCnt == 0)
                                {
                                    <div class="text-muted">Ancora nessun commento.</div>
                                }
                                else
                                {
                                    @foreach (var c in s.Comments.OrderByDescending(x => x.CreatedAtUtc))
                                    {
                                        Model.AuthorMap.TryGetValue(c.UserId, out var ca);

                                        <div class="mb-2">
                                            <div class="small text-muted d-flex justify-content-between">
                                                <strong>@(ca ?? "Utente")</strong>
                                                <span>@c.CreatedAtUtc.ToLocalTime().ToString("dd/MM HH:mm")</span>
                                            </div>
                                            <div>@c.Text</div>
                                        </div>
                                    }
                                }

                                @if (User?.Identity?.IsAuthenticated ?? false)
                                {
                                    <form method="post" asp-page-handler="Comment" class="d-flex gap-2 mt-2">
                                        <input type="hidden" name="UserFilter" value="@Model.UserFilter" />

                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="slipId" value="@s.Id" />
                                        <input class="form-control" name="text" placeholder="Scrivi un commento..." />
                                        <button class="btn btn-primary">Invia</button>
                                    </form>
                                }
                            </div>
                        </div>

                    </div>
                </div>
            }

        </div>
    }
</div>
