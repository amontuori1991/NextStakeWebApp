@page
@model NextStakeWebApp.Pages.Events.IndexModel
@using System.Globalization
@{
    // Cultura italiana per nomi dei giorni/mesi
    var it = new CultureInfo("it-IT");

    // Oggi (UTC -> poi ToLocalTime per le ore; qui ci basta il giorno)
    var today = DateOnly.FromDateTime(DateTime.UtcNow);

    // Giorno selezionato (già fornito dal Model)
    var sel = Model.SelectedDate;

    // Nome giorno selezionato con iniziale maiuscola (Domenica, Lunedì, ...)
    var dayName = it.TextInfo.ToTitleCase(sel.ToDateTime(TimeOnly.MinValue).ToString("dddd", it));

    // Calendario: limiti del mese corrente visualizzato (basato su SelectedDate)
    var firstOfMonth = new DateOnly(sel.Year, sel.Month, 1);
    var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);

    // Inizio calendario: lunedì prima o uguale al primo del mese
    var startCal = firstOfMonth;
    while (startCal.DayOfWeek != DayOfWeek.Monday) startCal = startCal.AddDays(-1);

    // Fine calendario: domenica dopo o uguale all'ultimo del mese
    var endCal = lastOfMonth;
    while (endCal.DayOfWeek != DayOfWeek.Sunday) endCal = endCal.AddDays(1);

    // Parametri comuni da preservare nei link
    var common = $"&fav={(Model.OnlyFavorites ? 1 : 0)}&country={Model.SelectedCountryCode}&q={Model.Query}" + (Model.ShowBest ? "&best=1" : "");
}


@{
    ViewData["Title"] = "Eventi";
}

<div class="container py-4">
    <div class="row g-3">
        <!-- SIDEBAR (mini calendario + azioni + filtri) -->
        <aside class="col-12 col-lg-3">
            <!-- Mini calendario in un riquadro compatto -->
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <a class="btn btn-sm btn-outline-secondary"
                       href="/Events?d=@firstOfMonth.AddMonths(-1).ToString("yyyy-MM-dd")@common"
                       aria-label="Mese precedente">←</a>
                    <div class="fw-semibold small text-center">
                        @it.TextInfo.ToTitleCase(firstOfMonth.ToDateTime(TimeOnly.MinValue).ToString("MMMM", it))
                        @firstOfMonth.Year
                    </div>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="/Events?d=@firstOfMonth.AddMonths(1).ToString("yyyy-MM-dd")@common"
                       aria-label="Mese successivo">→</a>
                </div>

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Lun</small>
                        <small class="text-muted">Mar</small>
                        <small class="text-muted">Mer</small>
                        <small class="text-muted">Gio</small>
                        <small class="text-muted">Ven</small>
                        <small class="text-muted">Sab</small>
                        <small class="text-muted">Dom</small>
                    </div>

                    <div class="mini-cal">
                        @{
                            var d = startCal;
                            while (d <= endCal)
                            {
                                <div class="mini-cal-row">
                                    @for (int i = 0; i < 7; i++)
                                    {
                                        var isOutside = d < firstOfMonth || d > lastOfMonth;
                                        var isToday = d == today;
                                        var isSelected = d == sel;

                                        <a class="mini-cal-day @(isOutside ? "cal-outside" : "") @(isToday ? "is-today" : "") @(isSelected ? "is-selected" : "")"
                                           href="/Events?d=@d.ToString("yyyy-MM-dd")@common">
                                            @d.Day
                                        </a>
                                        ;

                                        d = d.AddDays(1);
                                    }
                                </div>
                            }
                        }
                    </div>

                    <div class="d-grid mt-2">
                        <!-- Spostato qui il tasto OGGI -->
                        <a class="btn btn-sm btn-outline-primary"
                           href="/Events?d=@today.ToString("yyyy-MM-dd")@common">Oggi</a>
                    </div>
                </div>
            </div>

            <!-- Azioni globali (Preferiti / Migliori) -->
            <div class="d-grid gap-2 mb-3">
                <a class="btn @(Model.OnlyFavorites ? "btn-warning" : "btn-outline-warning")"
                   href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 0 : 1)&country=@Model.SelectedCountryCode&q=@Model.Query">
                    ⭐ @(Model.OnlyFavorites ? "Mostra tutti" : "Vedi preferiti")
                </a>

                <a class="btn btn-success"
                   href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query&best=1"
                   data-loading="best">
                    Migliori pronostici
                </a>

                @if (Model.ShowBest)
                {
                    <a class="btn btn-outline-secondary"
                       href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query">
                        Nascondi pronostici
                    </a>
                }
            </div>

            <!-- Filtri: Nazione + Ricerca -->
            <form method="get" action="/Events" class="card p-3 mb-3">
                <div class="mb-2">
                    <label class="form-label">Filtro Nazione</label>
                    <select class="form-select form-select-sm" name="country" onchange="this.form.submit()">
                        <option value="">— Mostra tutte —</option>
                        @foreach (var c in Model.AvailableCountries)
                        {
                            <option value="@c.Code" selected="@(Model.SelectedCountryCode == c.Code)">
                                @c.Name (@c.Code)
                            </option>
                        }
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Cerca (squadra o competizione)</label>
                    <input class="form-control form-control-sm" type="text" name="q" value="@Model.Query" placeholder="Es: Serie A, Inter, Premier..." />
                </div>

                <input type="hidden" name="d" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                <input type="hidden" name="fav" value="@(Model.OnlyFavorites ? 1 : 0)" />
                @if (Model.ShowBest)
                {
                    <input type="hidden" name="best" value="1" />
                }

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-sm">Filtra</button>
                </div>
            </form>
        </aside>

        <!-- MAIN -->
        <main class="col-12 col-lg-9">
            <!-- Barra data + frecce (senza OGGI) -->
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="h5 mb-0">
                    @dayName @Model.SelectedDate.ToString("dd/MM/yyyy")
                </div>
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary"
                       href="/Events?d=@Model.SelectedDate.AddDays(-1).ToString("yyyy-MM-dd")@common"
                       aria-label="Giorno precedente">←</a>

                    <a class="btn btn-outline-secondary"
                       href="/Events?d=@Model.SelectedDate.AddDays(1).ToString("yyyy-MM-dd")@common"
                       aria-label="Giorno successivo">→</a>
                </div>
            </div>

            <!-- Sezione: Migliori pronostici (immutata, solo spostata qui) -->
            @if (Model.ShowBest)
            {
                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">🔥 Migliori pronostici</div>
                        <small class="text-muted">Ordinati per data/ora</small>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrWhiteSpace(Model.BestMessage))
                        {
                            <div class="alert alert-info mb-3">@Model.BestMessage</div>
                        }

                        @if (Model.BestPicks?.Count > 0)
                        {
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th style="width:120px;">Data</th>
                                            <th>Evento</th>
                                            <th style="width:120px;">Azione</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var r in Model.BestPicks.OrderBy(x => x.EventDate))
                                        {
                                            Model.AssetsByMatchId.TryGetValue(r.Id, out var assets);

                                            var parts = (r.Match ?? "").Split('-', 2, StringSplitOptions.TrimEntries);
                                            var homeName = parts.Length > 0 ? parts[0] : r.Match;
                                            var awayName = parts.Length > 1 ? parts[1] : "";

                                            <tr>
                                                <td>@r.EventDate.ToLocalTime().ToString("dd/MM HH:mm")</td>
                                                <td>
                                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                                        <div class="d-flex align-items-center gap-1">
                                                            @if (!string.IsNullOrWhiteSpace(assets?.HomeLogo))
                                                            {
                                                                <img src="@assets.HomeLogo" alt="home" style="height:18px;width:auto;" />
                                                            }
                                                            <span class="fw-semibold">@homeName</span>
                                                        </div>
                                                        <span class="mx-1">—</span>
                                                        <div class="d-flex align-items-center gap-1">
                                                            @if (!string.IsNullOrWhiteSpace(assets?.AwayLogo))
                                                            {
                                                                <img src="@assets.AwayLogo" alt="away" style="height:18px;width:auto;" />
                                                            }
                                                            <span class="fw-semibold">@awayName</span>
                                                        </div>
                                                        <small class="text-muted ms-2" style="white-space:nowrap;">
                                                            (
                                                            @if (!string.IsNullOrWhiteSpace(assets?.LeagueFlag))
                                                            {
                                                                <img src="@assets.LeagueFlag" alt="flag" style="height:14px;width:auto;vertical-align:middle;margin-right:4px;" />
                                                            }
                                                            @r.Competition
                                                            @if (!string.IsNullOrWhiteSpace(assets?.LeagueLogo))
                                                            {
                                                                <img src="@assets.LeagueLogo" alt="league" style="height:16px;width:auto;vertical-align:middle;margin-left:6px;" />
                                                            }
                                                            )
                                                        </small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <a href="/Match/Details?id=@r.Id"
                                                       target="_blank" rel="noopener"
                                                       class="btn btn-sm btn-outline-primary">
                                                        Apri evento ↗
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-secondary mb-0">Nessun pronostico disponibile al momento.</div>
                        }
                    </div>
                </div>
            }

            <!-- Lista partite raggruppate per competizione (immutata) -->
            @if (Model.Rows.Count == 0)
            {
                <p>Nessuna partita trovata per il giorno selezionato.</p>
            }
            else
            {
                @foreach (var group in Model.Rows.GroupBy(r => new { r.LeagueId, r.LeagueName, r.LeagueLogo, r.CountryName, r.LeagueFlag }))
                {
                    var groupId = $"lg-{group.Key.LeagueId}";

                    <div class="mb-3 border rounded">
                        <button class="w-100 text-start d-flex align-items-center justify-content-between league-toggle-btn border-0"
                                type="button" data-bs-toggle="collapse" data-bs-target="#@groupId"
                                aria-expanded="true" aria-controls="@groupId">
                            <div class="d-flex align-items-center gap-2 py-2 px-3">
                                <span class="toggle-caret">▾</span>

                                @if (!string.IsNullOrWhiteSpace(group.Key.LeagueLogo))
                                {
                                    <img src="@group.Key.LeagueLogo" alt="league-logo" style="height:18px;width:auto;" />
                                }

                                <span class="fw-semibold">@group.Key.LeagueName</span>

                                @if (!string.IsNullOrWhiteSpace(group.Key.CountryName) || !string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                {
                                    <small class="text-muted d-flex align-items-center ms-2" style="gap:.35rem;">
                                        ( @group.Key.CountryName
                                        @if (!string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                        {
                                            <img src="@group.Key.LeagueFlag" alt="flag" style="height:14px;width:auto;vertical-align:middle;" />
                                        }
                                        )
                                    </small>
                                }

                                <small class="text-muted ms-2">#@group.Key.LeagueId</small>
                            </div>
                        </button>

                        <div id="@groupId" class="collapse show">
                            <div class="list-group list-group-flush">
                                @foreach (var r in group)
                                {
                                    <div class="list-group-item">
                                        <div class="match-item">
                                            @{
                                                var matchEnded = (r.StatusShort == "FT" || r.StatusShort == "AET" || r.StatusShort == "PEN");
                                                var homeScoreStr = matchEnded && r.HomeGoal.HasValue ? r.HomeGoal.Value.ToString() : "–";
                                                var awayScoreStr = matchEnded && r.AwayGoal.HasValue ? r.AwayGoal.Value.ToString() : "–";
                                                var ko = r.KickoffUtc.ToLocalTime().ToString("HH:mm");
                                            }

                                            <!-- COLONNA SINISTRA: contenuto cliccabile -->
                                            <a href="/Match/Details?id=@r.MatchId" class="match-grid">
                                                <!-- RIGA 1 -->
                                                <div class="team home">
                                                    @if (!string.IsNullOrWhiteSpace(r.HomeLogo))
                                                    {
                                                        <img src="@r.HomeLogo" alt="home" class="team-logo" />
                                                    }
                                                    <span class="team-name">@r.Home</span>
                                                </div>

                                                <div class="center">
                                                    <span class="vs-pill">vs</span>
                                                    <small class="text-muted mt-1">Ora: @ko</small>
                                                    <small class="live-minute d-none" data-fixture="@r.MatchId"></small>
                                                </div>
                                                <div class="team away">
                                                    <span class="team-name">@r.Away</span>
                                                    @if (!string.IsNullOrWhiteSpace(r.AwayLogo))
                                                    {
                                                        <img src="@r.AwayLogo" alt="away" class="team-logo" />
                                                    }
                                                </div>

                                                <!-- RIGA 2 (risultato sotto le rispettive squadre) -->
                                                <div class="home-score" data-fixture="@r.MatchId" data-side="home">@homeScoreStr</div>
                                                <div class="score-sep">:</div>
                                                <div class="away-score" data-fixture="@r.MatchId" data-side="away">@awayScoreStr</div>
                                            </a>

                                            <!-- COLONNA DESTRA: preferito -->
                                            <form method="post"
                                                  action="/Events?handler=ToggleFavorite&matchId=@r.MatchId&d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites?1:0)&country=@Model.SelectedCountryCode&q=@Model.Query@(Model.ShowBest ? "&best=1" : "")"
                                                  class="fav-form">
                                                @Html.AntiForgeryToken()
                                                <button type="submit"
                                                        class="btn btn-sm @(Model.FavoriteMatchIds.Contains(r.MatchId) ? "btn-warning" : "btn-outline-secondary")"
                                                        title="Aggiungi/rimuovi dai preferiti">
                                                    ⭐
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </main>
    </div>
</div>


<style>
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(2px);
    }

    .loading-panel {
        background: #fff;
        border-radius: .75rem;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: .75rem;
        max-width: 90vw;
    }
</style>

<div id="loadingOverlay" class="loading-overlay d-none" aria-hidden="true">
    <div class="loading-panel">
        <div class="spinner-border" role="status" aria-label="Caricamento"></div>
        <div id="loadingMessage" class="fw-semibold">Caricamento…</div>
    </div>
</div>


<script>
    (function () {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMessage');

      function showOverlay(message) {
        if (msgEl && message) msgEl.textContent = message;
        if (overlay) overlay.classList.remove('d-none');
      }

      document.addEventListener('click', function (e) {
        // Click su "Migliori pronostici"
        const bestBtn = e.target.closest('a[data-loading="best"]');
        if (bestBtn) {
          showOverlay('Caricamento migliori pronostici…');
          return;
        }

        // Click su un evento (card match)
        const matchLink = e.target.closest('a.match-grid');
        if (matchLink) {
          showOverlay('Caricamento match in corso…');
          return;
        }

        // Opzionale: link con messaggio personalizzato
        const generic = e.target.closest('a[data-loading-message]');
        if (generic) {
          showOverlay(generic.getAttribute('data-loading-message') || 'Caricamento…');
        }
      });

      // Se la pagina torna dal bfcache, nascondi l’overlay
      window.addEventListener('pageshow', () => {
        if (overlay) overlay.classList.add('d-none');
      });
    })();
</script>


<style>
    .league-toggle-btn {
        background-color: #f7f7f7;
        transition: background-color .2s ease;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        width: 100%;
    }

        .league-toggle-btn:hover {
            background-color: #e9ecef;
        }

    .toggle-caret {
        transition: transform .2s ease;
        display: inline-block;
        font-size: 1.1rem;
    }

    [data-bs-toggle="collapse"][aria-expanded="false"] .toggle-caret {
        transform: rotate(-90deg);
    }

    .list-group-item {
        border-left: none;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
</style>
<style>
    /* Mini calendario compatto in sidebar */
    .mini-cal {
        display: grid;
        gap: .25rem;
    }

    .mini-cal-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: .25rem;
    }

    .mini-cal-day {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: .375rem;
        padding: .35rem 0;
        font-size: .9rem;
        line-height: 1;
        min-height: 2rem;
        background: #fff;
    }

        .mini-cal-day:hover {
            background: #f6f6f6;
            text-decoration: none;
        }

    .cal-outside {
        opacity: .45;
    }

    .is-today {
        outline: 2px solid rgba(13,110,253,.4);
        outline-offset: -2px;
    }

    .is-selected {
        background: #0d6efd;
        color: #fff;
    }

    /* Pulsanti toggle gruppi leghe (già presenti, solo ordine) */
    .league-toggle-btn {
        background-color: #f7f7f7;
        transition: background-color .2s ease;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        width: 100%;
    }

        .league-toggle-btn:hover {
            background-color: #e9ecef;
        }

    .toggle-caret {
        transition: transform .2s ease;
        display: inline-block;
        font-size: 1.1rem;
    }

    [data-bs-toggle="collapse"][aria-expanded="false"] .toggle-caret {
        transform: rotate(-90deg);
    }

    .list-group-item {
        border-left: none;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }

    /* Contenitore riga match: 2 colonne -> contenuto | stella */
    .match-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: .75rem;
    }

    /* Area cliccabile: grid 3 colonne -> home | centro | away; 2 righe (nomi / punteggi) */
    .match-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        grid-template-rows: auto auto;
        column-gap: .5rem;
        row-gap: .25rem;
        text-decoration: none;
        color: inherit;
    }

        .match-grid:hover {
            text-decoration: none;
        }

    /* RIGA 1 (nomi/loghi + centro) */
    .team {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        min-width: 0;
    }

        .team.home {
            justify-self: end;
            flex-direction: row;
        }
        /* logo → testo */
        .team.away {
            justify-self: start;
            flex-direction: row;
        }
    /* testo → logo */

    .team-logo {
        height: 18px;
        width: auto;
    }

    .team-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .center {
        justify-self: center;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* RIGA 2 (punteggio allineato sotto le squadre) */
    .home-score {
        grid-column: 1;
        justify-self: end;
        font-weight: 600;
    }

    .score-sep {
        grid-column: 2;
        justify-self: center;
    }

    .live-minute {
        font-weight: 600;
        line-height: 1;
    }

    .away-score {
        grid-column: 3;
        justify-self: start;
        font-weight: 600;
    }

    /* Pill "vs" */
    .vs-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: .1rem .4rem;
        border: 1px solid rgba(0,0,0,.12);
        border-radius: .375rem;
        font-size: .75rem;
        line-height: 1;
        text-transform: uppercase;
    }

    /* Colonna destra (stella) */
    .fav-form {
        justify-self: end;
    }

    /* opzionale: marker live senza alterare il layout */
    .is-live::after {
        content: ' •';
    }

    :root {
        --live-color: #dc3545; /* rosso Bootstrap-ish */
        --live-color-soft: #ff6b6b; /* variante più chiara per l'alternanza */
    }

    /* Animazione colore/leggera opacità (non sparisce mai) */
    @@keyframes livePulse {
        0%

    {
        color: var(--live-color);
        opacity: 0.95;
    }

    100% {
        color: var(--live-color-soft);
        opacity: 1;
    }

    }

    /* Puntino che “respira” */
    @@keyframes blinkDot {
        0%

    {
        opacity: .55;
    }

    100% {
        opacity: 1;
    }

    }

    /* Applica a punteggi live */
    .is-live {
        color: var(--live-color);
        animation: livePulse 1.1s ease-in-out infinite alternate;
    }

    /* Badge minutaggio live */
    .live-minute.is-live {
        color: var(--live-color);
        font-weight: 700;
        animation: livePulse .9s ease-in-out infinite alternate;
    }

    /* Se vuoi mantenere il • sui punteggi live, animiamolo leggermente */
    .is-live::after {
        content: ' •';
        animation: blinkDot 1s ease-in-out infinite alternate;
    }

    /* Accessibilità: se l’utente preferisce meno animazioni, disattivale */
    @@media (prefers-reduced-motion: reduce) {
        .is-live, .live-minute.is-live

    {
        animation: none !important;
    }

    }
</style>

@section Scripts {
    <script>
        // Polling live scores (20s) via proxy backend /api/livescores
        (function () {
          const scoreNodes = document.querySelectorAll('[data-fixture][data-side]');
          const ids = [...new Set([...scoreNodes].map(n => n.getAttribute('data-fixture')).filter(Boolean))];
          if (!ids.length) return;

          const chunk = (arr, size) => arr.length ? [arr.slice(0, size), ...chunk(arr.slice(size), size)] : [];
          const batches = chunk(ids, 20); // prudente: 20 id per chiamata

        async function tick() {
          try {
            const liveStatuses = ['1H','2H','ET','P','BT','LIVE','HT'];

            for (const b of batches) {
              const qs = encodeURIComponent(b.join(','));
              const res = await fetch(`/api/livescores?ids=${qs}`, { cache: 'no-store' });
              if (!res.ok) continue;

              const data = await res.json();

              for (const it of data) {
                const id = String(it.id);
                const homeEl   = document.querySelector(`.home-score[data-fixture="${id}"]`);
                const awayEl   = document.querySelector(`.away-score[data-fixture="${id}"]`);
                const minuteEl = document.querySelector(`.live-minute[data-fixture="${id}"]`);

                // Punteggi
                if (homeEl) homeEl.textContent = (it.home ?? '–');
                if (awayEl) awayEl.textContent = (it.away ?? '–');

                // Live?
                const isLive = it.status && liveStatuses.includes(it.status);

                // Minuto (solo live)
                if (minuteEl) {
                  if (isLive) {
                    let label = '';
                    if (typeof it.elapsed === 'number' && it.elapsed >= 0) {
                      label = `${it.elapsed}'`;
                    } else if (it.status === 'HT') {
                      label = 'HT';
                    }
                    if (label) {
                      minuteEl.textContent = label;
                      minuteEl.classList.remove('d-none');
                    } else {
                      minuteEl.classList.add('d-none');
                    }
                    minuteEl.classList.add('is-live');
                  } else {
                    minuteEl.classList.add('d-none');
                    minuteEl.classList.remove('is-live');
                  }
                }

                // Evidenzia punteggi live in rosso + pulsazione
                const apply = el => {
                  if (!el) return;
                  if (isLive) el.classList.add('is-live');
                  else el.classList.remove('is-live');
                };
                apply(homeEl);
                apply(awayEl);
              }
            }
          } catch (_) { /* no-op */ }
        }

        


          let h = null;
          function start() { tick(); h = setInterval(tick, 20000); }
          function stop()  { if (h) clearInterval(h); h = null; }

          document.addEventListener('visibilitychange', () => document.hidden ? stop() : start());
          start();
        })();
    </script>
}
