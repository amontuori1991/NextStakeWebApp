@page
@{
    Layout = "/Pages/Shared/_Layout.cshtml";
}

@model NextStakeWebApp.Pages.Events.IndexModel
@functions {
    string FormatScore(int? goals, string? statusShort)
    {
        // Partita non iniziata → trattino
        if (statusShort == "NS" || statusShort == "PST")
            return "-";

        // Se il provider non ha ancora scritto 0 a DB, ma la gara è live/finita, mostra 0
        if (!goals.HasValue)
            return "0";

        // Valore presente (0,1,2,...) → stampalo
        return goals.Value.ToString();
    }
}

@using System.Globalization
@using System.Runtime.InteropServices
@{
    var it = new CultureInfo("it-IT");

    // Oggi: basta il giorno
    var today = DateOnly.FromDateTime(DateTime.Now);

    var sel = Model.SelectedDate;
    var dayName = it.TextInfo.ToTitleCase(sel.ToDateTime(TimeOnly.MinValue).ToString("dddd", it));

    var firstOfMonth = new DateOnly(sel.Year, sel.Month, 1);
    var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);

    var startCal = firstOfMonth;
    while (startCal.DayOfWeek != DayOfWeek.Monday) startCal = startCal.AddDays(-1);

    var endCal = lastOfMonth;
    while (endCal.DayOfWeek != DayOfWeek.Sunday) endCal = endCal.AddDays(1);

    var common = $"&fav={(Model.OnlyFavorites ? 1 : 0)}&country={Model.SelectedCountryCode}&q={Model.Query}" + (Model.ShowBest ? "&best=1" : "");
}

@{
    ViewData["Title"] = "Eventi";
}
<div class="events-page">
    <div class="container py-4">

        <div class="row g-3">
            <!-- SIDEBAR -->
            <aside class="col-12 col-lg-3">
                <div class="card mb-3">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <a class="btn btn-sm btn-outline-secondary"
                           href="/Events?d=@firstOfMonth.AddMonths(-1).ToString("yyyy-MM-dd")@common"
                           aria-label="Mese precedente">←</a>
                        <div class="fw-semibold small text-center">
                            @it.TextInfo.ToTitleCase(firstOfMonth.ToDateTime(TimeOnly.MinValue).ToString("MMMM", it)) @firstOfMonth.Year
                        </div>
                        <a class="btn btn-sm btn-outline-secondary"
                           href="/Events?d=@firstOfMonth.AddMonths(1).ToString("yyyy-MM-dd")@common"
                           aria-label="Mese successivo">→</a>
                    </div>

                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Lun</small>
                            <small class="text-muted">Mar</small>
                            <small class="text-muted">Mer</small>
                            <small class="text-muted">Gio</small>
                            <small class="text-muted">Ven</small>
                            <small class="text-muted">Sab</small>
                            <small class="text-muted">Dom</small>
                        </div>

                        <div class="mini-cal">
                            @{
                                var d = startCal;
                                while (d <= endCal)
                                {
                                    <div class="mini-cal-row">
                                        @for (int i = 0; i < 7; i++)
                                        {
                                            var isOutside = d < firstOfMonth || d > lastOfMonth;
                                            var isToday = d == today;
                                            var isSelected = d == sel;

                                            <a class="mini-cal-day @(isOutside ? "cal-outside" : "") @(isToday ? "is-today" : "") @(isSelected ? "is-selected" : "")"
                                               href="/Events?d=@d.ToString("yyyy-MM-dd")@common">
                                                @d.Day
                                            </a>
                                            ;
                                            d = d.AddDays(1);
                                        }
                                    </div>
                                }
                            }
                        </div>

                        <div class="d-grid mt-2">
                            <a class="btn btn-sm btn-outline-primary"
                               href="/Events?d=@today.ToString("yyyy-MM-dd")@common">Oggi</a>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-3">
                    <a class="btn @(Model.OnlyFavorites ? "btn-warning" : "btn-outline-warning")"
                       href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 0 : 1)&country=@Model.SelectedCountryCode&q=@Model.Query">
                        ⭐ @(Model.OnlyFavorites ? "Mostra tutti" : "Vedi preferiti")
                    </a>

                    <a class="btn btn-success"
                       href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query&best=1"
                       data-loading="best">
                        Migliori pronostici
                    </a>

                    @if (Model.ShowBest)
                    {
                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query">
                            Nascondi pronostici
                        </a>
                    }
                </div>
                <div class="card p-3 mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <label class="form-label fw-semibold mb-0">Tema interfaccia</label>
                        <small class="text-muted">salvato per i prossimi accessi</small>
                    </div>

                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-theme-choice="light">Light</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-theme-choice="dark">Dark</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-theme-choice="system">Sistema</button>
                    </div>
                </div>
                <div class="card p-3 mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="form-label fw-semibold mb-0">Notifiche match preferiti</span>
                        <button type="button"
                                id="btn-push-toggle"
                                class="btn btn-sm btn-outline-primary">
                            Attiva notifiche
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Ricevi una notifica su inizio/fine e gol dei match che hai messo tra i preferiti.
                    </small>
                    <div id="push-status" class="small text-muted mt-1"></div>
                </div>

                <form method="get" action="/Events" class="card p-3 mb-3">
                    <div class="mb-2">
                        <label class="form-label">Filtro Nazione</label>
                        <select class="form-select form-select-sm" name="country" onchange="this.form.submit()">
                            <option value="">— Mostra tutte —</option>
                            @foreach (var c in Model.AvailableCountries)
                            {
                                <option value="@c.Code" selected="@(Model.SelectedCountryCode == c.Code)">
                                    @c.Name (@c.Code)
                                </option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Cerca (squadra o competizione)</label>
                        <input class="form-control form-control-sm" type="text" name="q" value="@Model.Query" placeholder="Es: Serie A, Inter, Premier..." />
                    </div>

                    <input type="hidden" name="d" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="fav" value="@(Model.OnlyFavorites ? 1 : 0)" />
                    @if (Model.ShowBest)
                    {
                        <input type="hidden" name="best" value="1" />
                    }

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-sm">Filtra</button>
                    </div>
                </form>
            </aside>

            <!-- MAIN -->
            <main class="col-12 col-lg-9">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="h5 mb-0">
                        @dayName @Model.SelectedDate.ToString("dd/MM/yyyy")
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <button id="btn-live-filter"
                                type="button"
                                class="btn btn-sm btn-outline-danger fw-bold">
                            🔴 LIVE
                        </button>

                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.AddDays(-1).ToString("yyyy-MM-dd")@common">←</a>
                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.AddDays(1).ToString("yyyy-MM-dd")@common">→</a>
                    </div>
                </div>



                @if (Model.ShowBest)
                {
                    <div class="card mb-4 best-picks">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div class="fw-semibold">🔥 Migliori pronostici</div>
                            <small class="text-muted">Ordinati per data/ora</small>
                        </div>
                        <div class="card-body">
                            @* Messaggio diagnostico (se impostato dal backend) *@
                            @if (!string.IsNullOrWhiteSpace(Model.BestMessage))
                            {
                                <div class="alert alert-info mb-3">@Model.BestMessage</div>
                            }

                            @{
                                var bestItems = (Model.BestPicks ?? new List<NextStakeWebApp.Models.BestPickRow>())
                                .OrderBy(x => x.EventDate)
                                .Select(r =>
                                {
                                    Model.AssetsByMatchId.TryGetValue(r.Id, out var a);

                                    // Competition del tipo "NL - Eredivisie" -> split in CountryCode/LeagueName
                                    var comp = r.Competition ?? "";
                                    var split = comp.Split(" - ", 2, StringSplitOptions.TrimEntries);
                                    var countryCode = split.Length > 0 ? split[0] : "";
                                    var leagueName = split.Length > 1 ? split[1] : comp;

                                    return new
                                    {
                                        R = r,
                                        A = a,
                                        Country = countryCode,
                                        League = leagueName,
                                        Flag = a?.LeagueFlag,
                                        Logo = a?.LeagueLogo
                                    };
                                })
                                .ToList();

                                var gi = 0;
                            }

                            @if (bestItems.Count == 0)
                            {
                                <div class="alert alert-secondary mb-0">Nessun pronostico disponibile al momento.</div>
                            }
                            else
                            {
                                @foreach (var grp in bestItems.GroupBy(x => new { x.Country, x.League, x.Flag, x.Logo }))
                                {
                                    var gid = $"bestgrp-{++gi}";

                                    <div class="mb-3 border rounded">
                                        <button class="w-100 text-start league-toggle-btn border-0"
                                                type="button" data-bs-toggle="collapse" data-bs-target="#@gid"
                                                aria-expanded="true" aria-controls="@gid">
                                            <div class="d-flex align-items-center justify-content-between py-2 px-3">
                                                <!-- Sinistra: caret + logo + nome competizione -->
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="toggle-caret">▾</span>

                                                    @if (!string.IsNullOrWhiteSpace(grp.Key.Logo))
                                                    {
                                                        <img src="@grp.Key.Logo" alt="league-logo" style="height:18px;width:auto;" />
                                                    }

                                                    <span class="fw-semibold">@grp.Key.League</span>
                                                </div>

                                                <!-- Destra: Country + bandiera (senza parentesi) -->
                                                @if (!string.IsNullOrWhiteSpace(grp.Key.Country) || !string.IsNullOrWhiteSpace(grp.Key.Flag))
                                                {
                                                    <div class="d-flex align-items-center gap-1 text-muted">
                                                        @if (!string.IsNullOrWhiteSpace(grp.Key.Country))
                                                        {
                                                            <span>@grp.Key.Country</span>
                                                        }

                                                        @if (!string.IsNullOrWhiteSpace(grp.Key.Flag))
                                                        {
                                                            <img src="@grp.Key.Flag"
                                                                 alt="flag"
                                                                 style="height:14px;width:auto;vertical-align:middle;" />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </button>


                                        <div id="@gid" class="collapse show">
                                            <div class="list-group list-group-flush">
                                                @foreach (var bp in grp)
                                                {
                                                    // Nomi squadre dal campo "Match" tipo "Home - Away"
                                                    var parts = (bp.R.Match ?? "").Split(" - ", 2, StringSplitOptions.TrimEntries);
                                                    var homeName = parts.Length > 0 ? parts[0] : bp.R.Match;
                                                    var awayName = parts.Length > 1 ? parts[1] : "";

                                                    var ko = bp.R.EventDate.ToString("dd/MM HH:mm"); // mostrato come orario locale macchina/app

                                                    <div class="list-group-item">
                                                        <div class="match-item">

                                                            <a href="/Match/Details?id=@bp.R.Id" class="match-grid">
                                                                <div class="team home">
                                                                    @if (!string.IsNullOrWhiteSpace(bp.A?.HomeLogo))
                                                                    {
                                                                        <span class="team-logo-box">
                                                                            <img src="@bp.A.HomeLogo" alt="home" class="team-logo" />
                                                                        </span>
                                                                    }
                                                                    <span class="team-name">@homeName</span>
                                                                </div>


                                                                <div class="center">
                                                                    <span class="vs-pill">vs</span>
                                                                    <small class="text-muted mt-1">@ko</small>
                                                                </div>

                                                                <div class="team away">
                                                                    <span class="team-name">@awayName</span>
                                                                    @if (!string.IsNullOrWhiteSpace(bp.A?.AwayLogo))
                                                                    {
                                                                        <span class="team-logo-box">
                                                                            <img src="@bp.A.AwayLogo" alt="away" class="team-logo" />
                                                                        </span>
                                                                    }
                                                                </div>


                                                                <div class="home-score">–</div>
                                                                <div class="score-sep">:</div>
                                                                <div class="away-score">–</div>
                                                            </a>


                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }


                @if (Model.Rows.Count == 0)
                {
                    <p>Nessuna partita trovata per il giorno selezionato.</p>
                }
                else
                {
                    @foreach (var group in Model.Rows.GroupBy(r => new { r.LeagueId, r.LeagueName, r.LeagueLogo, r.CountryName, r.LeagueFlag }))
                    {
                        var groupId = $"lg-{group.Key.LeagueId}";

                        <div class="mb-3 border rounded">
                            <button class="w-100 text-start league-toggle-btn border-0"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#@groupId"
                                    aria-expanded="true" aria-controls="@groupId">
                                <div class="d-flex align-items-center justify-content-between py-2 px-3">
                                    <!-- Sinistra: caret + logo + nome lega -->
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="toggle-caret">▾</span>

                                        @if (!string.IsNullOrWhiteSpace(group.Key.LeagueLogo))
                                        {
                                            <img src="@group.Key.LeagueLogo" alt="league-logo" style="height:18px;width:auto;" />
                                        }

                                        <span class="fw-semibold">@group.Key.LeagueName</span>
                                    </div>

                                    <!-- Destra: Country + bandiera (senza parentesi, senza #id) -->
                                    @if (!string.IsNullOrWhiteSpace(group.Key.CountryName) || !string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                    {
                                        <div class="d-flex align-items-center gap-1 text-muted">
                                            @if (!string.IsNullOrWhiteSpace(group.Key.CountryName))
                                            {
                                                <span>@group.Key.CountryName</span>
                                            }

                                            @if (!string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                            {
                                                <img src="@group.Key.LeagueFlag"
                                                     alt="flag"
                                                     style="height:14px;width:auto;vertical-align:middle;" />
                                            }
                                        </div>
                                    }
                                </div>
                            </button>


                            <div id="@groupId" class="collapse show">
                                <div class="list-group list-group-flush">
                                    @foreach (var r in group)
                                    {
                                        var isLive =
                                        r.StatusShort == "1H"
                                        || r.StatusShort == "2H"
                                        || r.StatusShort == "ET"
                                        || r.StatusShort == "P"
                                        || r.StatusShort == "BT"
                                        || r.StatusShort == "HT"
                                        || r.StatusShort == "LIVE";

                                        var isFav = Model.FavoriteMatchIds.Contains(r.MatchId);

                                        <div class="list-group-item"
                                             data-live="@(isLive ? "1" : "0")"
                                             data-fixture-root="@r.MatchId"
                                             data-fav="@(isFav ? "1" : "0")">
                                            <div class="match-item">
                                                @{
                                                    var homeScoreStr = FormatScore(r.HomeGoal, r.StatusShort);
                                                    var awayScoreStr = FormatScore(r.AwayGoal, r.StatusShort);
                                                    var ko = r.KickoffLocal.ToString("HH:mm");
                                                }

                                                <a href="/Match/Details?id=@r.MatchId" class="match-grid">
                                                    <div class="team home">
                                                        @if (!string.IsNullOrWhiteSpace(r.HomeLogo))
                                                        {
                                                            <span class="team-logo-box">
                                                                <img src="@r.HomeLogo" alt="home" class="team-logo" />
                                                            </span>
                                                        }
                                                        <span class="team-name">@r.Home</span>
                                                    </div>

                                                    <div class="center">
                                                        <span class="vs-pill">vs</span>
                                                        <small class="text-muted mt-1">Ora: @ko</small>
                                                        <small class="live-minute d-none" data-fixture="@r.MatchId"></small>
                                                    </div>

                                                    <div class="team away">
                                                        <span class="team-name">@r.Away</span>
                                                        @if (!string.IsNullOrWhiteSpace(r.AwayLogo))
                                                        {
                                                            <span class="team-logo-box">
                                                                <img src="@r.AwayLogo" alt="away" class="team-logo" />
                                                            </span>
                                                        }
                                                    </div>

                                                    <div class="home-score" data-fixture="@r.MatchId" data-side="home">@homeScoreStr</div>
                                                    <div class="score-sep">:</div>
                                                    <div class="away-score" data-fixture="@r.MatchId" data-side="away">@awayScoreStr</div>
                                                </a>

                                                <form method="post"
                                                      action="/Events?handler=ToggleFavorite&matchId=@r.MatchId&d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites?1:0)&country=@Model.SelectedCountryCode&q=@Model.Query@(Model.ShowBest ? "&best=1" : "")"
                                                      class="fav-form">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit"
                                                            class="btn btn-sm @(isFav ? "btn-warning" : "btn-outline-secondary")"
                                                            title="Aggiungi/rimuovi dai preferiti">
                                                        ⭐
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    }


                                </div>
                            </div>
                        </div>
                    }
                }
            </main>
        </div>
    </div>
</div>

<style>
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10,14,20,0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        backdrop-filter: blur(2px);
    }

    .loading-panel {
        background: rgba(20,26,36,0.92);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: .75rem;
        box-shadow: 0 12px 36px rgba(0,0,0,.35);
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: .75rem;
        max-width: 90vw;
    }

        .loading-panel .spinner-border {
            color: #fff;
        }
</style>

<div id="loadingOverlay" class="loading-overlay d-none" aria-hidden="true">
    <div class="loading-panel video-only">
        <video src="/videos/loading.mp4"
               class="loading-video"
               autoplay
               muted
               loop
               playsinline></video>
    </div>
</div>


<script>
    (function () {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMessage');

      function showOverlay(message) {
        if (msgEl && message) msgEl.textContent = message;
        if (overlay) overlay.classList.remove('d-none');
      }

      document.addEventListener('click', function (e) {
        const bestBtn = e.target.closest('a[data-loading="best"]');
        if (bestBtn) { showOverlay('Caricamento migliori pronostici…'); return; }

        const matchLink = e.target.closest('a.match-grid');
        if (matchLink) { showOverlay('Caricamento match in corso…'); return; }

        const generic = e.target.closest('a[data-loading-message]');
        if (generic) { showOverlay(generic.getAttribute('data-loading-message') || 'Caricamento…'); }
      });

      window.addEventListener('pageshow', () => { if (overlay) overlay.classList.add('d-none'); });
    })();
</script>

<style>
    .league-toggle-btn {
        background-color: #f7f7f7;
        transition: background-color .2s ease;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        width: 100%;
    }

        .league-toggle-btn:hover {
            background-color: #e9ecef;
        }

    .toggle-caret {
        transition: transform .2s ease;
        display: inline-block;
        font-size: 1.1rem;
    }

    [data-bs-toggle="collapse"][aria-expanded="false"] .toggle-caret {
        transform: rotate(-90deg);
    }

    .list-group-item {
        border-left: none;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
</style>

<style>
    .mini-cal {
        display: grid;
        gap: .25rem;
    }

    .mini-cal-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: .25rem;
    }

    .mini-cal-day {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: .375rem;
        padding: .35rem 0;
        font-size: .9rem;
        line-height: 1;
        min-height: 2rem;
        background: #fff;
    }

        .mini-cal-day:hover {
            background: #f6f6f6;
            text-decoration: none;
        }

    .cal-outside {
        opacity: .45;
    }

    .is-today {
        outline: 2px solid rgba(13,110,253,.4);
        outline-offset: -2px;
    }

    .is-selected {
        background: #0d6efd;
        color: #fff;
    }

    .match-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: .75rem;
    }

    .match-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        grid-template-rows: auto auto;
        column-gap: .5rem;
        row-gap: .25rem;
        text-decoration: none;
        color: inherit;
    }

        .match-grid:hover {
            text-decoration: none;
        }

    .team {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        min-width: 0;
    }

        .team.home {
            justify-self: end;
            flex-direction: row;
        }

        .team.away {
            justify-self: start;
            flex-direction: row;
        }

    .team-logo {
        height: 18px;
        width: auto;
    }

    .team-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .center {
        justify-self: center;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .home-score {
        grid-column: 1;
        justify-self: end;
        font-weight: 600;
    }

    .score-sep {
        grid-column: 2;
        justify-self: center;
    }

    .live-minute {
        font-weight: 600;
        line-height: 1;
    }

    .away-score {
        grid-column: 3;
        justify-self: start;
        font-weight: 600;
    }

    .vs-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: .1rem .4rem;
        border: 1px solid rgba(0,0,0,.12);
        border-radius: .375rem;
        font-size: .75rem;
        line-height: 1;
        text-transform: uppercase;
    }

    .fav-form {
        justify-self: end;
    }

    :root {
        --live-color: #dc3545;
        --live-color-soft: #ff6b6b;
    }

    @@keyframes livePulse {
        0% {
            color: var(--live-color);
            opacity: 0.95;
        }

        100% {
            color: var(--live-color-soft);
            opacity: 1;
        }
    }

    @@keyframes blinkDot {
        0% {
            opacity: .55;
        }

        100% {
            opacity: 1;
        }
    }

    .is-live {
        color: var(--live-color);
        animation: livePulse 1.1s ease-in-out infinite alternate;
    }

    .live-minute.is-live {
        color: var(--live-color);
        font-weight: 700;
        animation: livePulse .9s ease-in-out infinite alternate;
    }

    .is-live::after {
        animation: blinkDot 1s ease-in-out infinite alternate;
    }

    @@media (prefers-reduced-motion: reduce) {
        .is-live, .live-minute.is-live {
            animation: none !important;
        }
    }

    @@media (max-width: 576px) {
        .team {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

            .team.home {
                justify-self: end;
            }

            .team.away {
                justify-self: start;
            }

        .team-logo {
            height: 24px;
            margin-bottom: 2px;
        }

        .team-name {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            max-width: 100%;
            line-height: 1.1;
        }

        .vs-pill {
            font-size: .65rem;
            padding: .08rem .35rem;
        }

        .match-grid {
            row-gap: .35rem;
        }
    }
</style>

@section Scripts {
    <script>
        // VAPID public key dal backend
        const VAPID_PUBLIC_KEY = '@Model.VapidPublicKey';
    </script>
    <script>
        // Richiede il permesso di inviare notifiche (una sola volta)
        (function () {
            if (!('Notification' in window)) return;

            // Piccolo delay per evitare di sparare subito al caricamento
            setTimeout(function () {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().catch(function () { });
                }
            }, 2000);
        })();
    </script>
    <script>
        /**
         * Live scores NextStake + notifiche locali:
         * - chiede tutti i fixtures in pagina a /api/livescores
         * - aggiorna punteggi/minuti
         * - per i match nei preferiti, mostra notifiche su:
         *   - inizio partita
         *   - fine primo tempo
         *   - inizio secondo tempo
         *   - fine partita
         *   - goal
         */
        (function () {
            const ENDPOINT = '/api/livescores';
            const BATCH = 20;
            const LIVE_INTERVAL_MS = 10000; // 10 secondi
            const LIVE_STATUSES = ['1H', '2H', 'ET', 'P', 'BT', 'LIVE', 'HT'];
            const FINISHED_STATUSES = ['FT', 'AET', 'PEN'];

            // Stato precedente per ogni fixtureId -> { status, home, away }
            const prevState = new Map();

            function chunk(arr, size) {
                return arr.length ? [arr.slice(0, size), ...chunk(arr.slice(size), size)] : [];
            }

            // NOTIFICA LOCALE
            function fireLocalNotification(kind, data) {
                if (!('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;

                const { id, homeName, awayName, home, away, minute, status } = data;

                let title = 'Notifica match';
                let body = '';

                const scoreStr = (home != null && away != null)
                    ? `${home} - ${away}`
                    : '';

                switch (kind) {
                    case 'start':
                        title = 'Inizio partita';
                        body = `${homeName} - ${awayName} è iniziata.`;
                        break;
                    case 'halftime':
                        title = 'Fine primo tempo';
                        body = `${homeName} - ${awayName} | HT ${scoreStr}`;
                        break;
                    case 'second':
                        title = 'Inizio secondo tempo';
                        body = `${homeName} - ${awayName} | Ripresa in corso.`;
                        break;
                    case 'end':
                        title = 'Partita terminata';
                        body = `${homeName} - ${awayName} | Finale ${scoreStr}`;
                        break;
                    case 'goal':
                        title = 'GOAL!';
                        body = `${homeName} - ${awayName} | ${scoreStr}` + (minute ? ` al ${minute}'` : '');
                        break;
                    default:
                        body = `${homeName} - ${awayName}`;
                        break;
                }

                const options = {
                    body: body,
                    icon: '/icons/android-chrome-192x192.png',
                    badge: '/icons/android-chrome-192x192.png',
                    tag: `match-${id}-${kind}`, // evita spam infinito, raggruppa per tipo
                };

                try {
                    new Notification(title, options);
                } catch { }
            }

            function initLiveScores() {
                // Raccogli TUTTI gli ID presenti in pagina (dopo che il DOM è pronto)
                const scoreNodes = document.querySelectorAll('[data-fixture][data-side]');
                const ids = [...new Set(
                    [...scoreNodes].map(n => n.getAttribute('data-fixture')).filter(Boolean)
                )];

                if (!ids.length) {
                    console.debug('Livescores: nessun fixture in pagina, non avvio il polling.');
                    return;
                }

                console.debug('Livescores inizializzati, fixture IDs:', ids);

                function applyUpdate(it) {
                    if (!it || !it.id) return;

                    const id = String(it.id);
                    const homeEl = document.querySelector(`.home-score[data-fixture="${id}"]`);
                    const awayEl = document.querySelector(`.away-score[data-fixture="${id}"]`);
                    const minuteEl = document.querySelector(`.live-minute[data-fixture="${id}"]`);

                    const statusRaw = (it.status || '').toUpperCase();
                    const status = statusRaw || '';
                    const isLiveNow = LIVE_STATUSES.includes(status);
                    const isFinishedNow = FINISHED_STATUSES.includes(status);

                    const hasDom = !!(homeEl || awayEl || minuteEl);
                    if (!hasDom) return;

                    // Trova il "root" della partita e verifica se è preferita
                    const root = (homeEl || awayEl || minuteEl)?.closest('.list-group-item');
                    const isFav = root && root.getAttribute('data-fav') === '1';

                    let homeName = '';
                    let awayName = '';
                    if (root) {
                        const h = root.querySelector('.team.home .team-name');
                        const a = root.querySelector('.team.away .team-name');
                        homeName = h ? h.textContent.trim() : '';
                        awayName = a ? a.textContent.trim() : '';
                    }

                    console.debug('Live update item', id, 'status=', status, 'fav=', isFav, it);

                    // --- Punteggi (sia live che finali) ---
                    if (homeEl && it.home !== null && it.home !== undefined) {
                        homeEl.textContent = String(it.home);
                    }
                    if (awayEl && it.away !== null && it.away !== undefined) {
                        awayEl.textContent = String(it.away);
                    }

                    // --- Minutaggio live ---
                    if (minuteEl) {
                        if (isLiveNow) {
                            let label = '';
                            if (typeof it.elapsed === 'number' && it.elapsed >= 0) label = `${it.elapsed}'`;
                            else if (status === 'HT') label = 'HT';

                            if (label) {
                                minuteEl.textContent = label;
                                minuteEl.classList.remove('d-none');
                            } else {
                                minuteEl.classList.add('d-none');
                            }
                            minuteEl.classList.add('is-live');
                        } else {
                            minuteEl.classList.add('d-none');
                            minuteEl.classList.remove('is-live');
                        }
                    }

                    // --- Classi rosse su punteggi ---
                    const mark = el => {
                        if (!el) return;
                        if (isLiveNow) el.classList.add('is-live');
                        else el.classList.remove('is-live');
                    };
                    mark(homeEl);
                    mark(awayEl);

                    // --- Rilevazione eventi vs stato precedente (solo per preferiti) ---
                    const prev = prevState.get(id);
                    const current = {
                        status,
                        home: it.home,
                        away: it.away
                    };

                    if (isFav && prev) {
                        const isLivePrev = prev.status && LIVE_STATUSES.includes(prev.status);
                        const isFinishedPrev = prev.status && FINISHED_STATUSES.includes(prev.status);

                        const homeChanged = (prev.home ?? null) !== (it.home ?? null);
                        const awayChanged = (prev.away ?? null) !== (it.away ?? null);

                        const commonData = {
                            id,
                            homeName,
                            awayName,
                            home: it.home,
                            away: it.away,
                            minute: typeof it.elapsed === 'number' ? it.elapsed : null,
                            status
                        };

                        // Inizio partita (non era live prima, è live ora)
                        if (!isLivePrev && isLiveNow) {
                            fireLocalNotification('start', commonData);
                        }

                        // Fine primo tempo
                        if (prev.status === '1H' && status === 'HT') {
                            fireLocalNotification('halftime', commonData);
                        }

                        // Inizio secondo tempo
                        if (prev.status === 'HT' && status === '2H') {
                            fireLocalNotification('second', commonData);
                        }

                        // Fine partita (non finita prima, finita ora)
                        if (!isFinishedPrev && isFinishedNow) {
                            fireLocalNotification('end', commonData);
                        }

                        // Goal (cambiato uno dei due punteggi)
                        if (homeChanged || awayChanged) {
                            // Evita di segnalare goal dopo il fischio finale
                            if (!isFinishedNow) {
                                fireLocalNotification('goal', commonData);
                            }
                        }
                    }

                    // Aggiorna stato corrente
                    prevState.set(id, current);
                }

                async function fetchBatch(batchIds, extraParamsObj) {
                    const qs = new URLSearchParams();
                    qs.set('ids', batchIds.join(','));

                    if (extraParamsObj) {
                        for (const [k, v] of Object.entries(extraParamsObj)) {
                            if (v !== null && v !== undefined) {
                                qs.set(k, String(v));
                            }
                        }
                    }

                    try {
                        const res = await fetch(`${ENDPOINT}?${qs.toString()}`, { cache: 'no-store' });
                        if (!res.ok) return null;
                        return await res.json();
                    } catch {
                        return null;
                    }
                }

                async function fetchAndApplyAll(extraParamsObj) {
                    const batches = chunk(ids, BATCH);

                    for (const b of batches) {
                        const data = await fetchBatch(b, extraParamsObj);
                        if (!data) continue;

                        console.debug('Livescores batch response:', data);

                        let items = [];

                        if (Array.isArray(data)) {
                            items = data;
                        } else if (Array.isArray(data.response)) {
                            items = data.response.map(x => ({
                                id: x.id ?? x.fixture?.id,
                                home: x.home ?? x.goals?.home,
                                away: x.away ?? x.goals?.away,
                                status: x.status ?? x.fixture?.status?.short,
                                elapsed: x.elapsed ?? x.fixture?.status?.elapsed
                            }));
                        } else {
                            if (data.id) items = [data];
                        }

                        for (const it of items) {
                            applyUpdate(it);
                        }
                    }
                }

                // === BOOTSTRAP: inizializza stato senza notificare passato ===
                (async function bootstrap() {
                    await fetchAndApplyAll({ includeFinished: 1, status: 'FT,AET,PEN', scope: 'all' });
                })().finally(() => {
                    // === POLLING LIVE ===
                    let timerHandle = null;

                    async function liveTick() {
                        await fetchAndApplyAll({});
                    }

                    function start() {
                        if (timerHandle) return;
                        liveTick();
                        timerHandle = setInterval(liveTick, LIVE_INTERVAL_MS);
                    }

                    function stop() {
                        if (timerHandle) {
                            clearInterval(timerHandle);
                            timerHandle = null;
                        }
                    }

                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) stop(); else start();
                    });

                    start();
                });
            }

            // Avvia dopo che il DOM è pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLiveScores);
            } else {
                initLiveScores();
            }
        })();
    </script>


    <script>
        (function(){
          // Inizializza stato bottoni in base al tema corrente
          function currentChoice(){
            const cookie = document.cookie.match(/(?:^|;\s*)theme=([^;]+)/);
            const c = cookie ? decodeURIComponent(cookie[1]) : null;
            return c || localStorage.getItem('theme') || 'system';
          }
          function applyTheme(choice){
            // “system” -> calcola dark/light dal media query
            let applied = choice;
            if (choice === 'system'){
              applied = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', applied);
          }
          function persist(choice){
            localStorage.setItem('theme', choice);
            document.cookie = "theme="+encodeURIComponent(choice)+"; path=/; max-age=31536000; samesite=lax";
          }
          async function saveServer(choice){
            try{
              await fetch('?handler=SetTheme', {
                method:'POST',
                headers:{'Content-Type':'application/json','X-Requested-With':'fetch'},
                body: JSON.stringify({ theme: choice })
              });
            }catch{}
          }

          // Wiring bottoni
          const btns = document.querySelectorAll('[data-theme-choice]');
          btns.forEach(b=>{
            b.addEventListener('click', async ()=>{
              const choice = b.getAttribute('data-theme-choice');
              applyTheme(choice);
              persist(choice);
              await saveServer(choice); // se anonimo, il server terrà solo il cookie
              // Aggiorna aspetto dei bottoni (attivo)
              btns.forEach(x=>x.classList.remove('active'));
              b.classList.add('active');
            });
          });

          // Stato iniziale
          const choice = currentChoice();
          applyTheme(choice);
          const active = document.querySelector(`[data-theme-choice="${choice}"]`);
          if (active) active.classList.add('active');
        })();
    </script>
    <script>
        (function () {
            const btn = document.getElementById('btn-live-filter');
            if (!btn) return;

            let active = false;

            btn.addEventListener('click', function () {
                active = !active;

                const allMatches = document.querySelectorAll('.list-group-item[data-live]');

                allMatches.forEach(el => {
                    const isLive = el.getAttribute('data-live') === '1';

                    if (active) {
                        // Mostra solo i LIVE
                        el.style.display = isLive ? '' : 'none';
                    } else {
                        // Ripristina tutto
                        el.style.display = '';
                    }
                });

                // Aggiorna stile bottone
                if (active) {
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                    btn.textContent = '🔴 LIVE ATTIVI';
                } else {
                    btn.classList.add('btn-outline-danger');
                    btn.classList.remove('btn-danger');
                    btn.textContent = '🔴 LIVE';
                }
            });
        })();
    </script>
    <script>
        (function () {
            const btn = document.getElementById('btn-push-toggle');
            const statusEl = document.getElementById('push-status');

            if (!btn) return;

            // ⚠️ Sostituisci con la tua chiave pubblica VAPID in formato base64 url-safe
            // es: "BOp5W...ecc..."
            const VAPID_PUBLIC_KEY = 'BGzvjpfsQIu-nU76Aqr1S22XVzybN35iOpCf6IopdR-c-Vt7H7h5_LmC1RzKmi_t0uR5OncrDZLFoJ6gxFB2BEM';

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding)
                    .replace(/-/g, '+')
                    .replace(/_/g, '/');

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            function setUi(enabled) {
                if (enabled) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    btn.textContent = 'Notifiche attive';
                    if (statusEl) statusEl.textContent = 'Riceverai notifiche per i match preferiti.';
                } else {
                    btn.classList.add('btn-outline-primary');
                    btn.classList.remove('btn-success');
                    btn.textContent = 'Attiva notifiche';
                    if (statusEl) statusEl.textContent = 'Notifiche disattivate.';
                }
            }

            async function getRegistration() {
                if (!('serviceWorker' in navigator)) {
                    if (statusEl) statusEl.textContent = 'Il tuo browser non supporta le notifiche push.';
                    btn.disabled = true;
                    return null;
                }

                try {
                    // Prova a recuperare una registration esistente
                    let reg = await navigator.serviceWorker.getRegistration();
                    if (!reg) {
                        // Se non esiste, registriamo /service-worker.js con scope root
                        reg = await navigator.serviceWorker.register('/service-worker.js');
                    }
                    return reg;
                } catch (err) {
                    console.error('Errore registrazione service worker', err);
                    if (statusEl) statusEl.textContent = 'Errore nella registrazione delle notifiche.';
                    btn.disabled = true;
                    return null;
                }
            }

            async function ensureSubscribed() {
                const reg = await getRegistration();
                if (!reg || !('pushManager' in reg)) {
                    if (statusEl) statusEl.textContent = 'Le notifiche push non sono supportate dal tuo browser.';
                    return null;
                }

                let sub = await reg.pushManager.getSubscription();

                if (!sub) {
                    // chiede il permesso al browser
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        if (statusEl) statusEl.textContent = 'Per attivare le notifiche devi consentirle nel browser.';
                        return null;
                    }

                    sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                }

                // invia al backend
                const rawP256 = sub.getKey('p256dh');
                const rawAuth = sub.getKey('auth');

                const p256dh = rawP256
                    ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawP256)))
                    : '';
                const auth = rawAuth
                    ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawAuth)))
                    : '';

                const payload = {
                    endpoint: sub.endpoint,
                    p256Dh: p256dh,
                    auth: auth
                };

                try {
                    await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (err) {
                    console.error('Errore chiamata /api/push/subscribe', err);
                    if (statusEl) statusEl.textContent = 'Errore durante il salvataggio della subscription.';
                }

                return sub;
            }

            async function unsubscribe() {
                const reg = await getRegistration();
                if (!reg || !('pushManager' in reg)) return;
                const sub = await reg.pushManager.getSubscription();
                if (!sub) return;

                const endpoint = sub.endpoint;

                try {
                    await sub.unsubscribe();
                } catch (err) {
                    console.warn('Errore unsubscribe client', err);
                }

                try {
                    await fetch('/api/push/unsubscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ endpoint })
                    });
                } catch (err) {
                    console.warn('Errore /api/push/unsubscribe', err);
                }
            }

            // Inizializzazione UI in base allo stato attuale
            (async function init() {
                if (!('serviceWorker' in navigator) || !('Notification' in window)) {
                    if (statusEl) statusEl.textContent = 'Il tuo browser non supporta le notifiche push.';
                    btn.disabled = true;
                    return;
                }

                try {
                    const reg = await navigator.serviceWorker.getRegistration();
                    const sub = reg && await reg.pushManager.getSubscription();
                    const enabled = !!sub && Notification.permission === 'granted';
                    setUi(enabled);
                } catch (err) {
                    console.error('Errore init push toggle', err);
                }
            })();

            btn.addEventListener('click', async () => {
                if (btn.disabled) return;

                const reg = await getRegistration();
                const currentSub = reg && await reg.pushManager.getSubscription();
                const currentlyEnabled = !!currentSub && Notification.permission === 'granted';

                if (!currentlyEnabled) {
                    const sub = await ensureSubscribed();
                    if (sub) setUi(true);
                } else {
                    await unsubscribe();
                    setUi(false);
                }
            });
        })();
    </script>

}

@section Styles {
    <text>
        <style>
            /* === Palette a variabili: due temi pilotati da [data-theme] su <html> === */
            :root[data-theme="dark"] {
                --bg: linear-gradient(135deg, #252e40 0%, #1a2230 100%);
                --text: #e9edf3;
                --muted-text: rgba(255,255,255,.6);
                --card: rgba(255,255,255,0.06);
                --border: rgba(255,255,255,0.16);
                --divider: rgba(255,255,255,0.14);
                --select-bg: #1f2a3a;
                --select-bg-focus: #213044;
                --select-text: #e9edf3;
                --link: #7bd3ff;
                --link-hover: #9be0ff;
                --primary: #00baff;
                --primary-hover: #009cdc;
                --mini-day: rgba(255,255,255,.08);
                --mini-day-hover: rgba(255,255,255,.14);
                --mini-day-border: rgba(255,255,255,.20);
                --league-toggle-bg: #2b3445;
                --league-toggle-bg-hover: #364056;
                --vs-border: rgba(255,255,255,.22);
                --list-border: rgba(255,255,255,.20);
                --live: #dc3545;
                --live-soft: #ff6b6b;
            }

            :root[data-theme="light"] {
                --bg: #f7f9fc;
                --text: #1a2230;
                --muted-text: #566079;
                --card: #ffffff;
                --border: rgba(0,0,0,0.10);
                --divider: rgba(0,0,0,0.12);
                --select-bg: #ffffff;
                --select-bg-focus: #ffffff;
                --select-text: #1a2230;
                --link: #0d6efd;
                --link-hover: #0b5ed7;
                --primary: #0d6efd;
                --primary-hover: #0b5ed7;
                --mini-day: #ffffff;
                --mini-day-hover: #f2f4f8;
                --mini-day-border: rgba(0,0,0,.12);
                --league-toggle-bg: #f7f7f7;
                --league-toggle-bg-hover: #e9ecef;
                --vs-border: rgba(0,0,0,.12);
                --list-border: #dee2e6;
                --live: #dc3545;
                --live-soft: #ff6b6b;
            }

            /* Base */
            body {
                background: var(--bg);
                color: var(--text);
                font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            }

            header, footer {
                background: transparent !important;
                border: none !important;
            }

            footer {
                color: var(--muted-text);
            }

            .events-page {
                background: transparent;
                color: var(--text);
            }

                .events-page .card,
                .events-page .list-group-item,
                .events-page .dropdown-menu,
                .events-page .modal-content {
                    background: var(--card);
                    border: 1px solid var(--border);
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                    color: var(--text);
                }

                .events-page .card-header {
                    background: var(--card);
                    border-bottom: 1px solid var(--divider);
                    color: var(--text);
                }

                .events-page .btn-primary {
                    background: var(--primary);
                    border-color: var(--primary);
                }

                    .events-page .btn-primary:hover {
                        background: var(--primary-hover);
                        border-color: var(--primary-hover);
                    }

                .events-page a {
                    color: var(--link);
                }

                    .events-page a:hover {
                        color: var(--link-hover);
                    }

                /* Select */
                .events-page .form-select {
                    background-color: var(--select-bg) !important;
                    color: var(--select-text) !important;
                    border: 1px solid var(--border) !important;
                }

                    .events-page .form-select option {
                        background: #ffffff !important;
                        color: #111111 !important;
                    }

                    .events-page .form-select:focus {
                        border-color: var(--primary) !important;
                        box-shadow: 0 0 0 4px rgba(0,195,255,.18) !important;
                        background-color: var(--select-bg-focus) !important;
                        color: var(--select-text) !important;
                    }

            /* Mini calendario */
            .mini-cal {
                display: grid;
                gap: .25rem;
            }

            .mini-cal-row {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: .25rem;
            }

            .mini-cal-day {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                text-decoration: none;
                border: 1px solid var(--mini-day-border);
                border-radius: .375rem;
                padding: .35rem 0;
                font-size: .9rem;
                line-height: 1;
                min-height: 2rem;
                background: var(--mini-day);
                color: var(--text);
            }

                .mini-cal-day:hover {
                    background: var(--mini-day-hover);
                    text-decoration: none;
                }

            .cal-outside {
                opacity: .45;
            }

            .is-today {
                outline: 2px solid rgba(13,110,253,.4);
                outline-offset: -2px;
            }

            .is-selected {
                background: #0d6efd;
                color: #fff;
                border-color: #0d6efd;
                box-shadow: 0 8px 18px rgba(13,110,253,.28);
            }

            /* Gruppi/league header */
            .league-toggle-btn {
                background-color: var(--league-toggle-bg);
                transition: background-color .2s ease;
                border-top-left-radius: .25rem;
                border-top-right-radius: .25rem;
                width: 100%;
            }

                .league-toggle-btn:hover {
                    background-color: var(--league-toggle-bg-hover);
                }

            .toggle-caret {
                transition: transform .2s ease;
                display: inline-block;
                font-size: 1.1rem;
            }

            [data-bs-toggle="collapse"][aria-expanded="false"] .toggle-caret {
                transform: rotate(-90deg);
            }

            .list-group-item {
                border-left: none;
                border-right: none;
                border-bottom: 1px solid var(--list-border);
            }

            /* Match grid */
            .match-item {
                display: grid;
                grid-template-columns: 1fr auto;
                align-items: center;
                gap: .75rem;
            }

            .match-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                grid-template-rows: auto auto;
                column-gap: .5rem;
                row-gap: .25rem;
                text-decoration: none;
                color: inherit;
            }

                .match-grid:hover {
                    text-decoration: none;
                }

            .team {
                display: inline-flex;
                align-items: center;
                gap: .4rem;
                min-width: 0;
            }

                .team.home {
                    justify-self: end;
                }

                .team.away {
                    justify-self: start;
                }

            /* Box fisso per i loghi */
            .team-logo-box {
                width: 24px;
                height: 24px;
                flex: 0 0 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

                .team-logo-box .team-logo {
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    display: block;
                }

            .team-name {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }

            .center {
                justify-self: center;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .home-score {
                grid-column: 1;
                justify-self: end;
                font-weight: 600;
            }

            .score-sep {
                grid-column: 2;
                justify-self: center;
            }

            .away-score {
                grid-column: 3;
                justify-self: start;
                font-weight: 600;
            }

            .vs-pill {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: .1rem .4rem;
                border: 1px solid var(--vs-border);
                border-radius: .375rem;
                font-size: .75rem;
                line-height: 1;
                text-transform: uppercase;
            }

            .fav-form {
                justify-self: end;
            }

            /* Live */
            :root {
                --live-color: var(--live);
                --live-color-soft: var(--live-soft);
            }

            @@keyframes livePulse {
                0% {
                    color: var(--live-color);
                    opacity: .95
                }

                100% {
                    color: var(--live-color-soft);
                    opacity: 1
                }
            }

            @@keyframes blinkDot {
                0% {
                    opacity: .55
                }

                100% {
                    opacity: 1
                }
            }

            .is-live {
                color: var(--live-color);
                animation: livePulse 1.1s ease-in-out infinite alternate;
            }

            .live-minute {
                font-weight: 600;
                line-height: 1;
            }

                .live-minute.is-live {
                    color: var(--live-color);
                    font-weight: 700;
                    animation: livePulse .9s ease-in-out infinite alternate;
                }



            @@media (prefers-reduced-motion: reduce) {
                .is-live, .live-minute.is-live {
                    animation: none !important;
                }
            }

            /* Mobile tweaks */
            @@media (max-width: 576px) {
                .team {
                    flex-direction: column;
                    align-items: center;
                    text-align: center;
                }

                .team-logo-box {
                    width: 28px;
                    height: 28px;
                    margin-bottom: 2px;
                }

                .team-name {
                    white-space: normal;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    max-width: 100%;
                    line-height: 1.1;
                }

                .vs-pill {
                    font-size: .65rem;
                    padding: .08rem .35rem;
                }

                .match-grid {
                    row-gap: .35rem;
                }
            }

            /* Overlay loading (riuso) */
            .loading-overlay {
                position: fixed;
                inset: 0;
                background: rgba(10,14,20,0.65);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 5000;
                backdrop-filter: blur(2px);
            }

            .loading-panel {
                background: rgba(20,26,36,0.92);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.18);
                border-radius: .75rem;
                box-shadow: 0 12px 36px rgba(0,0,0,.35);
                padding: 1.25rem 1.5rem;
                display: flex;
                align-items: center;
                gap: .75rem;
                max-width: 90vw;
            }

                .loading-panel .spinner-border {
                    color: #fff;
                }

                .loading-panel.video-only {
                    padding: 0;
                    background: transparent;
                    border: none;
                    box-shadow: none;
                }

                .loading-panel.video-only {
                    padding: 0;
                    background: transparent;
                    border: none;
                    box-shadow: none;
                }

            /* Desktop: bello grande */
            .loading-video {
                width: 480px; /* prima era 320 */
                max-width: 70vw; /* non oltre il 70% della viewport */
                height: auto;
                display: block;
                border-radius: 1rem;
            }

            /* Tablet */
            @@media (max-width: 1024px) {
                .loading-video

            {
                width: 360px;
                max-width: 80vw;
            }

            }

            /* Smartphone */
            @@media (max-width: 576px) {
                .loading-video

            {
                width: 240px;
                max-width: 90vw;
            }

            }


            /* Stato “attivo” dei bottoni tema */
            [data-theme-choice].active {
                background: var(--primary);
                border-color: var(--primary);
                color: #fff;
            }


        </style>
    </text>
}
