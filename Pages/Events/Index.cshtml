@page
@{
    Layout = "/Pages/Shared/_Layout.cshtml";
}

@model NextStakeWebApp.Pages.Events.IndexModel
@using System.Globalization
@using System.Runtime.InteropServices
@{
    var it = new CultureInfo("it-IT");

    // Oggi: basta il giorno
    var today = DateOnly.FromDateTime(DateTime.Now);

    var sel = Model.SelectedDate;
    var dayName = it.TextInfo.ToTitleCase(sel.ToDateTime(TimeOnly.MinValue).ToString("dddd", it));

    var firstOfMonth = new DateOnly(sel.Year, sel.Month, 1);
    var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);

    var startCal = firstOfMonth;
    while (startCal.DayOfWeek != DayOfWeek.Monday) startCal = startCal.AddDays(-1);

    var endCal = lastOfMonth;
    while (endCal.DayOfWeek != DayOfWeek.Sunday) endCal = endCal.AddDays(1);

    var common = $"&fav={(Model.OnlyFavorites ? 1 : 0)}&country={Model.SelectedCountryCode}&q={Model.Query}" + (Model.ShowBest ? "&best=1" : "");
}

@{
    ViewData["Title"] = "Eventi";
}
<div class="events-page">
    <div class="container py-4">

        <div class="row g-3">
            <!-- SIDEBAR -->
            <aside class="col-12 col-lg-3">
                <div class="card mb-3">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <a class="btn btn-sm btn-outline-secondary"
                           href="/Events?d=@firstOfMonth.AddMonths(-1).ToString("yyyy-MM-dd")@common"
                           aria-label="Mese precedente">←</a>
                        <div class="fw-semibold small text-center">
                            @it.TextInfo.ToTitleCase(firstOfMonth.ToDateTime(TimeOnly.MinValue).ToString("MMMM", it)) @firstOfMonth.Year
                        </div>
                        <a class="btn btn-sm btn-outline-secondary"
                           href="/Events?d=@firstOfMonth.AddMonths(1).ToString("yyyy-MM-dd")@common"
                           aria-label="Mese successivo">→</a>
                    </div>

                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Lun</small>
                            <small class="text-muted">Mar</small>
                            <small class="text-muted">Mer</small>
                            <small class="text-muted">Gio</small>
                            <small class="text-muted">Ven</small>
                            <small class="text-muted">Sab</small>
                            <small class="text-muted">Dom</small>
                        </div>

                        <div class="mini-cal">
                            @{
                                var d = startCal;
                                while (d <= endCal)
                                {
                                    <div class="mini-cal-row">
                                        @for (int i = 0; i < 7; i++)
                                        {
                                            var isOutside = d < firstOfMonth || d > lastOfMonth;
                                            var isToday = d == today;
                                            var isSelected = d == sel;

                                            <a class="mini-cal-day @(isOutside ? "cal-outside" : "") @(isToday ? "is-today" : "") @(isSelected ? "is-selected" : "")"
                                               href="/Events?d=@d.ToString("yyyy-MM-dd")@common">
                                                @d.Day
                                            </a>
                                            ;
                                            d = d.AddDays(1);
                                        }
                                    </div>
                                }
                            }
                        </div>

                        <div class="d-grid mt-2">
                            <a class="btn btn-sm btn-outline-primary"
                               href="/Events?d=@today.ToString("yyyy-MM-dd")@common">Oggi</a>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-3">
                    <a class="btn @(Model.OnlyFavorites ? "btn-warning" : "btn-outline-warning")"
                       href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 0 : 1)&country=@Model.SelectedCountryCode&q=@Model.Query">
                        ⭐ @(Model.OnlyFavorites ? "Mostra tutti" : "Vedi preferiti")
                    </a>

                    <a class="btn btn-success"
                       href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query&best=1"
                       data-loading="best">
                        Migliori pronostici
                    </a>

                    @if (Model.ShowBest)
                    {
                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites ? 1 : 0)&country=@Model.SelectedCountryCode&q=@Model.Query">
                            Nascondi pronostici
                        </a>
                    }
                </div>

                <form method="get" action="/Events" class="card p-3 mb-3">
                    <div class="mb-2">
                        <label class="form-label">Filtro Nazione</label>
                        <select class="form-select form-select-sm" name="country" onchange="this.form.submit()">
                            <option value="">— Mostra tutte —</option>
                            @foreach (var c in Model.AvailableCountries)
                            {
                                <option value="@c.Code" selected="@(Model.SelectedCountryCode == c.Code)">
                                    @c.Name (@c.Code)
                                </option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Cerca (squadra o competizione)</label>
                        <input class="form-control form-control-sm" type="text" name="q" value="@Model.Query" placeholder="Es: Serie A, Inter, Premier..." />
                    </div>

                    <input type="hidden" name="d" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="fav" value="@(Model.OnlyFavorites ? 1 : 0)" />
                    @if (Model.ShowBest)
                    {
                        <input type="hidden" name="best" value="1" />
                    }

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-sm">Filtra</button>
                    </div>
                </form>
            </aside>

            <!-- MAIN -->
            <main class="col-12 col-lg-9">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="h5 mb-0">
                        @dayName @Model.SelectedDate.ToString("dd/MM/yyyy")
                    </div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.AddDays(-1).ToString("yyyy-MM-dd")@common"
                           aria-label="Giorno precedente">←</a>
                        <a class="btn btn-outline-secondary"
                           href="/Events?d=@Model.SelectedDate.AddDays(1).ToString("yyyy-MM-dd")@common"
                           aria-label="Giorno successivo">→</a>
                    </div>
                </div>

                @if (Model.ShowBest)
                {
                    <div class="card mb-4 best-picks">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div class="fw-semibold">🔥 Migliori pronostici</div>
                            <small class="text-muted">Ordinati per data/ora</small>
                        </div>
                        <div class="card-body">
                            @* Messaggio diagnostico (se impostato dal backend) *@
                            @if (!string.IsNullOrWhiteSpace(Model.BestMessage))
                            {
                                <div class="alert alert-info mb-3">@Model.BestMessage</div>
                            }

                            @{
                                var bestItems = (Model.BestPicks ?? new List<NextStakeWebApp.Models.BestPickRow>())
                                .OrderBy(x => x.EventDate)
                                .Select(r =>
                                {
                                    Model.AssetsByMatchId.TryGetValue(r.Id, out var a);

                                    // Competition del tipo "NL - Eredivisie" -> split in CountryCode/LeagueName
                                    var comp = r.Competition ?? "";
                                    var split = comp.Split(" - ", 2, StringSplitOptions.TrimEntries);
                                    var countryCode = split.Length > 0 ? split[0] : "";
                                    var leagueName = split.Length > 1 ? split[1] : comp;

                                    return new
                                    {
                                        R = r,
                                        A = a,
                                        Country = countryCode,
                                        League = leagueName,
                                        Flag = a?.LeagueFlag,
                                        Logo = a?.LeagueLogo
                                    };
                                })
                                .ToList();

                                var gi = 0;
                            }

                            @if (bestItems.Count == 0)
                            {
                                <div class="alert alert-secondary mb-0">Nessun pronostico disponibile al momento.</div>
                            }
                            else
                            {
                                @foreach (var grp in bestItems.GroupBy(x => new { x.Country, x.League, x.Flag, x.Logo }))
                                {
                                    var gid = $"bestgrp-{++gi}";

                                    <div class="mb-3 border rounded">
                                        <button class="w-100 text-start d-flex align-items-center justify-content-between league-toggle-btn border-0"
                                                type="button" data-bs-toggle="collapse" data-bs-target="#@gid"
                                                aria-expanded="true" aria-controls="@gid">
                                            <div class="d-flex align-items-center gap-2 py-2 px-3">
                                                <span class="toggle-caret">▾</span>

                                                @if (!string.IsNullOrWhiteSpace(grp.Key.Logo))
                                                {
                                                    <img src="@grp.Key.Logo" alt="league-logo" style="height:18px;width:auto;" />
                                                }

                                                <span class="fw-semibold">@grp.Key.League</span>

                                                @if (!string.IsNullOrWhiteSpace(grp.Key.Country) || !string.IsNullOrWhiteSpace(grp.Key.Flag))
                                                {
                                                    <small class="text-muted d-flex align-items-center ms-2" style="gap:.35rem;">
                                                        ( @grp.Key.Country
                                                        @if (!string.IsNullOrWhiteSpace(grp.Key.Flag))
                                                        {
                                                            <img src="@grp.Key.Flag" alt="flag" style="height:14px;width:auto;vertical-align:middle;" />
                                                        }
                                                        )
                                                    </small>
                                                }
                                            </div>
                                        </button>

                                        <div id="@gid" class="collapse show">
                                            <div class="list-group list-group-flush">
                                                @foreach (var bp in grp)
                                                {
                                                    // Nomi squadre dal campo "Match" tipo "Home - Away"
                                                    var parts = (bp.R.Match ?? "").Split(" - ", 2, StringSplitOptions.TrimEntries);
                                                    var homeName = parts.Length > 0 ? parts[0] : bp.R.Match;
                                                    var awayName = parts.Length > 1 ? parts[1] : "";

                                                    var ko = bp.R.EventDate.ToString("dd/MM HH:mm"); // mostrato come orario locale macchina/app

                                                    <div class="list-group-item">
                                                        <div class="match-item">
                                                            <a href="/Match/Details?id=@bp.R.Id" class="match-grid">
                                                                <div class="team home">
                                                                    @if (!string.IsNullOrWhiteSpace(bp.A?.HomeLogo))
                                                                    {
                                                                        <img src="@bp.A.HomeLogo" alt="home" class="team-logo" />
                                                                    }
                                                                    <span class="team-name">@homeName</span>
                                                                </div>

                                                                <div class="center">
                                                                    <span class="vs-pill">vs</span>
                                                                    <small class="text-muted mt-1">@ko</small>
                                                                </div>

                                                                <div class="team away">
                                                                    <span class="team-name">@awayName</span>
                                                                    @if (!string.IsNullOrWhiteSpace(bp.A?.AwayLogo))
                                                                    {
                                                                        <img src="@bp.A.AwayLogo" alt="away" class="team-logo" />
                                                                    }
                                                                </div>

                                                                <div class="home-score">–</div>
                                                                <div class="score-sep">:</div>
                                                                <div class="away-score">–</div>
                                                            </a>

                                                            <div class="d-flex align-items-center">
                                                                <a href="/Match/Details?id=@bp.R.Id"
                                                                   target="_blank" rel="noopener"
                                                                   class="btn btn-sm btn-outline-primary">
                                                                    Apri evento ↗
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }


                @if (Model.Rows.Count == 0)
                {
                    <p>Nessuna partita trovata per il giorno selezionato.</p>
                }
                else
                {
                    @foreach (var group in Model.Rows.GroupBy(r => new { r.LeagueId, r.LeagueName, r.LeagueLogo, r.CountryName, r.LeagueFlag }))
                    {
                        var groupId = $"lg-{group.Key.LeagueId}";

                        <div class="mb-3 border rounded">
                            <button class="w-100 text-start d-flex align-items-center justify-content-between league-toggle-btn border-0"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#@groupId"
                                    aria-expanded="true" aria-controls="@groupId">
                                <div class="d-flex align-items-center gap-2 py-2 px-3">
                                    <span class="toggle-caret">▾</span>

                                    @if (!string.IsNullOrWhiteSpace(group.Key.LeagueLogo))
                                    {
                                        <img src="@group.Key.LeagueLogo" alt="league-logo" style="height:18px;width:auto;" />
                                    }

                                    <span class="fw-semibold">@group.Key.LeagueName</span>

                                    @if (!string.IsNullOrWhiteSpace(group.Key.CountryName) || !string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                    {
                                        <small class="text-muted d-flex align-items-center ms-2" style="gap:.35rem;">
                                            ( @group.Key.CountryName
                                            @if (!string.IsNullOrWhiteSpace(group.Key.LeagueFlag))
                                            {
                                                <img src="@group.Key.LeagueFlag" alt="flag" style="height:14px;width:auto;vertical-align:middle;" />
                                            }
                                            )
                                        </small>
                                    }

                                    <small class="text-muted ms-2">#@group.Key.LeagueId</small>
                                </div>
                            </button>

                            <div id="@groupId" class="collapse show">
                                <div class="list-group list-group-flush">
                                    @foreach (var r in group)
                                    {
                                        <div class="list-group-item">
                                            <div class="match-item">
                                                @{
                                                    var matchEnded = (r.StatusShort == "FT" || r.StatusShort == "AET" || r.StatusShort == "PEN");
                                                    var homeScoreStr = matchEnded && r.HomeGoal.HasValue ? r.HomeGoal.Value.ToString() : "–";
                                                    var awayScoreStr = matchEnded && r.AwayGoal.HasValue ? r.AwayGoal.Value.ToString() : "–";

                                                    // *** nessuna conversione: già ora Italia dal DB ***
                                                    var ko = r.KickoffLocal.ToString("HH:mm");
                                                }

                                                <a href="/Match/Details?id=@r.MatchId" class="match-grid">
                                                    <div class="team home">
                                                        @if (!string.IsNullOrWhiteSpace(r.HomeLogo))
                                                        {
                                                            <img src="@r.HomeLogo" alt="home" class="team-logo" />
                                                        }
                                                        <span class="team-name">@r.Home</span>
                                                    </div>

                                                    <div class="center">
                                                        <span class="vs-pill">vs</span>
                                                        <small class="text-muted mt-1">Ora: @ko</small>
                                                        <small class="live-minute d-none" data-fixture="@r.MatchId"></small>
                                                    </div>

                                                    <div class="team away">
                                                        <span class="team-name">@r.Away</span>
                                                        @if (!string.IsNullOrWhiteSpace(r.AwayLogo))
                                                        {
                                                            <img src="@r.AwayLogo" alt="away" class="team-logo" />
                                                        }
                                                    </div>

                                                    <div class="home-score" data-fixture="@r.MatchId" data-side="home">@homeScoreStr</div>
                                                    <div class="score-sep">:</div>
                                                    <div class="away-score" data-fixture="@r.MatchId" data-side="away">@awayScoreStr</div>
                                                </a>

                                                <form method="post"
                                                      action="/Events?handler=ToggleFavorite&matchId=@r.MatchId&d=@Model.SelectedDate.ToString("yyyy-MM-dd")&fav=@(Model.OnlyFavorites?1:0)&country=@Model.SelectedCountryCode&q=@Model.Query@(Model.ShowBest ? "&best=1" : "")"
                                                      class="fav-form">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit"
                                                            class="btn btn-sm @(Model.FavoriteMatchIds.Contains(r.MatchId) ? "btn-warning" : "btn-outline-secondary")"
                                                            title="Aggiungi/rimuovi dai preferiti">
                                                        ⭐
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </main>
        </div>
    </div>
</div>

<style>
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10,14,20,0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        backdrop-filter: blur(2px);
    }

    .loading-panel {
        background: rgba(20,26,36,0.92);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: .75rem;
        box-shadow: 0 12px 36px rgba(0,0,0,.35);
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: .75rem;
        max-width: 90vw;
    }

        .loading-panel .spinner-border {
            color: #fff;
        }
</style>

<div id="loadingOverlay" class="loading-overlay d-none" aria-hidden="true">
    <div class="loading-panel">
        <div class="spinner-border" role="status" aria-label="Caricamento"></div>
        <div id="loadingMessage" class="fw-semibold">Caricamento…</div>
    </div>
</div>

<script>
    (function () {
      const overlay = document.getElementById('loadingOverlay');
      const msgEl   = document.getElementById('loadingMessage');

      function showOverlay(message) {
        if (msgEl && message) msgEl.textContent = message;
        if (overlay) overlay.classList.remove('d-none');
      }

      document.addEventListener('click', function (e) {
        const bestBtn = e.target.closest('a[data-loading="best"]');
        if (bestBtn) { showOverlay('Caricamento migliori pronostici…'); return; }

        const matchLink = e.target.closest('a.match-grid');
        if (matchLink) { showOverlay('Caricamento match in corso…'); return; }

        const generic = e.target.closest('a[data-loading-message]');
        if (generic) { showOverlay(generic.getAttribute('data-loading-message') || 'Caricamento…'); }
      });

      window.addEventListener('pageshow', () => { if (overlay) overlay.classList.add('d-none'); });
    })();
</script>

<style>
    .league-toggle-btn {
        background-color: #f7f7f7;
        transition: background-color .2s ease;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        width: 100%;
    }

        .league-toggle-btn:hover {
            background-color: #e9ecef;
        }

    .toggle-caret {
        transition: transform .2s ease;
        display: inline-block;
        font-size: 1.1rem;
    }

    [data-bs-toggle="collapse"][aria-expanded="false"] .toggle-caret {
        transform: rotate(-90deg);
    }

    .list-group-item {
        border-left: none;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
</style>

<style>
    .mini-cal {
        display: grid;
        gap: .25rem;
    }

    .mini-cal-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: .25rem;
    }

    .mini-cal-day {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: .375rem;
        padding: .35rem 0;
        font-size: .9rem;
        line-height: 1;
        min-height: 2rem;
        background: #fff;
    }

        .mini-cal-day:hover {
            background: #f6f6f6;
            text-decoration: none;
        }

    .cal-outside {
        opacity: .45;
    }

    .is-today {
        outline: 2px solid rgba(13,110,253,.4);
        outline-offset: -2px;
    }

    .is-selected {
        background: #0d6efd;
        color: #fff;
    }

    .match-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: .75rem;
    }

    .match-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        grid-template-rows: auto auto;
        column-gap: .5rem;
        row-gap: .25rem;
        text-decoration: none;
        color: inherit;
    }

        .match-grid:hover {
            text-decoration: none;
        }

    .team {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        min-width: 0;
    }

        .team.home {
            justify-self: end;
            flex-direction: row;
        }

        .team.away {
            justify-self: start;
            flex-direction: row;
        }

    .team-logo {
        height: 18px;
        width: auto;
    }

    .team-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .center {
        justify-self: center;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .home-score {
        grid-column: 1;
        justify-self: end;
        font-weight: 600;
    }

    .score-sep {
        grid-column: 2;
        justify-self: center;
    }

    .live-minute {
        font-weight: 600;
        line-height: 1;
    }

    .away-score {
        grid-column: 3;
        justify-self: start;
        font-weight: 600;
    }

    .vs-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: .1rem .4rem;
        border: 1px solid rgba(0,0,0,.12);
        border-radius: .375rem;
        font-size: .75rem;
        line-height: 1;
        text-transform: uppercase;
    }

    .fav-form {
        justify-self: end;
    }

    .is-live::after {
        content: ' •';
    }

    :root {
        --live-color: #dc3545;
        --live-color-soft: #ff6b6b;
    }

    @@keyframes livePulse {
        0% {
            color: var(--live-color);
            opacity: 0.95;
        }

        100% {
            color: var(--live-color-soft);
            opacity: 1;
        }
    }

    @@keyframes blinkDot {
        0% {
            opacity: .55;
        }

        100% {
            opacity: 1;
        }
    }

    .is-live {
        color: var(--live-color);
        animation: livePulse 1.1s ease-in-out infinite alternate;
    }

    .live-minute.is-live {
        color: var(--live-color);
        font-weight: 700;
        animation: livePulse .9s ease-in-out infinite alternate;
    }

    .is-live::after {
        animation: blinkDot 1s ease-in-out infinite alternate;
    }

    @@media (prefers-reduced-motion: reduce) {
        .is-live, .live-minute.is-live {
            animation: none !important;
        }
    }

    @@media (max-width: 576px) {
        .team {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

            .team.home {
                justify-self: end;
            }

            .team.away {
                justify-self: start;
            }

        .team-logo {
            height: 24px;
            margin-bottom: 2px;
        }

        .team-name {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            max-width: 100%;
            line-height: 1.1;
        }

        .vs-pill {
            font-size: .65rem;
            padding: .08rem .35rem;
        }

        .match-grid {
            row-gap: .35rem;
        }
    }
</style>

@section Scripts {
    <script>
        /**
         * Bootstrap + Live polling dal proxy del widget.
         * - Bootstrap fase 1: chiede solo i match FINITI (FT/AET/PEN) per riempire subito l’anteprima col risultato finale.
         * - Bootstrap fase 2: avvia il polling live (20s) per aggiornare gli eventi in corso.
         * - Inoltra i parametri della pagina (query string) al proxy: massima compat.
         */
        (function () {
          const ENDPOINT = '/api/livescores';
          const BATCH = 20;
          const LIVE_INTERVAL_MS = 20000;
          const LIVE_STATUSES = ['1H','2H','ET','P','BT','LIVE','HT'];
          const FINISHED_STATUSES = ['FT','AET','PEN'];

          // Raccogli tutti gli ID presenti in pagina
          const scoreNodes = document.querySelectorAll('[data-fixture][data-side]');
          const ids = [...new Set([...scoreNodes].map(n => n.getAttribute('data-fixture')).filter(Boolean))];
          if (!ids.length) return;

          // Prendi anche i parametri correnti della pagina (se il backend li sfrutta, li ha)
          const pageParams = new URLSearchParams(window.location.search);

          const chunk = (arr, size) => arr.length ? [arr.slice(0, size), ...chunk(arr.slice(size), size)] : [];

          function applyUpdate(it) {
            const id = String(it.id);
            const homeEl   = document.querySelector(`.home-score[data-fixture="${id}"]`);
            const awayEl   = document.querySelector(`.away-score[data-fixture="${id}"]`);
            const minuteEl = document.querySelector(`.live-minute[data-fixture="${id}"]`);

            // Punteggi (sia live che finali)
            if (homeEl && (it.home ?? it.home === 0)) homeEl.textContent = (it.home ?? '–');
            if (awayEl && (it.away ?? it.away === 0)) awayEl.textContent = (it.away ?? '–');

            const status = (it.status || '').toUpperCase();
            const isLive = LIVE_STATUSES.includes(status);
            const isFinished = FINISHED_STATUSES.includes(status);

            // Minutaggio live
            if (minuteEl) {
              if (isLive) {
                let label = '';
                if (typeof it.elapsed === 'number' && it.elapsed >= 0) label = `${it.elapsed}'`;
                else if (status === 'HT') label = 'HT';

                if (label) { minuteEl.textContent = label; minuteEl.classList.remove('d-none'); }
                else { minuteEl.classList.add('d-none'); }
                minuteEl.classList.add('is-live');
              } else {
                minuteEl.classList.add('d-none');
                minuteEl.classList.remove('is-live');
              }
            }

            const mark = el => { if (!el) return; if (isLive) el.classList.add('is-live'); else el.classList.remove('is-live'); };
            mark(homeEl);
            mark(awayEl);
          }

          async function fetchBatch(batchIds, extraParamsObj) {
            const qs = new URLSearchParams(pageParams);          // parti dai params di pagina
            qs.set('ids', batchIds.join(','));                   // sempre gli ID presenti in DOM

            // Parametri extra suggeriti (se il backend non li supporta, li ignora senza effetti collaterali)
            if (extraParamsObj) {
              for (const [k,v] of Object.entries(extraParamsObj)) qs.set(k, String(v));
            }

            try {
              const res = await fetch(`${ENDPOINT}?${qs.toString()}`, { cache: 'no-store' });
              if (!res.ok) return null;
              return await res.json();
            } catch {
              return null;
            }
          }

          async function fetchAndApplyAll(extraParamsObj) {
            const batches = chunk(ids, BATCH);
            for (const b of batches) {
              const data = await fetchBatch(b, extraParamsObj);
              if (!data) continue;
              for (const it of data) applyUpdate(it);
            }
          }

          // === BOOTSTRAP FASE 1: chiedi esplicitamente i match FINITI per riempire subito i risultati finali
          //   - Proviamo varie chiavi comuni che spesso i proxy accettano. Se non supportate, vengono ignorate.
          fetchAndApplyAll({ includeFinished: 1, status: 'FT,AET,PEN', scope: 'all' })
            .finally(() => {
              // === BOOTSTRAP FASE 2 + POLLING LIVE
              let h = null;
              async function liveTick() { await fetchAndApplyAll({}); }
              function start() { liveTick(); h = setInterval(liveTick, LIVE_INTERVAL_MS); }
              function stop()  { if (h) clearInterval(h); h = null; }

              document.addEventListener('visibilitychange', () => document.hidden ? stop() : start());
              start();
            });
        })();
    </script>
}

@section Styles {
    <text>
        <style>
            body {
                background: linear-gradient(135deg, #252e40 0%, #1a2230 100%);
                color: #e9edf3;
                font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            }

            header .text-center img {
                width: 120px;
                height: auto;
                filter: drop-shadow(0 0 6px rgba(0,195,255,.3));
                margin-top: 15px;
            }

            header, footer {
                background: transparent !important;
                border: none !important;
            }

            footer {
                color: rgba(255,255,255,.6);
            }

            .events-page {
                background: transparent;
                color: #e9edf3;
            }

                .events-page .card,
                .events-page .list-group-item,
                .events-page .dropdown-menu,
                .events-page .modal-content {
                    background: rgba(255,255,255,0.06);
                    border: 1px solid rgba(255,255,255,0.16);
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                    color: #e9edf3;
                }

                .events-page .card-header {
                    background: rgba(255,255,255,0.06);
                    border-bottom: 1px solid rgba(255,255,255,0.14);
                    color: #f4f7fb;
                }

                .events-page .btn-primary {
                    background: #00baff;
                    border-color: #00baff;
                }

                    .events-page .btn-primary:hover {
                        background: #009cdc;
                        border-color: #009cdc;
                    }

                /* --- Fix contrasto select "Filtro Nazione" (testo bianco su sfondo bianco) --- */
                .events-page .form-select {
                    /* forza un vero background scuro anche su Windows/Chrome */
                    background-color: #1f2a3a !important;
                    color: #e9edf3 !important;
                    border: 1px solid rgba(255,255,255,.24) !important;
                }

                    /* Opzioni della tendina: sfondo bianco, testo scuro per leggibilità */
                    .events-page .form-select option {
                        background: #ffffff !important;
                        color: #111111 !important;
                    }

                    /* Quando il select è disabled/focused mantieni il contrasto */
                    .events-page .form-select:focus {
                        border-color: #00c3ff !important;
                        box-shadow: 0 0 0 4px rgba(0,195,255,.18) !important;
                        background-color: #213044 !important;
                        color: #e9edf3 !important;
                    }


                .events-page a {
                    color: #7bd3ff;
                }

                    .events-page a:hover {
                        color: #9be0ff;
                    }

                .events-page .mini-cal-day {
                    background: rgba(255,255,255,.08);
                    color: #f1f5fa;
                    border: 1px solid rgba(255,255,255,.20);
                }

                    .events-page .mini-cal-day:hover {
                        background: rgba(255,255,255,.14);
                    }

                    .events-page .mini-cal-day.is-selected {
                        background: #0d6efd;
                        color: #fff;
                        border-color: #0d6efd;
                        box-shadow: 0 8px 18px rgba(13,110,253,.28);
                    }
        </style>
    </text>
}