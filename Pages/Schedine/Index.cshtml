@page
@model NextStakeWebApp.Pages.Schedine.IndexModel
@using System.Text.RegularExpressions
@using NextStakeWebApp.Helpers
@{
    ViewData["Title"] = "Le mie schedine";
}

@functions{
    private static string CleanMarket(string? market)
    {
        if (string.IsNullOrWhiteSpace(market)) return "";
        // rimuove " (numero)" solo se è a fine stringa
        return Regex.Replace(market.Trim(), @"\s*\(\d+\)\s*$", "");
    }

    private static decimal? CalcTotalOdd(IEnumerable<NextStakeWebApp.Models.BetSelection> sels)
    {
        if (sels == null) return null;
        var list = sels.ToList();
        if (list.Count == 0) return null;

        // Se manca anche UNA quota -> N/D
        if (list.Any(x => !x.Odd.HasValue)) return null;

        decimal total = 1m;
        foreach (var s in list)
            total *= s.Odd!.Value;

        return total;
    }
}

<div class="container py-4">
    <h3 class="mb-3">📌 Le mie schedine</h3>

    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        <div class="alert alert-info">@Model.StatusMessage</div>
    }

    <!-- Toast rapido (auto-hide) per download immagine -->
<div id="slipToast"
     class="position-fixed top-0 start-0 w-100 h-100 align-items-center justify-content-center d-none"
     style="z-index: 9999; background: rgba(0,0,0,0.35);">
    <div class="alert alert-dark m-0 py-3 px-4 d-flex align-items-center gap-2 shadow-lg"
         role="alert"
         style="border-radius:14px;">
        <span class="spinner-border spinner-border-sm"></span>
        <span>📸 Genero immagine…</span>
    </div>
</div>




    <div class="card mb-3">
        <div class="card-body">
            <form method="post" asp-page-handler="CreateDraft" class="d-flex flex-wrap gap-2 align-items-center">
                @Html.AntiForgeryToken()
                <input class="form-control" style="max-width:320px" name="title" placeholder="Titolo multipla (es: Weekend)" />
                <button class="btn btn-primary" type="submit">➕ Crea multipla (bozza)</button>
            </form>
            <small class="text-muted d-block mt-2">
                La “bozza” serve per aggiungere selezioni da più match e poi pubblicarla.
            </small>
        </div>
    </div>

    @if (Model.ActiveItems.Count == 0 && Model.ArchivedItems.Count == 0)
    {
        <div class="text-muted">Non hai ancora creato schedine.</div>
    }
    else
    {
        @* ===================== ATTIVE ===================== *@
        @if (Model.ActiveItems.Count > 0)
        {
            <h5 class="mt-3 mb-2">🟢 Schedine attive</h5>

            foreach (var s in Model.ActiveItems)
            {
                var totalOdd = CalcTotalOdd(s.Selections);

                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div class="d-flex flex-column">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <strong>@(string.IsNullOrWhiteSpace(s.Title) ? $"Schedina #{s.Id}" : s.Title)</strong>
                                <span class="badge bg-secondary ms-1">@s.Type</span>

                                @if (s.IsPublic)
                                {
                                    <span class="badge bg-success ms-1">PUBBLICA</span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark ms-1">PRIVATA</span>
                                }

                                @* Stato risultato *@
                                @if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Win)
                                {
                                    <span class="badge bg-success ms-1">Vincente</span>
                                }
                                else if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Loss)
                                {
                                    <span class="badge bg-danger ms-1">Perdente</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary ms-1">Da assegnare</span>
                                }
                            </div>

                            @if (s.ImportedFromCommunity && !string.IsNullOrWhiteSpace(s.SourceUserId))
                            {
                                Model.SourceAuthorMap.TryGetValue(s.SourceUserId!, out var srcName);
                                <div class="small text-muted">
                                    Salvata da Community • Autore: <strong>@(srcName ?? "Utente")</strong>
                                </div>
                            } 

                            @* Bottoni esito (solo se non assegnato) *@
                            @if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.None)
                            {
                                <div class="mt-2 d-flex gap-2 flex-wrap">
                                    <form method="post" asp-page-handler="SetResult" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="slipId" value="@s.Id" />
                                        <input type="hidden" name="result" value="win" />
                                        <button class="btn btn-success btn-sm text-white" type="submit">
    ✅ Vincente
</button>

                                    </form>

                                    <form method="post" asp-page-handler="SetResult" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="slipId" value="@s.Id" />
                                        <input type="hidden" name="result" value="loss" />
                                        <button class="btn btn-danger btn-sm text-white" type="submit">
    ✖ Perdente
</button>

                                    </form>

                                    <small class="text-muted align-self-center">
                                        Se non assegni l’esito entro 12h dall’inizio dell’ultima partita, verrà archiviata automaticamente.
                                    </small>
                                </div>
                            }
                        </div>

                        <div class="d-flex flex-column align-items-end gap-2">
                            <div class="text-muted small">
                                @s.UpdatedAtUtc.ToRomeTime().ToString("dd/MM/yyyy HH:mm")
                            </div>

<div class="d-flex gap-2">

 @* ✅ SOLO plan=1: scarica PNG (ZIP) *@
@if (User.HasClaim("plan", "1"))
{
<a class="btn btn-dark btn-sm text-white js-slip-image"
   asp-page="/Schedine/Index"
   asp-page-handler="SlipImagePng"
   asp-route-slipId="@s.Id"
   asp-route-page="1">
    📸 Immagine
</a>




}

<form method="post" asp-page-handler="TogglePublic" class="m-0">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@s.Id" />
    @if (!s.ImportedFromCommunity)
    {
<button class="btn btn-primary btn-sm text-white" type="submit">
    @(s.IsPublic ? "Rendi privata" : "Pubblica")
</button>

    }
    else
    {
        <button class="btn btn-outline-secondary btn-sm" type="button" disabled
                title="Schedina salvata dalla Community: non ripubblicabile">
            Non ripubblicabile
        </button>
    }
</form>

<form method="post" asp-page-handler="Delete" class="m-0 js-delete-slip-form" data-confirm-text="Vuoi eliminare questa schedina? L’azione è irreversibile.">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@s.Id" />
    <button class="btn btn-danger btn-sm text-white" type="submit">
    🗑 Elimina
</button>

</form>

</div>


                        </div>
                    </div>

                    <div class="card-body">
<div class="text-muted mb-2">
    Creata: @s.CreatedAtUtc.ToRomeTime().ToString("dd/MM/yyyy HH:mm")
    • Aggiornata: @s.UpdatedAtUtc.ToRomeTime().ToString("dd/MM/yyyy HH:mm")
</div>


                        @if (s.Selections.Count == 0)
                        {
                            <div class="text-muted">Nessuna selezione.</div>
                        }
                        else
                        {
                            <ul class="list-group">
                                @foreach (var sel in s.Selections.OrderByDescending(x => x.Id))
                                {
                                    Model.MatchMap.TryGetValue(sel.MatchId, out var mi);
                                    var outcome = Model.EvaluateSelectionOutcome(sel, mi);

                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>
                                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                                @if (!string.IsNullOrWhiteSpace(mi?.HomeLogo))
                                                {
                                                    <img src="@mi.HomeLogo" alt="@mi.HomeName" style="width:22px;height:22px;object-fit:contain;" />
                                                }
                                                <strong>@(mi?.HomeName ?? $"Match {sel.MatchId}")</strong>

                                                <span class="text-muted">vs</span>

                                                <strong>@(mi?.AwayName ?? "")</strong>
                                                @if (!string.IsNullOrWhiteSpace(mi?.AwayLogo))
                                                {
                                                    <img src="@mi.AwayLogo" alt="@mi.AwayName" style="width:22px;height:22px;object-fit:contain;" />
                                                }

@if (mi?.DateUtc != null)
{
    <span class="text-muted ms-2" style="font-size:0.9em;">
        @mi.DateUtc.Value.ToRomeTime().ToString("dd/MM HH:mm")
    </span>
}


                                                @* ✅ ORDINE: Mercato -> Pick -> Quota -> Stato *@
                                                @if (!string.IsNullOrWhiteSpace(sel.Market))
                                                {
                                                    <span class="ms-2 badge bg-light text-dark">🧩 @CleanMarket(sel.Market)</span>
                                                }

                                                <span class="ms-2 badge bg-light text-dark">
                                                    <strong>Pick:</strong> @sel.Pick
                                                </span>

                                                @if (sel.Odd.HasValue)
                                                {
                                                    <span class="ms-2 badge bg-light text-dark">Quota @sel.Odd.Value.ToString("0.00")</span>
                                                }

                                                @if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Won)
{
    <span class="badge bg-success ms-2">✅ Vinta</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Lost)
{
    <span class="badge bg-danger ms-2">❌ Persa</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Push)
{
    <span class="badge bg-info ms-2">↩️ Rimborso</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.HalfWon)
{
    <span class="badge bg-success ms-2">🟩 Mezza vinta</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.HalfLost)
{
    <span class="badge bg-warning text-dark ms-2">🟧 Mezza persa</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Pending)
{
    <span class="badge bg-secondary ms-2">⏳ In corso</span>
}
else
{
    <span class="badge bg-secondary ms-2">❓ Non valutabile</span>

                                                    <span class="ms-2 d-inline-flex gap-1">
                                                        <form method="post" asp-page-handler="SetSelectionOutcome" class="m-0">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="selectionId" value="@sel.Id" />
                                                            <input type="hidden" name="outcome" value="win" />
                                                            <button class="btn btn-sm btn-outline-success" type="submit">✅</button>
                                                        </form>

                                                        <form method="post" asp-page-handler="SetSelectionOutcome" class="m-0">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="selectionId" value="@sel.Id" />
                                                            <input type="hidden" name="outcome" value="loss" />
                                                            <button class="btn btn-sm btn-outline-danger" type="submit">❌</button>
                                                        </form>

                                                        <form method="post" asp-page-handler="SetSelectionOutcome" class="m-0">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="selectionId" value="@sel.Id" />
                                                            <input type="hidden" name="outcome" value="auto" />
                                                            <button class="btn btn-sm btn-outline-secondary" type="submit">↩️</button>
                                                        </form>
                                                    </span>
                                                }
                                            </div>

                                            @if (!string.IsNullOrWhiteSpace(sel.Note))
                                            {
                                                <div class="text-muted small">📝 @sel.Note</div>
                                            }
                                        </div>

                                        <form method="post" asp-page-handler="RemoveSelection" class="m-0">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="selectionId" value="@sel.Id" />
                                            <button class="btn btn-outline-secondary btn-sm" type="submit">Rimuovi</button>
                                        </form>
                                    </li>
                                }
                            </ul>

                            <div class="d-flex justify-content-end mt-2">
                                @if (totalOdd.HasValue)
                                {
                                    <span class="badge bg-light text-dark">Quota totale: @totalOdd.Value.ToString("0.00")</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Quota totale: N/D</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }

        @* ===================== ARCHIVIATE ===================== *@
        @if (Model.ArchivedItems.Count > 0)
        {
            <h5 class="mt-4 mb-2">📦 Schedine archiviate</h5>

            foreach (var s in Model.ArchivedItems)
            {
                var totalOdd = CalcTotalOdd(s.Selections);

                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <strong>@(string.IsNullOrWhiteSpace(s.Title) ? $"Schedina #{s.Id}" : s.Title)</strong>
                            <span class="badge bg-secondary ms-2">@s.Type</span>

                            @if (s.IsPublic)
                            {
                                <span class="badge bg-success ms-1">PUBBLICA</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark ms-1">PRIVATA</span>
                            }

                            @if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Win)
                            {
                                <span class="badge bg-success ms-1">Vincente</span>
                            }
                            else if (s.Result == NextStakeWebApp.Models.BetSlip.BetSlipResult.Loss)
                            {
                                <span class="badge bg-danger ms-1">Perdente</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary ms-1">Archiviata</span>
                            }

                            @if (s.AutoArchived)
                            {
                                <span class="badge bg-secondary ms-1">Auto</span>
                            }

                            <form method="post"
                                  asp-page-handler="Reopen"
                                  class="d-inline ms-2"
                                  onsubmit="return confirm('Riaprire la schedina? Tornerà tra le attive e l’esito verrà azzerato.');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="slipId" value="@s.Id" />
                                <button class="btn btn-sm btn-outline-warning">
                                    🔄 Riapri
                                </button>
                            </form>
                            @* ✅ SOLO plan=1: scarica PNG (ZIP) *@
@if (User.HasClaim("plan", "1"))
{
<a class="btn btn-dark btn-sm text-white js-slip-image"
   asp-page="/Schedine/Index"
   asp-page-handler="SlipImagePng"
   asp-route-slipId="@s.Id"
   asp-route-page="1">
    📸 Immagine
</a>



}



                            @if (s.ImportedFromCommunity && !string.IsNullOrWhiteSpace(s.SourceUserId))
                            {
                                Model.SourceAuthorMap.TryGetValue(s.SourceUserId!, out var srcName);
                                <div class="small text-muted mt-1">
                                    Salvata da Community • Autore: <strong>@(srcName ?? "Utente")</strong>
                                </div>
                            }
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="text-muted small">
                                Archiviata: @(s.ArchivedAtUtc?.ToRomeTime().ToString("dd/MM/yyyy HH:mm") ?? "-")
                            </div>

                            <form method="post"
                                  asp-page-handler="Reopen"
                                  class="m-0"
                                  onsubmit="return confirm('Riaprire la schedina? Tornerà tra le attive e l’esito verrà azzerato.');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="slipId" value="@s.Id" />
                                <button class="btn btn-sm btn-outline-warning">
                                    🔄 Riapri
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="text-muted mb-2">
                            Creata: @s.CreatedAtUtc.ToRomeTime().ToString("dd/MM/yyyy HH:mm")
• Aggiornata: @s.UpdatedAtUtc.ToRomeTime().ToString("dd/MM/yyyy HH:mm")
                        </div>

                        @if (s.Selections.Count == 0)
                        {
                            <div class="text-muted">Nessuna selezione.</div>
                        }
                        else
                        {
                            <ul class="list-group">
                                @foreach (var sel in s.Selections.OrderByDescending(x => x.Id))
                                {
                                    Model.MatchMap.TryGetValue(sel.MatchId, out var mi);
                                    var outcome = Model.EvaluateSelectionOutcome(sel, mi);

                                    <li class="list-group-item">
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            @if (!string.IsNullOrWhiteSpace(mi?.HomeLogo))
                                            {
                                                <img src="@mi.HomeLogo" alt="@mi.HomeName" style="width:22px;height:22px;object-fit:contain;" />
                                            }
                                            <strong>@(mi?.HomeName ?? $"Match {sel.MatchId}")</strong>

                                            <span class="text-muted">vs</span>

                                            <strong>@(mi?.AwayName ?? "")</strong>
                                            @if (!string.IsNullOrWhiteSpace(mi?.AwayLogo))
                                            {
                                                <img src="@mi.AwayLogo" alt="@mi.AwayName" style="width:22px;height:22px;object-fit:contain;" />
                                            }

                                            @if (mi?.DateUtc != null)
                                            {
                                                <span class="text-muted ms-2" style="font-size:0.9em;">
                                                    @mi.DateUtc.Value.ToRomeTime().ToString("dd/MM HH:mm")
                                                </span>
                                            }

                                            @if (mi?.StatusShort is "FT" or "AET" or "PEN")
                                            {
                                                if (mi.HomeGoal.HasValue && mi.AwayGoal.HasValue)
                                                {
                                                    <span class="badge bg-light text-dark ms-2">
                                                        Risultato: @mi.HomeGoal - @mi.AwayGoal
                                                    </span>
                                                }
                                            }

                                            @if (!string.IsNullOrWhiteSpace(sel.Market))
                                            {
                                                <span class="ms-2 badge bg-light text-dark">🧩 @CleanMarket(sel.Market)</span>
                                            }

                                            <span class="ms-2 badge bg-light text-dark">
                                                <strong>Pick:</strong> @sel.Pick
                                            </span>

                                            @if (sel.Odd.HasValue)
                                            {
                                                <span class="ms-2 badge bg-light text-dark">Quota @sel.Odd.Value.ToString("0.00")</span>
                                            }

                                            @if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Won)
{
    <span class="badge bg-success ms-2">✅ Vinta</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Lost)
{
    <span class="badge bg-danger ms-2">❌ Persa</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Push)
{
    <span class="badge bg-info ms-2">↩️ Rimborso</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.HalfWon)
{
    <span class="badge bg-success ms-2">🟩 Mezza vinta</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.HalfLost)
{
    <span class="badge bg-warning text-dark ms-2">🟧 Mezza persa</span>
}
else if (outcome == NextStakeWebApp.Pages.Schedine.IndexModel.SelectionOutcome.Pending)
{
    <span class="badge bg-secondary ms-2">⏳ In corso</span>
}
else
{
    <span class="badge bg-secondary ms-2">❓ Non valutabile</span>
                                            }
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(sel.Note))
                                        {
                                            <div class="text-muted small mt-1">📝 @sel.Note</div>
                                        }
                                    </li>
                                }
                            </ul>

                            <div class="d-flex justify-content-end mt-2">
                                @if (totalOdd.HasValue)
                                {
                                    <span class="badge bg-light text-dark">Quota totale: @totalOdd.Value.ToString("0.00")</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Quota totale: N/D</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }

</div>
<!-- ✅ MODALE CONFERMA ELIMINAZIONE SCHEDINA -->
<div class="modal fade" id="deleteSlipModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px;">
      <div class="modal-header">
        <h5 class="modal-title">🗑 Eliminare schedina?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex gap-3 align-items-start">
          <div class="flex-shrink-0">
            <div class="rounded-circle d-flex align-items-center justify-content-center"
                 style="width:44px;height:44px;background:rgba(220,38,38,.15);">
              <span style="font-size:20px;">⚠️</span>
            </div>
          </div>
          <div>
            <div id="deleteSlipText" class="fw-semibold">
              Vuoi eliminare questa schedina? L’azione è irreversibile.
            </div>
            <div class="text-muted small mt-1">
              Verranno rimosse anche tutte le selezioni collegate.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-danger" id="deleteSlipConfirmBtn">
          🗑 Elimina
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toast = document.getElementById("slipToast");

  function showToastOnce() {
    if (!toast) return;

    toast.classList.remove("d-none");
    toast.classList.add("d-flex");

    setTimeout(() => {
      toast.classList.remove("d-flex");
      toast.classList.add("d-none");
    }, 1000);
  }

  document.addEventListener("click", (e) => {
    const a = e.target.closest("a");
    if (!a) return;

    const href = a.getAttribute("href") || "";
    if (href.includes("handler=SlipImagePng")) {
      showToastOnce();
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById("deleteSlipModal");
  if (!modalEl) return;

  const bsModal = new bootstrap.Modal(modalEl);
  const confirmBtn = document.getElementById("deleteSlipConfirmBtn");
  const textEl = document.getElementById("deleteSlipText");

  let formToSubmit = null;

  document.querySelectorAll(".js-delete-slip-form").forEach(form => {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      formToSubmit = form;

      const msg = form.getAttribute("data-confirm-text");
      if (textEl && msg) textEl.textContent = msg;

      bsModal.show();
    });
  });

  confirmBtn.addEventListener("click", () => {
    if (!formToSubmit) return;
    bsModal.hide();
    formToSubmit.submit();
  });
});
</script>
