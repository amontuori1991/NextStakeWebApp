@page "/Match/Details"

@model NextStakeWebApp.Pages.Match.DetailsModel
@{
    ViewData["Title"] = "Dettaglio Match";
}

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
            @if (!string.IsNullOrWhiteSpace(Model.Data.LeagueLogo))
            {
                <img src="@Model.Data.LeagueLogo" alt="logo lega" style="height:22px;width:auto;" />
            }
            <h5 class="mb-0">@Model.Data.LeagueName</h5>
            @if (!string.IsNullOrWhiteSpace(Model.Data.CountryName))
            {
                <span class="badge bg-light text-dark">@Model.Data.CountryName</span>
            }
        </div>

        <div class="text-muted">
            @Model.Data.KickoffUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <!-- Testata squadre + risultato (placeholder) -->
    <div class="card mb-3">
        <div class="card-body d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                @if (!string.IsNullOrWhiteSpace(Model.Data.HomeLogo))
                {
                    <img src="@Model.Data.HomeLogo" alt="home" style="height:38px;width:auto;" />
                }
                <strong>@Model.Data.Home</strong>
            </div>

            <div class="text-center">
                <div class="h4 mb-0">— : —</div>
                <small class="text-muted">risultato</small>
            </div>

            <div class="d-flex align-items-center gap-2">
                <strong>@Model.Data.Away</strong>
                @if (!string.IsNullOrWhiteSpace(Model.Data.AwayLogo))
                {
                    <img src="@Model.Data.AwayLogo" alt="away" style="height:38px;width:auto;" />
                }
            </div>
        </div>
    </div>

    <!-- Azioni -->
    <div class="mb-3 d-flex gap-2">
        <form method="post" action="/Match/Details?handler=ToggleFavorite&id=@Model.Data.MatchId">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn @(Model.Data.IsFavorite ? "btn-warning" : "btn-outline-secondary")">⭐ Preferito</button>
        </form>
        <a class="btn btn-outline-secondary" href="/Events">← Torna agli eventi</a>
    </div>
<!-- Tabs contenuti -->
<ul class="nav nav-tabs" id="matchTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-picks" type="button" role="tab">
            Pronostici consigliati
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h" type="button" role="tab">
            Stato di forma (ultime 5)
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button" role="tab">
            Classifica
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-exchange-tab" data-bs-toggle="tab" data-bs-target="#tab-exchange" type="button" role="tab">Exchange</button>
    </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h-all" type="button" role="tab">
                H2H
            </button>
        </li>

</ul>

<div class="tab-content border-start border-end border-bottom p-3">
    <div class="tab-pane fade show active" id="tab-picks" role="tabpanel">
        @if (Model.Data.Prediction is null)
        {
            <div class="text-muted">Nessun pronostico disponibile.</div>
        }
        else
        {
            var p = Model.Data.Prediction;
            <div class="row g-3">
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Esito</strong></span><span>@p.Esito</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>GG/NG</strong></span><span>@p.GG_NG</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Over/Under</strong></span><span>@p.OverUnderRange</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Combo</strong></span><span>@p.ComboFinale</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Goal simulati</strong></span>
                            <span>@p.GoalSimulatoCasa - @p.GoalSimulatoOspite (Tot: @p.TotaleGoalSimulati)</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>% Over 1.5</strong></span><span>@p.Over1_5%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>% Over 2.5</strong></span><span>@p.Over2_5%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>% Over 3.5</strong></span><span>@p.Over3_5%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Multigoal Casa</strong></span><span>@p.MultigoalCasa</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><strong>Multigoal Ospite</strong></span><span>@p.MultigoalOspite</span>
                        </li>
                    </ul>
                </div>
            </div>
        }
    </div>
        <div class="tab-pane fade" id="tab-h2h-all" role="tabpanel">
            @if (Model.Data.HeadToHead.Count == 0)
            {
                <div class="text-muted">Nessun testa a testa trovato tra queste squadre.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                        <thead>
                            <tr>
                                <th style="width:110px;">Data</th>
                                <th>Lega</th>
                                <th>Match</th>
                                <th class="text-center">Risultato</th>
                                <th style="width:100px;" class="text-end">Apri</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in Model.Data.HeadToHead)
                            {
                                <tr>
                                    <td>@r.DateUtc.ToLocalTime().ToString("dd/MM/yyyy")</td>
                                    <td>@r.LeagueName</td>
                                    <td>
                                        <strong>@r.HomeName</strong> – <strong>@r.AwayName</strong>
                                    </td>
                                    <td class="text-center">@r.Score</td>
                                    <td class="text-end">
                                        <a class="btn btn-sm btn-outline-primary" href="/Match/Details?id=@r.MatchId">Apri</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

    <div class="tab-pane fade" id="tab-h2h" role="tabpanel">
        <div class="row g-3">
            <div class="col-md-6">
                <h6 class="mb-2">Forma @Model.Data.Home</h6>
                @if (Model.Data.HomeForm.Count == 0)
                {
                    <div class="text-muted">Nessun dato.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var m in Model.Data.HomeForm)
                        {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">

                                <div>
                                    <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                    <span class="ms-2">@m.Opponent</span>
                                    <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span>@m.Score</span>
                                    @if (m.Result == "W")
                                    {
                                        <span class="badge bg-success">W</span>
                                        ;
                                    }
                                    else if (m.Result == "D")
                                    {

                                        <span class="badge bg-secondary">D</span>
                                        ;
                                    }
                                    else
                                    {

                                        <span class="badge bg-danger">L</span>
                                        ;
                                    }
                                </div>
                            </a>
                        }
                    </div>
                }
            </div>

            <div class="col-md-6">
                <h6 class="mb-2">Forma @Model.Data.Away</h6>
                @if (Model.Data.AwayForm.Count == 0)
                {
                    <div class="text-muted">Nessun dato.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var m in Model.Data.AwayForm)
                        {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                    <span class="ms-2">@m.Opponent</span>
                                    <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span>@m.Score</span>
                                    @if (m.Result == "W")
                                    {
                                        <span class="badge bg-success">W</span>
                                        ;
                                    }
                                    else if (m.Result == "D")
                                    {

                                        <span class="badge bg-secondary">D</span>
                                        ;
                                    }
                                    else
                                    {

                                        <span class="badge bg-danger">L</span>
                                        ;
                                    }
                                </div>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-table" role="tabpanel">
        @if (Model.Data.Standings.Count == 0)
        {
            <div class="text-muted">Classifica non disponibile per questa lega/stagione.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Squadra</th>
                            <th class="text-center">Punti</th>
                            <th class="text-center">G</th>
                            <th class="text-center">V</th>
                            <th class="text-center">N</th>
                            <th class="text-center">P</th>
                            <th class="text-center">GF</th>
                            <th class="text-center">GA</th>
                            <th class="text-center">Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in Model.Data.Standings)
                        {
                            var isHome = s.TeamId == Model.Data.HomeId;
                            var isAway = s.TeamId == Model.Data.AwayId;
                            var rowClass = isHome ? "table-success" : (isAway ? "table-danger" : "");

                            <tr class="@rowClass">
                                <td>@s.Rank</td>
                                <td>@s.TeamName</td>
                                <td class="text-center fw-bold">@s.Points</td>
                                <td class="text-center">@s.Played</td>
                                <td class="text-center">@s.Win</td>
                                <td class="text-center">@s.Draw</td>
                                <td class="text-center">@s.Lose</td>
                                <td class="text-center">@s.GF</td>
                                <td class="text-center">@s.GA</td>
                                <td class="text-center">@s.Diff</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div class="tab-pane fade" id="tab-exchange" role="tabpanel">
        @if (Model.Data.Exchange is null)
        {
            <div class="text-muted">Nessun dato Exchange disponibile.</div>
        }
        else
        {
            var e = Model.Data.Exchange;
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between">
                    <span><strong>Bancata consigliata</strong></span><span>@e.BancataConsigliata</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Banca 1 – Affidabilità</span><span>@e.Banca1Affidabilita%</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Banca X – Affidabilità</span><span>@e.BancaXAffidabilita%</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Banca 2 – Affidabilità</span><span>@e.Banca2Affidabilita%</span>
                </li>
                <li class="list-group-item"><strong>Top lay risultati esatti:</strong> @e.BancaRisultato1, @e.BancaRisultato2, @e.BancaRisultato3</li>
            </ul>
        }
    </div>

</div>
