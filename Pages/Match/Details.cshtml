@page "/Match/Details"
@model NextStakeWebApp.Pages.Match.DetailsModel
@using System.Text.Json
@using System.Text.Encodings.Web
@using System.Text.Unicode

@{
    ViewData["Title"] = "Dettaglio Match";
}
<div class="details-page">

<div class="container py-4">
    @* Messaggio di stato (TempData) *@
    @if (TempData["StatusMessage"] is string sm && !string.IsNullOrWhiteSpace(sm))
    {
        <div class="alert alert-info d-flex align-items-center gap-2">
            <span>ℹ️</span><span>@sm</span>
        </div>
    }

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
            @if (!string.IsNullOrWhiteSpace(Model.Data.LeagueLogo))
            {
                <img src="@Model.Data.LeagueLogo" alt="logo lega" style="height:22px;width:auto;" />
            }
            <h5 class="mb-0">@Model.Data.LeagueName</h5>
            @if (!string.IsNullOrWhiteSpace(Model.Data.CountryName))
            {
                <span class="badge bg-light text-dark">@Model.Data.CountryName</span>
            }
        </div>

        <div class="text-muted">
            @Model.Data.KickoffUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <!-- Match Widget (API-SPORTS) -->
    <div class="card mb-3">
        <div class="card-body">
            <api-sports-widget data-type="config"
                               data-key="9146b11baf44d94af6e14d347213d63a"
                               data-sport="football"
                               data-lang="it"
                               data-theme="white"
                               data-show-logos="true">
            </api-sports-widget>

            <api-sports-widget data-type="game"
                               data-game-id="@Model.Data.MatchId"
                               data-show-logos="true">
            </api-sports-widget>

            <noscript class="text-muted">
                Abilita JavaScript per visualizzare il widget della partita.
            </noscript>
        </div>
    </div>
        <script>
            (function () {
              function get(id){ return document.getElementById(id); }

              function showOverlay(message) {
                const overlay = get('aiLoadingOverlay');
                const msgEl   = get('aiLoadingMessage');
                if (!overlay) return;
                if (msgEl && message) msgEl.textContent = message;
                overlay.classList.remove('d-none');
              }

              function hideOverlay() {
                const overlay = get('aiLoadingOverlay');
                overlay?.classList.add('d-none');
              }

              document.addEventListener('submit', function (e) {
                const form = e.target.closest('form[data-loading]');
                if (!form) return;

                const kind = form.getAttribute('data-loading');
                if (kind === 'preview-ai') {
                  showOverlay('Generazione anteprima pronostico AI…');
                } else if (kind === 'send-ai') {
                  showOverlay('Invio pronostico AI su Telegram…');
                } else {
                  showOverlay('Caricamento…');
                }
              });

              window.addEventListener('pageshow', hideOverlay);
            })();
        </script>


    @{
            var aiPayloadObj = new
            {
                matchId = Model.Data.MatchId,
                leagueId = Model.Data.LeagueId,
                season = Model.Data.Season,
                home = Model.Data.Home,
                away = Model.Data.Away,

                // Statistiche analisi
                goals = Model.Data.Goals?.Metrics,
                shots = Model.Data.Shots?.Metrics,
                corners = Model.Data.Corners?.Metrics,
                fouls = Model.Data.Fouls?.Metrics,
                cards = Model.Data.Cards?.Metrics,
                offsides = Model.Data.Offsides?.Metrics,

                // 🔥 Pronostico proprietario
                prediction = new
                {
                    esito = Model.Data.Prediction?.Esito,
                    ggNg = Model.Data.Prediction?.GG_NG,
                    overUnder = Model.Data.Prediction?.OverUnderRange,
                    combo = Model.Data.Prediction?.ComboFinale,
                    goalSimCasa = Model.Data.Prediction?.GoalSimulatoCasa,
                    goalSimOspite = Model.Data.Prediction?.GoalSimulatoOspite
                }
            };


        // Encoder “safe” che non scappa i caratteri latini/italiani
        var aiPayloadJson = JsonSerializer.Serialize(
        aiPayloadObj,
        new JsonSerializerOptions
        {
            Encoder = JavaScriptEncoder.Create(UnicodeRanges.BasicLatin, UnicodeRanges.Latin1Supplement, UnicodeRanges.LatinExtendedA)
        }
        );
    }

    <!-- Azioni -->
    <div class="mb-3 d-flex gap-2">
        <form method="post" action="/Match/Details?handler=ToggleFavorite&id=@Model.Data.MatchId">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn @(Model.Data.IsFavorite ? "btn-warning" : "btn-outline-secondary")">⭐ Preferito</button>
        </form>

        <a class="btn btn-outline-secondary" href="/Events">← Torna agli eventi</a>

            @* === NUOVO: bottone AI pronostico (solo Admin/SuperAdmin) *@
            @{
                bool canUseAi = User.HasClaim(c =>
                (string.Equals(c.Type, "plan", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(c.Type, "Plan", StringComparison.OrdinalIgnoreCase)) &&
                string.Equals((c.Value ?? "").Trim(), "1", StringComparison.Ordinal));
            }
            @if (canUseAi)

            {
                <form method="post" asp-page-handler="PreviewAiPick" class="ms-auto" id="aiPreviewForm" data-loading="preview-ai">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Data.MatchId" />
                    <textarea name="analysisPayload" hidden>@aiPayloadJson</textarea>
                    <button type="submit" class="btn btn-primary">
                        🤖 Genera anteprima (AI)
                    </button>
                </form>

            }

        

    </div>
    @* ANTEPRIMA AI (se presente in TempData) *@
    @if (TempData["AiPreview"] is string aiPrev && !string.IsNullOrWhiteSpace(aiPrev))
    {
        <div class="card border-success mb-3">
            <div class="card-header bg-success text-white">Anteprima messaggio (AI)</div>
            <div class="card-body">
                <div class="mb-3">
                    @* Mostra come HTML Telegram (abbiamo usato <b>, <em>, ecc.) *@
                    @Html.Raw(aiPrev.Replace("\n", "<br/>"))
                </div>

                    <form method="post" asp-page-handler="SendAiPick" class="d-flex gap-2" id="aiSendForm" data-loading="send-ai">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                        <input type="hidden" name="preview" value="@aiPrev" />
                        <button type="submit" class="btn btn-success">🚀 Invia su Telegram (Idee)</button>
                        <a class="btn btn-outline-secondary" href="/Match/Details?id=@Model.Data.MatchId">Annulla</a>
                    </form>
            </div>
        </div>
    }


    <!-- Selettore gruppi -->
    <div class="d-flex justify-content-center">
        <div class="btn-group mb-2" role="group" aria-label="Selettore gruppi tab">
            <button id="btnGroupPron" type="button" class="btn btn-primary">Pronostici</button>
            <button id="btnGroupAnal" type="button" class="btn btn-outline-primary">Analisi</button>
        </div>
    </div>
    <div class="text-center text-danger fw-bold mb-3">
        GIORNATE MANCANTI: @Model.Data.RemainingMatches
    </div>

    <!-- Tabs contenuti -->
    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <!-- Gruppo: PRONOSTICI -->
        <li class="nav-item group-pron">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-picks" type="button" role="tab">
                Pronostici consigliati
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h" type="button" role="tab">
                Stato di forma (ultime 5)
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button" role="tab">
                Classifica
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" id="tab-exchange-tab" data-bs-toggle="tab" data-bs-target="#tab-exchange" type="button" role="tab">
                Exchange
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h-all" type="button" role="tab">
                H2H
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-odds" type="button" role="tab">
                Quote
            </button>
        </li>

        <!-- Gruppo: ANALISI -->
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-shots" type="button" role="tab">
                Tiri
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-fouls" type="button" role="tab">
                Falli
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cards" type="button" role="tab">
                Cartellini
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-offsides" type="button" role="tab">
                Fuorigioco
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-goals" type="button" role="tab">
                Goal Attesi
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-corners" type="button" role="tab">
                Corner
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-club" type="button" role="tab">
                Statistiche Club
            </button>
        </li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3">
        <!-- PRONOSTICI: Pronostici consigliati -->
        <div class="tab-pane fade show active" id="tab-picks" role="tabpanel">
            @if (Model.Data.Prediction is null)
            {
                <div class="text-muted">Nessun pronostico disponibile.</div>
            }
            else
            {
                var p = Model.Data.Prediction;
                <div class="row g-3">
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Esito</strong></span><span>@p.Esito</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>GG/NG</strong></span><span>@p.GG_NG</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Over/Under</strong></span><span>@p.OverUnderRange</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Combo</strong></span><span>@p.ComboFinale</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span><strong>Goal simulati</strong></span>
                                <span>@p.GoalSimulatoCasa - @p.GoalSimulatoOspite (Tot: @p.TotaleGoalSimulati)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 1.5</strong></span><span>@p.Over1_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 2.5</strong></span><span>@p.Over2_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 3.5</strong></span><span>@p.Over3_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Multigoal Casa</strong></span><span>@p.MultigoalCasa</span></li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>Multigoal Ospite</strong></span><span>@p.MultigoalOspite</span>
                                </li>
                        </ul>
                    </div>
                </div>

                    @if (User.HasClaim("plan", "1"))
                    {
                        <form method="post" asp-page-handler="SendPrediction" class="mt-3">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Data.MatchId" />
                            <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                            <div class="row g-2 align-items-end">
                                <div class="col-md-8">
                                    <label class="form-label">Pronostico Consigliato (modificabile prima dell'invio)</label>
                                    <input name="customPick" class="form-control" value="@Model.Data.Prediction?.ComboFinale" />
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                                </div>
                            </div>
                        </form>
                    }
                }
        </div>

        <!-- PRONOSTICI: H2H (tutti) -->
        <div class="tab-pane fade" id="tab-h2h-all" role="tabpanel">
            <div class="card card-body text-center">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true">
                </api-sports-widget>

                <api-sports-widget data-type="h2h"
                                   data-h2h="@Model.Data.HomeId-@Model.Data.AwayId"
                                   data-show-logos="true">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare il widget H2H.
                </noscript>
            </div>
        </div>

        <!-- TAB: Statistiche Club -->
        <div class="tab-pane fade" id="tab-club" role="tabpanel">
            <div class="card card-body">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true"
                                   data-team-statistics="true">
                </api-sports-widget>

                <h5 class="text-center mt-3 mb-3 text-primary fw-bold">@Model.Data.Home</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.HomeId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <hr class="my-4" />

                <h5 class="text-center mt-3 mb-3 text-danger fw-bold">@Model.Data.Away</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.AwayId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare le informazioni dettagliate delle squadre.
                </noscript>
            </div>
        </div>

            <!-- ANALISI: Goal Attesi -->
            <div class="tab-pane fade" id="tab-goals" role="tabpanel">
                @if (Model.Data.Goals is null || Model.Data.Goals.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi goal disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Goals.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        // Etichette "parlanti" tipiche per xG (fallback: chiave originale)
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["xG"] = "xG medio (expected goals)",
                            ["xGA"] = "xGA medio (expected goals concessi)",
                            ["NPxG"] = "NPxG medio (senza rigori)",
                            ["In Casa"] = "xG medio in casa",
                            ["Fuoricasa"] = "xG medio in trasferta",
                            ["Ultime 5"] = "xG medio (ultime 5 partite)",
                            ["Partite Vinte"] = "xG medio nelle partite vinte",
                            ["Partite Pareggiate"] = "xG medio nelle partite pareggiate",
                            ["Partite Perse"] = "xG medio nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        // Ordine: xG, xGA, NPxG, poi contesti
                        string[] desiredOrder = { "xG", "xGA", "NPxG", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


        <!-- PRONOSTICI: Stato di forma -->
        <div class="tab-pane fade" id="tab-h2h" role="tabpanel">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Home</h6>
                    @if (Model.Data.HomeForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.HomeForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>;
                                        }
                                        else if (m.Result == "D")
                                        {
                                            <span class="badge bg-secondary">D</span>;
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">L</span>;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>

                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Away</h6>
                    @if (Model.Data.AwayForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.AwayForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>;
                                        }
                                        else if (m.Result == "D")
                                        {
                                            <span class="badge bg-secondary">D</span>;
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">L</span>;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

            <!-- PRONOSTICI: Classifica (SOLO WIDGET) -->
            <div class="tab-pane fade" id="tab-table" role="tabpanel">
                <div class="card card-body">
                    <api-sports-widget data-type="config"
                                       data-key="9146b11baf44d94af6e14d347213d63a"
                                       data-sport="football"
                                       data-lang="it"
                                       data-theme="grey"
                                       data-show-logos="true"
                                       data-standings="true">
                    </api-sports-widget>

                    <api-sports-widget data-type="standings"
                                       data-league="@Model.Data.LeagueId"
                                       data-season="@Model.Data.Season">
                    </api-sports-widget>

                    <noscript class="text-muted">
                        Abilita JavaScript per visualizzare la classifica del widget.
                    </noscript>
                </div>
            </div>




        <!-- PRONOSTICI: Quote (placeholder) -->
        <div class="tab-pane fade" id="tab-odds" role="tabpanel">
            <div class="alert alert-secondary">
                <div class="d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                    <strong>Quote</strong>: integrazione in arrivo. Qui mostreremo le quote dei bookmaker.
                </div>
            </div>
        </div>

            <!-- ANALISI: Corner -->
            <div class="tab-pane fade" id="tab-corners" role="tabpanel">
                @if (Model.Data.Corners is null || Model.Data.Corners.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi corner disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Corners.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead>
                                    <tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["Battuti"] = "Media corner battuti",
                            ["Effettuati"] = "Media corner a favore",
                            ["Subiti"] = "Media corner concessi",
                            ["In Casa"] = "Media corner a favore in casa",
                            ["Fuoricasa"] = "Media corner a favore in trasferta",
                            ["Ultime 5"] = "Media corner (ultime 5 partite)",
                            ["Partite Vinte"] = "Media corner nelle partite vinte",
                            ["Partite Pareggiate"] = "Media corner nelle partite pareggiate",
                            ["Partite Perse"] = "Media corner nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


            <!-- ANALISI: Cartellini -->
            <div class="tab-pane fade" id="tab-cards" role="tabpanel">
                @if (Model.Data.Cards is null || Model.Data.Cards.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi cartellini disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Cards.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["Fatti"] = "Media cartellini ottenuti",
                            ["Gialli"] = "Media cartellini gialli",
                            ["Rossi"] = "Media cartellini rossi",
                            ["Effettuati"] = "Media cartellini a favore",
                            ["Subiti"] = "Media cartellini avversari",
                            ["In Casa"] = "Media cartellini a favore in casa",
                            ["Fuoricasa"] = "Media cartellini a favore in trasferta",
                            ["Ultime 5"] = "Media cartellini (ultime 5 partite)",
                            ["Partite Vinte"] = "Media cartellini nelle partite vinte",
                            ["Partite Pareggiate"] = "Media cartellini nelle partite pareggiate",
                            ["Partite Perse"] = "Media cartellini nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        string[] desiredOrder = { "Gialli", "Rossi", "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


            <!-- ANALISI: Falli -->
            <div class="tab-pane fade" id="tab-fouls" role="tabpanel">
                @if (Model.Data.Fouls is null || Model.Data.Fouls.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi falli disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Fouls.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["Effettuati"] = "Media falli commessi",
                            ["Fatti"] = "Media falli commessi",
                            ["Subiti"] = "Media falli subiti",
                            ["In Casa"] = "Media falli commessi in casa",
                            ["Fuoricasa"] = "Media falli commessi in trasferta",
                            ["Ultime 5"] = "Media falli (ultime 5 partite)",
                            ["Partite Vinte"] = "Media falli nelle partite vinte",
                            ["Partite Pareggiate"] = "Media falli nelle partite pareggiate",
                            ["Partite Perse"] = "Media falli nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


            <!-- ANALISI: Fuorigioco -->
            <div class="tab-pane fade" id="tab-offsides" role="tabpanel">
                @if (Model.Data.Offsides is null || Model.Data.Offsides.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi fuorigioco disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Offsides.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["Fatti"] = "Media fuorigioco commessi",
                            ["Effettuati"] = "Media fuorigioco commessi",
                            ["Subiti"] = "Media fuorigioco avversari",
                            ["In Casa"] = "Media fuorigioco commessi in casa",
                            ["Fuoricasa"] = "Media fuorigioco commessi in trasferta",
                            ["Ultime 5"] = "Media fuorigioco (ultime 5 partite)",
                            ["Partite Vinte"] = "Media fuorigioco nelle partite vinte",
                            ["Partite Pareggiate"] = "Media fuorigioco nelle partite pareggiate",
                            ["Partite Perse"] = "Media fuorigioco nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


            <!-- ANALISI: Tiri -->
            <div class="tab-pane fade" id="tab-shots" role="tabpanel">
                @if (Model.Data.Shots is null || Model.Data.Shots.Metrics.Count == 0)
                {
                    <div class="text-muted">Nessuna analisi tiri disponibile.</div>
                }
                else
                {
                    var metrics = Model.Data.Shots.Metrics;

                    bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                    );

                    if (!hasSides)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th style="width:60%;">Metrica</th>
                                        <th class="text-end">Valore</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        // Mappa etichette "più parlanti"
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["Effettuati"] = "Media tiri effettuati",
                            ["Subiti"] = "Media tiri subiti",
                            ["In Casa"] = "Media tiri effettuati in casa",
                            ["Fuoricasa"] = "Media tiri effettuati in trasferta",
                            ["Ultime 5"] = "Media tiri (ultime 5 partite)",
                            ["Partite Vinte"] = "Media tiri nelle partite vinte",
                            ["Partite Pareggiate"] = "Media tiri nelle partite pareggiate",
                            ["Partite Perse"] = "Media tiri nelle partite perse"
                        };

                        var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                        g => g.Key,
                        g => new
                        {
                            Casa = g.FirstOrDefault(i =>
                                    string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                                    string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                            Ospite = g.FirstOrDefault(i =>
                                    string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                                    string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                        },
                        StringComparer.OrdinalIgnoreCase
                        );

                        // Ordine preferito (se non presente, vanno in coda in ordine alfabetico)
                        string[] desiredOrder = new[] {
                                "Effettuati","Subiti","In Casa","Fuoricasa",
                                "Ultime 5","Partite Vinte","Partite Pareggiate","Partite Perse"
                                };

                        var orderedKeys = groups.Keys
                        .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                        .ThenBy(k => k);

                        // Nomi squadre al posto di "Casa/Ospite"
                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        <div class="vstack gap-3">
                            @foreach (var key in orderedKeys)
                            {
                                var row = groups[key];
                                var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                                <div class="mb-2">
                                    <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                    <div class="row g-2 pt-2">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded d-flex justify-content-between">
                                                <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>


        <!-- PRONOSTICI: Exchange -->
        <div class="tab-pane fade" id="tab-exchange" role="tabpanel">
            @if (Model.Data.Exchange is null)
            {
                <div class="text-muted">Nessun dato Exchange disponibile.</div>
            }
            else
            {
                var e = Model.Data.Exchange;

                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Bancata consigliata</strong></span><span>@e.BancataConsigliata</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 1 – Affidabilità</span><span>@e.Banca1Affidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca X – Affidabilità</span><span>@e.BancaXAffidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 2 – Affidabilità</span><span>@e.Banca2Affidabilita%</span></li>
                    <li class="list-group-item"><strong>Top lay risultati esatti:</strong> @e.BancaRisultato1, @e.BancaRisultato2, @e.BancaRisultato3</li>
                </ul>

                    @if (canUseAi || User.IsInRole("SuperAdmin"))

                {
                    string? best1x2 = null;
                    if (e is not null)
                    {
                        var items = new List<(string key, int? val)>
                        { ("1", e.Banca1Affidabilita), ("X", e.BancaXAffidabilita), ("2", e.Banca2Affidabilita) };

                        var best = items.Where(i => i.val.HasValue)
                        .OrderByDescending(i => i.val!.Value)
                        .FirstOrDefault();

                        if (best.val.HasValue) best1x2 = best.key;
                    }

                    <form method="post" asp-page-handler="SendExchange" class="mt-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                        <input type="hidden" name="topicName" value="ExchangeDaPubblicare" />

                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Bancata consigliata</label>
                                <select name="customLay" class="form-select">
                                    <option value="">-- Seleziona --</option>
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato1))
                                    {
                                        <option value="@e.BancaRisultato1">@e.BancaRisultato1</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato2))
                                    {
                                        <option value="@e.BancaRisultato2">@e.BancaRisultato2</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato3))
                                    {
                                        <option value="@e.BancaRisultato3">@e.BancaRisultato3</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(best1x2))
                                    {
                                        <option value="@best1x2">@best1x2</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Livello di rischio</label>
                                <select name="riskLevel" class="form-select">
                                    <option value="Basso">Basso</option>
                                    <option value="Medio">Medio</option>
                                    <option value="Alto">Alto</option>
                                </select>
                            </div>

                            <div class="col-md-3 text-end">
                                <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                            </div>
                        </div>
                    </form>
                }
            }
        </div>
    </div>

    <!-- Script per gruppi -->
    <script>
        (function () {
            const btnPron = document.getElementById('btnGroupPron');
            const btnAnal = document.getElementById('btnGroupAnal');
            const tabsUl  = document.getElementById('matchTabs');

            function showGroup(group) {
                tabsUl.querySelectorAll('.group-pron').forEach(li => li.classList.toggle('d-none', group !== 'pron'));
                tabsUl.querySelectorAll('.group-anal').forEach(li => li.classList.toggle('d-none', group !== 'anal'));

                if (group === 'pron') {
                    btnPron.classList.add('btn-primary'); btnPron.classList.remove('btn-outline-primary');
                    btnAnal.classList.add('btn-outline-primary'); btnAnal.classList.remove('btn-primary');
                } else {
                    btnAnal.classList.add('btn-primary'); btnAnal.classList.remove('btn-outline-primary');
                    btnPron.classList.add('btn-outline-primary'); btnPron.classList.remove('btn-primary');
                }

                const activeBtn = tabsUl.querySelector('.nav-link.active');
                const activeLi  = activeBtn ? activeBtn.closest('li') : null;
                const activeIsInGroup = activeLi && !activeLi.classList.contains('d-none');

                if (!activeIsInGroup) {
                    const firstVisible = tabsUl.querySelector(group === 'pron' ? '.group-pron .nav-link' : '.group-anal .nav-link');
                    if (firstVisible) firstVisible.click();
                }
            }

            btnPron?.addEventListener('click', () => showGroup('pron'));
            btnAnal?.addEventListener('click', () => showGroup('anal'));

            document.addEventListener('DOMContentLoaded', () => showGroup('pron'));
        })();
    </script>


    </div>
    <!-- Overlay caricamento AI -->
    <div id="aiLoadingOverlay" class="loading-overlay d-none" aria-hidden="true">
        <div class="loading-panel">
            <div class="spinner-border" role="status" aria-label="Caricamento"></div>
            <div id="aiLoadingMessage" class="fw-semibold">Caricamento…</div>
        </div>
    </div>

    @section Scripts {
        <script type="module" src="https://widgets.api-sports.io/3.1.0/widgets.js"></script>
    }
</div>
@section Styles {
    <text>
        <style>
            /* Stile generale (preso dal Layout) */
            body {
                background: linear-gradient(135deg, #252e40 0%, #1a2230 100%);
                color: #e9edf3;
                font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            }

            /* Card/list nel tema scuro */
            .details-page .card,
            .details-page .list-group-item,
            .details-page .dropdown-menu,
            .details-page .modal-content {
                background: rgba(255,255,255,0.06);
                border: 1px solid rgba(255,255,255,0.16);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                color: #e9edf3;
            }

            .details-page .card-header {
                background: rgba(255,255,255,0.06);
                border-bottom: 1px solid rgba(255,255,255,0.14);
            }

            /* 🛑 CORREZIONE FILTRI/OPACITÀ SUI CONTENITORI (Neutralizzazione) */
            /* Se un file esterno applica un filtro/opacità ad un genitore, questa lo annulla. */
            .details-page,
            .details-page .container,
            .details-page .tab-content {
                opacity: 1 !important;
                filter: none !important;
                -webkit-filter: none !important;
            }

 

                /* 🔧 REGOLA BASE PER LE TABELLE (Zebratura/Divisori Grigio Scuro) */
                .details-page .table {
                    --bs-table-color: #e9edf3;
                    --bs-table-bg: transparent;
                    --bs-table-border-color: rgba(255,255,255,.14);
                    --bs-table-striped-color: #e9edf3;
                    --bs-table-hover-bg: rgba(255,255,255,.10);
                    --bs-table-hover-color: #fff;
                }

                    /* Intestazione e testo generale */
                    .details-page .table thead th {
                        color: #f4f7fb;
                        background: rgba(255,255,255,.08);
                        border-bottom-color: rgba(255,255,255,.18);
                        white-space: nowrap;
                    }

                    /* Logica Zebratura */
                    .details-page .table tbody tr > * {
                        color: #e9edf3 !important;
                        border-top-color: rgba(255,255,255,.10);
                    }

                    .details-page .table.table-striped > tbody > tr:nth-of-type(odd) > * {
                        background-color: rgba(255,255,255,.08) !important;
                    }

                    .details-page .table.table-striped > tbody > tr:nth-of-type(even) > * {
                        background-color: rgba(0,0,0,.18) !important;
                    }

                /* --- FIX ANALISI: Sfondo Scuro e Testo Chiaro per BOX/STATISTICHE (.bg-light) --- */
                .details-page .bg-light,
                .details-page .p-2.bg-light,
                .details-page .vstack .bg-light {
                    background-color: rgba(255,255,255,.12) !important; /* Grisio scuro per il box */
                    color: #e9edf3 !important; /* Testo chiaro */
                    border: 1px solid rgba(255,255,255,.18);
                }


                /* --- Altri stili minori (per completezza) --- */
                .details-page .card-header {
                    border-bottom: 1px solid rgba(255,255,255,0.14);
                }

                .details-page .badge.bg-light.text-dark {
                    background: rgba(255,255,255,.85) !important;
                    color: #111 !important;
                }

                .details-page a {
                    color: #7bd3ff;
                }

                    .details-page a:hover {
                        color: #9be0ff;
                    }

                .details-page .form-control, .details-page .form-select {
                    background: rgba(255,255,255,.10);
                    border: 1px solid rgba(255,255,255,.24);
                    color: #fff;
                }

                    .details-page .form-control:focus, .details-page .form-select:focus {
                        border-color: #00c3ff;
                        box-shadow: 0 0 0 4px rgba(0,195,255,.18);
                    }

                .details-page .btn-primary {
                    background: #00baff;
                    border-color: #00baff;
                }

                    .details-page .btn-primary:hover {
                        background: #009cdc;
                        border-color: #009cdc;
                    }

                .details-page .btn-outline-secondary {
                    color: #e9edf3;
                    border-color: rgba(255,255,255,.28);
                }

                    .details-page .btn-outline-secondary:hover {
                        background: rgba(255,255,255,.10);
                    }

                .details-page .bg-light .fw-bold, .details-page .bg-light span, .details-page .bg-light small {
                    color: #e9edf3 !important;
                }
                

            .loading-overlay {
                position: fixed;
                inset: 0;
                background: rgba(10,14,20,0.65);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 5000;
                backdrop-filter: blur(2px);
            }

            .loading-panel {
                background: rgba(20,26,36,0.92);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.18);
                border-radius: .75rem;
                box-shadow: 0 12px 36px rgba(0,0,0,.35);
                padding: 1.25rem 1.5rem;
                display: flex;
                align-items: center;
                gap: .75rem;
                max-width: 90vw;
            }

                .loading-panel .spinner-border {
                    color: #fff;
                }
        </style>
    </text>
}