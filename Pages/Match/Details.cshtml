@page "/Match/Details"
@model NextStakeWebApp.Pages.Match.DetailsModel
@using System.Text.Json
@using System.Text.Encodings.Web
@using System.Text.Unicode
@using System.Linq

@{
    ViewData["Title"] = "Dettaglio Match";
}

<div id="snow-container-details"></div>

<div class="details-page">

<div class="container py-4">
    @* Messaggio di stato (TempData) *@
    @if (TempData["StatusMessage"] is string sm && !string.IsNullOrWhiteSpace(sm))
    {
        <div class="alert alert-info d-flex align-items-center gap-2">
            <span>ℹ️</span><span>@sm</span>
        </div>
    }

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
            @if (!string.IsNullOrWhiteSpace(Model.Data.LeagueLogo))
            {
                <img src="@Model.Data.LeagueLogo" alt="logo lega" style="height:22px;width:auto;" />
            }
            <h5 class="mb-0">@Model.Data.LeagueName</h5>
            @if (!string.IsNullOrWhiteSpace(Model.Data.CountryName))
            {
                <span class="badge bg-light text-dark">@Model.Data.CountryName</span>
            }
        </div>

        <div class="text-muted">
            @Model.Data.KickoffUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <!-- Match Widget (API-SPORTS) -->
    <div class="card mb-3">
        <div class="card-body">
            <api-sports-widget data-type="config"
                               data-key="9146b11baf44d94af6e14d347213d63a"
                               data-sport="football"
                               data-lang="it"
                               data-theme="white"
                               data-show-logos="true">
            </api-sports-widget>

            <api-sports-widget data-type="game"
                               data-game-id="@Model.Data.MatchId"
                               data-show-logos="true">
            </api-sports-widget>

            <noscript class="text-muted">
                Abilita JavaScript per visualizzare il widget della partita.
            </noscript>
        </div>
    </div>
        <script>
            (function () {
              function get(id){ return document.getElementById(id); }

              function showOverlay(message) {
                const overlay = get('aiLoadingOverlay');
                const msgEl   = get('aiLoadingMessage');
                if (!overlay) return;
                if (msgEl && message) msgEl.textContent = message;
                overlay.classList.remove('d-none');
              }

              function hideOverlay() {
                const overlay = get('aiLoadingOverlay');
                overlay?.classList.add('d-none');
              }

              document.addEventListener('submit', function (e) {
                const form = e.target.closest('form[data-loading]');
                if (!form) return;

                const kind = form.getAttribute('data-loading');
                if (kind === 'preview-ai') {
                  showOverlay('Generazione anteprima pronostico AI…');
                } else if (kind === 'send-ai') {
                  showOverlay('Invio pronostico AI su Telegram…');
                } else {
                  showOverlay('Caricamento…');
                }
              });

              window.addEventListener('pageshow', hideOverlay);
            })();
        </script>


@{
    var aiPayloadObj = new
    {
        matchId = Model.Data.MatchId,
        leagueId = Model.Data.LeagueId,
        season = Model.Data.Season,
        home = Model.Data.Home,
        away = Model.Data.Away,

        // Statistiche analisi
        goals = Model.Data.Goals?.Metrics,
        shots = Model.Data.Shots?.Metrics,
        corners = Model.Data.Corners?.Metrics,
        fouls = Model.Data.Fouls?.Metrics,
        cards = Model.Data.Cards?.Metrics,
        offsides = Model.Data.Offsides?.Metrics,

        // 🔥 Pronostico proprietario
        prediction = new
        {
            esito = Model.Data.Prediction?.Esito,
            ggNg = Model.Data.Prediction?.GG_NG,
            overUnder = Model.Data.Prediction?.OverUnderRange,
            combo = Model.Data.Prediction?.ComboFinale,
            goalSimCasa = Model.Data.Prediction?.GoalSimulatoCasa,
            goalSimOspite = Model.Data.Prediction?.GoalSimulatoOspite
        },

        // 🧠 Quote (linee) passate all'IA
        // Ogni elemento ha:
        // - Description (es. "Corners Over Under", "Home Corners Over/Under", "Away Corners Over/Under")
        // - Value (es. "Over 9.5", "Under 9.5")
        // - Odd (quota numerica)
        odds = Model.Data.Odds?
            .Select(o => new
            {
                o.Bookmaker,
                o.BetId,
                o.Description,
                o.Value,
                o.Odd,
                DateUpdated = o.DateUpdated.ToString("O") // ISO 8601
            })
            .ToList()
    };

    // Encoder “safe” che non scappa i caratteri latini/italiani
    var aiPayloadJson = JsonSerializer.Serialize(
        aiPayloadObj,
        new JsonSerializerOptions
        {
            Encoder = JavaScriptEncoder.Create(
                UnicodeRanges.BasicLatin,
                UnicodeRanges.Latin1Supplement,
                UnicodeRanges.LatinExtendedA
            )
        }
    );
}


    <!-- Azioni -->
    <div class="mb-3 d-flex gap-2">
        <form method="post" action="/Match/Details?handler=ToggleFavorite&id=@Model.Data.MatchId">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn @(Model.Data.IsFavorite ? "btn-warning" : "btn-outline-secondary")">⭐ Preferito</button>
        </form>

        <a class="btn btn-outline-secondary" href="/Events">← Torna agli eventi</a>

            @* === NUOVO: bottone AI pronostico (solo Admin/SuperAdmin) *@
            @{
                bool canUseAi = User.HasClaim(c =>
                (string.Equals(c.Type, "plan", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(c.Type, "Plan", StringComparison.OrdinalIgnoreCase)) &&
                string.Equals((c.Value ?? "").Trim(), "1", StringComparison.Ordinal));
            }
            @if (canUseAi)

            {
                <form method="post" asp-page-handler="PreviewAiPick" class="ms-auto" id="aiPreviewForm" data-loading="preview-ai">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Data.MatchId" />
                    <textarea name="analysisPayload" hidden>@aiPayloadJson</textarea>
                    <button type="submit" class="btn btn-primary">
                        🤖 Genera anteprima (AI)
                    </button>
                </form>

            }

        

    </div>
@* ANTEPRIMA AI (se presente) *@
@if (!string.IsNullOrWhiteSpace(Model.Preview))
{
    var aiPrev = Model.Preview;

    <div class="card border-success mb-3">
        <div class="card-header bg-success text-white">Anteprima messaggio (AI)</div>
        <div class="card-body">
            <div class="mb-3">
                @* Mostra come HTML Telegram (abbiamo usato <b>, <em>, ecc.) *@
                @Html.Raw(aiPrev.Replace("\n", "<br/>"))
            </div>

            <form method="post"
                  asp-page-handler="SendAiPick"
                  class="d-flex gap-2"
                  id="aiSendForm"
                  data-loading="send-ai">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Data.MatchId" />
                <input type="hidden" name="preview" value="@aiPrev" />
                <button type="submit" class="btn btn-success">🚀 Invia su Telegram (Idee)</button>
                <a class="btn btn-outline-secondary" href="/Match/Details?id=@Model.Data.MatchId">Annulla</a>
            </form>
        </div>
    </div>
}



    <!-- Selettore gruppi -->
    <div class="d-flex justify-content-center">
        <div class="btn-group mb-2" role="group" aria-label="Selettore gruppi tab">
            <button id="btnGroupPron" type="button" class="btn btn-primary">Pronostici</button>
            <button id="btnGroupAnal" type="button" class="btn btn-outline-primary">Analisi</button>
        </div>
    </div>
    <div class="text-center text-danger fw-bold mb-3">
        GIORNATE MANCANTI: @Model.Data.RemainingMatches
    </div>

    <!-- Tabs contenuti -->
    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <!-- Gruppo: PRONOSTICI -->
        <li class="nav-item group-pron">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-picks" type="button" role="tab">
                Pronostici consigliati
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h" type="button" role="tab">
                Stato di forma (ultime 5)
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button" role="tab">
                Classifica
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" id="tab-exchange-tab" data-bs-toggle="tab" data-bs-target="#tab-exchange" type="button" role="tab">
                Exchange
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h-all" type="button" role="tab">
                H2H
            </button>
        </li>
<li class="nav-item group-pron">
    <button class="nav-link"
            id="tab-odds-tab"
            data-bs-toggle="tab"
            data-bs-target="#tab-odds"
            type="button"
            role="tab"
            aria-controls="tab-odds"
            aria-selected="false">
        Quote
    </button>
</li>


        <!-- Gruppo: ANALISI -->
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-shots" type="button" role="tab">
                Tiri
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-fouls" type="button" role="tab">
                Falli
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cards" type="button" role="tab">
                Cartellini
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-offsides" type="button" role="tab">
                Fuorigioco
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-goals" type="button" role="tab">
                Goal Attesi
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-corners" type="button" role="tab">
                Corner
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-club" type="button" role="tab">
                Statistiche Club
            </button>
        </li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3">
        <!-- PRONOSTICI: Pronostici consigliati -->
        <div class="tab-pane fade show active" id="tab-picks" role="tabpanel">
     @if (Model.Data.Prediction is null)
    {
        <div class="text-muted">Nessun pronostico disponibile.</div>
    }
    else
    {
        var p = Model.Data.Prediction;

        <div class="row g-3">
            <div class="col-md-6">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between"><span><strong>Esito</strong></span><span>@p.Esito</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>GG/NG</strong></span><span>@p.GG_NG</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>Over/Under</strong></span><span>@p.OverUnderRange</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>Combo</strong></span><span>@p.ComboFinale</span></li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Goal simulati</strong></span>
                        <span>@p.GoalSimulatoCasa - @p.GoalSimulatoOspite (Tot: @p.TotaleGoalSimulati)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 1.5</strong></span><span>@p.Over1_5%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 2.5</strong></span><span>@p.Over2_5%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 3.5</strong></span><span>@p.Over3_5%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span><strong>Multigoal Casa</strong></span><span>@p.MultigoalCasa</span></li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Multigoal Ospite</strong></span><span>@p.MultigoalOspite</span>
                    </li>
                </ul>
            </div>
        </div>

        @* 🔹 Quote collegate ai pronostici (solo BetId indicati) *@
        @if (Model.Data.Odds != null && Model.Data.Odds.Any())
        {
            var allowedBetIds = new[] { 1, 2, 3, 5, 6, 7, 8, 10, 12, 13, 14, 16, 17, 25, 26, 27, 28, 34, 35, 36, 39, 47, 48, 49, 50, 72 };

            var filteredOdds = Model.Data.Odds
                .Where(o => allowedBetIds.Contains(o.BetId))
                .ToList();

            if (filteredOdds.Any())
            {
                var markets = filteredOdds
                    .GroupBy(o => new { o.BetId, o.Description })
                    .OrderBy(g => g.Key.BetId)
                    .ToList();

                <div class="card mt-3">
                    <div class="card-header">
                        Quote correlate ai pronostici
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-6">
                                <label for="pronostici-odds-select" class="form-label mb-1 fw-semibold">
                                    Seleziona mercato
                                </label>
                                <select id="pronostici-odds-select" class="form-select form-select-sm">
                                    <option value="">-- Seleziona un mercato --</option>
                                    @foreach (var market in markets)
                                    {
                                        var key = $"{market.Key.BetId}_{market.Key.Description}";
                                        var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                        <option value="@key">
                                            @desc (@market.Key.BetId)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

<div class="table-responsive d-none" id="pronostici-odds-wrapper">
    <table class="table table-sm table-striped align-middle mb-0" id="pronostici-odds-table">
        <thead>
            <tr>
                <th scope="col">Selezione</th>
                <th scope="col">Quota</th>
                <th scope="col">Bookmaker</th>
                <th scope="col" class="text-end">Telegram</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var market in markets)
            {
                var key = $"{market.Key.BetId}_{market.Key.Description}";
                foreach (var o in market.OrderBy(o => o.Value))
                {
                    <tr data-market-key="@key">
                        <td>@o.Value</td>
                        <td>@o.Odd.ToString("0.00")</td>
                        <td>
    @* Mostra logo Bet365 se l'id è 8, altrimenti fallback al valore grezzo *@
    @if (o.Bookmaker == 8)
    {
        <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
    }
    else
    {
        @o.Bookmaker
    }
</td>
                        <td class="text-end">
                            @* 🔐 Bottone visibile solo a chi ha plan = 1, come gli altri tasti *@
                            @if (User.HasClaim("plan", "1"))
                            {
                                <form method="post"
                                      asp-page-handler="SendOddsIdea"
                                      class="d-inline">
                                    @Html.AntiForgeryToken()

                                    <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                    @* stesso topic che usi per l’invio pronostico *@
                                    <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                    <input type="hidden" name="betId" value="@market.Key.BetId" />
                                    <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                    <input type="hidden" name="selectionValue" value="@o.Value" />
                                    <input type="hidden" name="odd" value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                    <button type="submit"
                                            class="btn btn-sm btn-outline-success"
                                            title="Invia">
                                        🚀
                                    </button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>


                    </div>
                </div>
            }
        }

        @* 🔹 Form invio su Telegram (rimane come prima) *@
        @if (User.HasClaim("plan", "1"))
        {
            <form method="post" asp-page-handler="SendPrediction" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Data.MatchId" />
                <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Pronostico Consigliato (modificabile prima dell'invio)</label>
                        <input name="customPick" class="form-control" value="@Model.Data.Prediction?.ComboFinale" />
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                    </div>
                </div>
            </form>
        }
    }

</div>
        <!-- PRONOSTICI: H2H (tutti) -->
        <div class="tab-pane fade" id="tab-h2h-all" role="tabpanel">
            <div class="card card-body text-center">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true">
                </api-sports-widget>

                <api-sports-widget data-type="h2h"
                                   data-h2h="@Model.Data.HomeId-@Model.Data.AwayId"
                                   data-show-logos="true">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare il widget H2H.
                </noscript>
            </div>
        </div>

        <!-- TAB: Statistiche Club -->
        <div class="tab-pane fade" id="tab-club" role="tabpanel">
            <div class="card card-body">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true"
                                   data-team-statistics="true">
                </api-sports-widget>

                <h5 class="text-center mt-3 mb-3 text-primary fw-bold">@Model.Data.Home</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.HomeId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <hr class="my-4" />

                <h5 class="text-center mt-3 mb-3 text-danger fw-bold">@Model.Data.Away</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.AwayId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare le informazioni dettagliate delle squadre.
                </noscript>
            </div>
        </div>

         <!-- ANALISI: Goal Attesi -->
        <div class="tab-pane fade" id="tab-goals" role="tabpanel">
            @if (Model.Data.Goals is null || Model.Data.Goals.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi goal disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Goals.Metrics;

                // 🔹 Esito pronostico (1, X, 2, 1X, X2, ecc.)
                var esitoGoals = (Model.Data.Prediction?.Esito ?? "")
                    .Trim()
                    .ToUpperInvariant();

                // 🔹 Helper per leggere le metriche dei goal (usa direttamente le chiavi del dizionario)
                decimal? getGoalsMetric(string baseName, string side)
                {
                    if (metrics is null) return null;

                    var kv = metrics
                        .FirstOrDefault(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            return key.StartsWith(baseName, StringComparison.OrdinalIgnoreCase)
                                   && (key.EndsWith("-" + side, StringComparison.OrdinalIgnoreCase)
                                       || key.EndsWith(" - " + side, StringComparison.OrdinalIgnoreCase));
                        });

                    if (string.IsNullOrWhiteSpace(kv.Key))
                        return null;

                    var raw = kv.Value?.ToString() ?? "";

                    var cultureLocal = System.Globalization.CultureInfo.CurrentCulture;
                    var cultureInv   = System.Globalization.CultureInfo.InvariantCulture;

                    // 1️⃣ Prima prova con la cultura locale (it-IT: virgola come separatore decimale)
                    if (decimal.TryParse(raw, System.Globalization.NumberStyles.Any, cultureLocal, out var val))
                        return val;

                    // 2️⃣ Fallback: prova con Invariant (punto come separatore)
                    if (decimal.TryParse(raw, System.Globalization.NumberStyles.Any, cultureInv, out val))
                        return val;

                    return null;
                }

                // 🔹 Medie per risultato (xG medi in partite vinte / pareggiate / perse)
                var homeWon  = getGoalsMetric("Partite Vinte",      "Home");
                var homeDraw = getGoalsMetric("Partite Pareggiate", "Home");
                var homeLost = getGoalsMetric("Partite Perse",      "Home");

                var awayWon  = getGoalsMetric("Partite Vinte",      "Away");
                var awayDraw = getGoalsMetric("Partite Pareggiate", "Away");
                var awayLost = getGoalsMetric("Partite Perse",      "Away");

                // 🔹 Medie per contesto campo (nuovi campi)
                // Casa: goal fatti in casa, goal subiti in casa / trasferta
                var homeScoredHome      = getGoalsMetric("Fatti in Casa",       "Home"); // H segnati in casa
                var homeConcededHome    = getGoalsMetric("Subiti in Casa",      "Home"); // H subiti in casa
                var homeConcededAway    = getGoalsMetric("Subiti in Trasferta", "Home"); // H subiti in trasferta

                // Ospite: goal fatti in trasferta, goal subiti in casa / trasferta
                var awayScoredAway      = getGoalsMetric("Fatti in Trasferta",  "Away"); // A segnati in trasferta
                var awayConcededHome    = getGoalsMetric("Subiti in Casa",      "Away"); // A subiti in casa
                var awayConcededAway    = getGoalsMetric("Subiti in Trasferta", "Away"); // A subiti in trasferta

                decimal? pronXgHome = null;
                decimal? pronXgAway = null;

                if (!string.IsNullOrWhiteSpace(esitoGoals)
                    && (homeWon.HasValue || homeDraw.HasValue || homeLost.HasValue
                        || awayWon.HasValue || awayDraw.HasValue || awayLost.HasValue))
                {
switch (esitoGoals)
{
    case "1":
        // Casa favorita:
        //   (xG vinte + Fatti in Casa + Subiti in Casa dell'avversaria) / 3
        if (homeWon.HasValue || homeScoredHome.HasValue || awayConcededHome.HasValue)
            pronXgHome = ((homeWon ?? 0m) + (homeScoredHome ?? 0m) + (awayConcededHome ?? 0m)) / 3m;

        // Ospite sfavorita:
        //   (xG perse + Fatti in Trasferta + Subiti in Trasferta della casa) / 3
        if (awayLost.HasValue || awayScoredAway.HasValue || homeConcededAway.HasValue)
            pronXgAway = ((awayLost ?? 0m) + (awayScoredAway ?? 0m) + (homeConcededAway ?? 0m)) / 3m;
        break;

    case "2":
        // Casa sfavorita:
        //   (xG perse + Fatti in Casa + Subiti in Trasferta dell'avversaria) / 3
        if (homeLost.HasValue || homeScoredHome.HasValue || awayConcededAway.HasValue)
            pronXgHome = ((homeLost ?? 0m) + (homeScoredHome ?? 0m) + (awayConcededAway ?? 0m)) / 3m;

        // Ospite favorita:
        //   (xG vinte + Fatti in Trasferta + Subiti in Casa della casa) / 3
        if (awayWon.HasValue || awayScoredAway.HasValue || homeConcededHome.HasValue)
            pronXgAway = ((awayWon ?? 0m) + (awayScoredAway ?? 0m) + (homeConcededHome ?? 0m)) / 3m;
        break;

    case "1X":
        // Casa non perde:
        //   (xG vinte + xG pareggiate + Fatti in Casa + Subiti in Casa dell'avversaria) / 4
        if (homeWon.HasValue || homeDraw.HasValue || homeScoredHome.HasValue || awayConcededHome.HasValue)
            pronXgHome = ((homeWon ?? 0m) + (homeDraw ?? 0m) + (homeScoredHome ?? 0m) + (awayConcededHome ?? 0m)) / 4m;

        // Ospite:
        //   (xG perse + xG pareggiate + Fatti in Trasferta + Subiti in Trasferta della casa) / 4
        if (awayLost.HasValue || awayDraw.HasValue || awayScoredAway.HasValue || homeConcededAway.HasValue)
            pronXgAway = ((awayLost ?? 0m) + (awayDraw ?? 0m) + (awayScoredAway ?? 0m) + (homeConcededAway ?? 0m)) / 4m;
        break;

    case "X2":
        // Casa (sfavorita / può soffrire):
        //   (xG pareggiate + xG perse + Fatti in Casa + Subiti in Trasferta avversaria) / 4
        if (homeDraw.HasValue || homeLost.HasValue || homeScoredHome.HasValue || awayConcededAway.HasValue)
            pronXgHome = ((homeDraw ?? 0m) + (homeLost ?? 0m) + (homeScoredHome ?? 0m) + (awayConcededAway ?? 0m)) / 4m;

        // Trasferta (favorita):
        //   (xG pareggiate + xG vinte + Fatti in Trasferta + Goal segnati in casa dall’avversaria) / 4
        if (awayDraw.HasValue || awayWon.HasValue || awayScoredAway.HasValue || homeScoredHome.HasValue)
            pronXgAway = ((awayDraw ?? 0m) + (awayWon ?? 0m) + (awayScoredAway ?? 0m) + (homeScoredHome ?? 0m)) / 4m;
        break;

    case "X":
        // Pareggio secco:
        // Casa: (xG pareggiate + Fatti in Casa + Subiti in Casa avversaria) / 3
        if (homeDraw.HasValue || homeScoredHome.HasValue || awayConcededHome.HasValue)
            pronXgHome = ((homeDraw ?? 0m) + (homeScoredHome ?? 0m) + (awayConcededHome ?? 0m)) / 3m;

        // Ospite: (xG pareggiate + Fatti in Trasferta + Subiti in Trasferta casa) / 3
        if (awayDraw.HasValue || awayScoredAway.HasValue || homeConcededAway.HasValue)
            pronXgAway = ((awayDraw ?? 0m) + (awayScoredAway ?? 0m) + (homeConcededAway ?? 0m)) / 3m;
        break;

    default:
        pronXgHome = null;
        pronXgAway = null;
        break;
}

                }

                var pronXgTot = (pronXgHome.HasValue && pronXgAway.HasValue)
                    ? pronXgHome.Value + pronXgAway.Value
                    : (decimal?)null;

                bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                    k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                    k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                );

 <div class="vstack gap-3">

    @* 🔹 BOX PRONOSTICO xG – ORA STILE IDENTICO A TIRI/FALLI/CORNER *@
    @if (pronXgHome.HasValue || pronXgAway.HasValue || pronXgTot.HasValue)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Goal Attesi Home</span>
                    <span class="fs-5">
                        @(pronXgHome.HasValue ? pronXgHome.Value.ToString("0.00") : "—")
                    </span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Goal Attesi Away</span>
                    <span class="fs-5">
                        @(pronXgAway.HasValue ? pronXgAway.Value.ToString("0.00") : "—")
                    </span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Totale xG attesi</span>
                    <span class="fs-5">
                        @(pronXgTot.HasValue ? pronXgTot.Value.ToString("0.00") : "—")
                    </span>
                </div>
            </div>
        </div>

        <div class="col-12 mb-2">
            <small class="text-muted">
                Calcolati dall'esito (@esitoGoals) usando: medie xG per risultato
                (vinte/pareggiate/perse), goal fatti in casa/trasferta e goal subiti
                in casa/trasferta.
            </small>
        </div>

        @* 🔹 QUOTE GOAL (da Odds, Description LIKE '%goal%') *@
        @if (Model.Data.Odds != null && Model.Data.Odds.Any())
        {
            var goalOdds = Model.Data.Odds
                .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                            && o.Description.IndexOf("goal", StringComparison.OrdinalIgnoreCase) >= 0)
                .ToList();

            if (goalOdds.Any())
            {
                var goalMarkets = goalOdds
                    .GroupBy(o => new { o.BetId, o.Description })
                    .OrderBy(g => g.Key.BetId)
                    .ToList();

                <div class="card mt-3">
                    <div class="card-header">
                        Quote Goal (dati dai bookmaker)
                    </div>

                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-6">
                                <label for="goal-odds-select" class="form-label mb-1 fw-semibold">
                                    Seleziona mercato Goal
                                </label>
                                <select id="goal-odds-select" class="form-select form-select-sm">
                                    <option value="">-- Seleziona un mercato --</option>
                                    @foreach (var market in goalMarkets)
                                    {
                                        var key  = $"{market.Key.BetId}_{market.Key.Description}";
                                        var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                        <option value="@key">
                                            @desc (@market.Key.BetId)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive d-none" id="goal-odds-wrapper">
                            <table class="table table-sm table-striped align-middle mb-0" id="goal-odds-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Selezione</th>
                                        <th scope="col">Quota</th>
                                        <th scope="col">Bookmaker</th>
                                        <th scope="col" class="text-end">Telegram</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var market in goalMarkets)
                                    {
                                        var key = $"{market.Key.BetId}_{market.Key.Description}";
                                        foreach (var o in market.OrderBy(o => o.Value))
                                        {
                                            <tr data-market-key="@key">
                                                <td>@o.Value</td>
                                                <td>@o.Odd.ToString("0.00")</td>
                                                <td>
                                                    @if (o.Bookmaker == 8)
                                                    {
                                                        <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                                                    }
                                                    else
                                                    {
                                                        @o.Bookmaker
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    @if (User.HasClaim("plan", "1"))
                                                    {
                                                        <form method="post"
                                                              asp-page-handler="SendOddsIdea"
                                                              class="d-inline">
                                                            @Html.AntiForgeryToken()

                                                            <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                            <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                            <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                            <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                            <input type="hidden" name="selectionValue" value="@o.Value" />
                                                            <input type="hidden" name="odd"
                                                                   value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                            <button type="submit"
                                                                    class="btn btn-sm btn-outline-success"
                                                                    title="Invia su Telegram">
                                                                🚀
                                                            </button>
                                                        </form>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            }
        }
    }

    @* 🔹 Tabella / box delle metriche come prima *@

                    @if (!hasSides)
                    {
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th style="width:60%;">Metrica</th>
                                        <th class="text-end">Valore</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var kv in metrics)
                                    {
                                        <tr>
                                            <td>@kv.Key</td>
                                            <td class="text-end">@kv.Value</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        // Etichette "parlanti" tipiche per xG (fallback: chiave originale)
                        var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                        {
                            ["xG"]                  = "xG medio (expected goals)",
                            ["xGA"]                 = "xGA medio (expected goals concessi)",
                            ["NPxG"]                = "NPxG medio (senza rigori)",
                            ["In Casa"]             = "xG/goal medi in casa",
                            ["Fuoricasa"]           = "xG/goal medi in trasferta",
                            ["Ultime 5"]            = "xG/goal medi (ultime 5 partite)",
                            ["Partite Vinte"]       = "xG/goal medi nelle partite vinte",
                            ["Partite Pareggiate"]  = "xG/goal medi nelle partite pareggiate",
                            ["Partite Perse"]       = "xG/goal medi nelle partite perse",
                            ["Fatti in Casa"]       = "Goal segnati in casa",
                            ["Fatti in Trasferta"]  = "Goal segnati in trasferta",
                            ["Subiti in Casa"]      = "Goal subiti in casa",
                            ["Subiti in Trasferta"] = "Goal subiti in trasferta"
                        };

                        var groups = metrics
                            .Select(kv =>
                            {
                                var key = kv.Key?.Trim() ?? "";
                                var lastDash = key.LastIndexOf('-');
                                var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                                var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                                return new { baseName, side, value = kv.Value };
                            })
                            .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                            .ToDictionary(
                                g => g.Key,
                                g => new
                                {
                                    Casa = g.FirstOrDefault(i =>
                                        string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                                        string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase)
                                    )?.value ?? "—",
                                    Ospite = g.FirstOrDefault(i =>
                                        string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                                        string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase)
                                    )?.value ?? "—"
                                },
                                StringComparer.OrdinalIgnoreCase
                            );

                        // Ordine più leggibile
                        string[] desiredOrder = {
                            "xG","xGA","NPxG",
                            "Fatti in Casa","Fatti in Trasferta",
                            "Subiti in Casa","Subiti in Trasferta",
                            "In Casa","Fuoricasa",
                            "Ultime 5","Partite Vinte","Partite Pareggiate","Partite Perse"
                        };

                        var orderedKeys = groups.Keys
                            .OrderBy(k =>
                            {
                                var idx = Array.IndexOf(desiredOrder, k);
                                return idx < 0 ? int.MaxValue : idx;
                            })
                            .ThenBy(k => k);

                        var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                        var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                            <div class="mb-2 mt-3">
                                <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>@homeName</span>
                                            <span class="fw-bold">@row.Casa</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>@awayName</span>
                                            <span class="fw-bold">@row.Ospite</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        </div>






        <!-- PRONOSTICI: Stato di forma -->
        <div class="tab-pane fade" id="tab-h2h" role="tabpanel">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Home</h6>
                    @if (Model.Data.HomeForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.HomeForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>;
                                        }
                                        else if (m.Result == "D")
                                        {
                                            <span class="badge bg-secondary">D</span>;
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">L</span>;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>

                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Away</h6>
                    @if (Model.Data.AwayForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.AwayForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>;
                                        }
                                        else if (m.Result == "D")
                                        {
                                            <span class="badge bg-secondary">D</span>;
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">L</span>;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

            <!-- PRONOSTICI: Classifica (SOLO WIDGET) -->
            <div class="tab-pane fade" id="tab-table" role="tabpanel">
                <div class="card card-body">
                    <api-sports-widget data-type="config"
                                       data-key="9146b11baf44d94af6e14d347213d63a"
                                       data-sport="football"
                                       data-lang="it"
                                       data-theme="grey"
                                       data-show-logos="true"
                                       data-standings="true">
                    </api-sports-widget>

                    <api-sports-widget data-type="standings"
                                       data-league="@Model.Data.LeagueId"
                                       data-season="@Model.Data.Season">
                    </api-sports-widget>

                    <noscript class="text-muted">
                        Abilita JavaScript per visualizzare la classifica del widget.
                    </noscript>
                </div>
            </div>




<!-- PRONOSTICI: Quote -->
<div class="tab-pane fade" id="tab-odds" role="tabpanel" aria-labelledby="tab-odds-tab">
    @if (Model.Data.Odds == null || !Model.Data.Odds.Any())
    {
        <p class="text-muted">Nessuna quota disponibile per questa partita.</p>
    }
    else
    {
        <div class="d-flex align-items-center gap-2 mb-3">
            <label for="betid-filter" class="mb-0 fw-semibold">Filtra per BetId:</label>
            <select id="betid-filter" class="form-select form-select-sm" style="max-width: 200px;">
                <option value="">Tutti</option>
                @foreach (var betId in Model.Data.BetIds)
                {
                    <option value="@betId">@betId</option>
                }
            </select>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle" id="odds-table">
                <thead>
                    <tr>
                        <th>Bookmaker</th>
                        <th>BetId</th>
                        <th>Descrizione</th>
                        <th>Value</th>
                        <th>Quota</th>
                        <th>Aggiornata</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var o in Model.Data.Odds
                        .OrderBy(x => x.BetId)
                        .ThenBy(x => x.Description))
                    {
                        <tr data-betid="@o.BetId">
                            <td>@o.Bookmaker</td>
                            <td>@o.BetId</td>
                            <td>@o.Description</td>
                            <td>@o.Value</td>
                            <td>@o.Odd.ToString("0.00")</td>
                            <td>@o.DateUpdated.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>



<!-- ANALISI: Corner -->
<div class="tab-pane fade" id="tab-corners" role="tabpanel">
    @{
        decimal? pronCornersHome = null;
        decimal? pronCornersAway = null;
        decimal? pronCornersTotal = null;

        var esitoCorners    = Model.Data.Prediction?.Esito?.Trim().ToUpperInvariant();
        var cornersMetrics  = Model.Data.Corners?.Metrics;

        if (!string.IsNullOrWhiteSpace(esitoCorners) && cornersMetrics != null && cornersMetrics.Count > 0)
        {
            Func<string, string, decimal?> getCornersMetric = (baseName, side) =>
            {
                var sideCandidates = side.Equals("Home", StringComparison.OrdinalIgnoreCase)
                    ? new[] { "Home", "Casa" }
                    : new[] { "Away", "Ospite" };

                foreach (var sc in sideCandidates)
                {
                    var key1 = baseName + "-" + sc;
                    var key2 = baseName + " - " + sc;

                    if (cornersMetrics.TryGetValue(key1, out var raw) || cornersMetrics.TryGetValue(key2, out raw))
                    {
                        if (raw is null) continue;

                        var s = Convert.ToString(raw, System.Globalization.CultureInfo.InvariantCulture) ?? "";
                        if (decimal.TryParse(
                                s,
                                System.Globalization.NumberStyles.Any,
                                System.Globalization.CultureInfo.InvariantCulture,
                                out var val))
                        {
                            // Se la media è salvata "x100" (es. 420 → 4.20)
                            if (val > 50m) val /= 100m;
                            return val;
                        }
                    }
                }

                return null;
            };

            // Medie per risultato
            var homeWon   = getCornersMetric("Partite Vinte",      "Home");
            var homeDraw  = getCornersMetric("Partite Pareggiate", "Home");
            var homeLost  = getCornersMetric("Partite Perse",      "Home");

            var awayWon   = getCornersMetric("Partite Vinte",      "Away");
            var awayDraw  = getCornersMetric("Partite Pareggiate", "Away");
            var awayLost  = getCornersMetric("Partite Perse",      "Away");

            // Medie per contesto campo (a favore)
            // Casa: corner fatti in casa
            var homeHome  = getCornersMetric("In Casa",            "Home");
            // Ospite: corner fatti in trasferta
            var awayAway  = getCornersMetric("Fuoricasa",          "Away");

            switch (esitoCorners)
            {
                case "1":
                    // Casa favorita → (vittorie + corner fatti in casa) / 2
                    if (homeWon.HasValue || homeHome.HasValue)
                        pronCornersHome = ((homeWon ?? 0m) + (homeHome ?? 0m)) / 2m;

                    // Ospite sfavorita → (sconfitte + corner fatti in trasferta) / 2
                    if (awayLost.HasValue || awayAway.HasValue)
                        pronCornersAway = ((awayLost ?? 0m) + (awayAway ?? 0m)) / 2m;
                    break;

                case "2":
                    // Casa sfavorita → (sconfitte + corner fatti in casa) / 2
                    if (homeLost.HasValue || homeHome.HasValue)
                        pronCornersHome = ((homeLost ?? 0m) + (homeHome ?? 0m)) / 2m;

                    // Ospite favorita → (vittorie + corner fatti in trasferta) / 2
                    if (awayWon.HasValue || awayAway.HasValue)
                        pronCornersAway = ((awayWon ?? 0m) + (awayAway ?? 0m)) / 2m;
                    break;

                case "1X":
                    // Casa: (vittorie + pareggi + corner fatti in casa) / 3
                    if (homeWon.HasValue || homeDraw.HasValue || homeHome.HasValue)
                        pronCornersHome = ((homeWon ?? 0m) + (homeDraw ?? 0m) + (homeHome ?? 0m)) / 3m;

                    // Ospite: (sconfitte + pareggi + corner fatti in trasferta) / 3
                    if (awayLost.HasValue || awayDraw.HasValue || awayAway.HasValue)
                        pronCornersAway = ((awayLost ?? 0m) + (awayDraw ?? 0m) + (awayAway ?? 0m)) / 3m;
                    break;

                case "X2":
                    // Casa: (sconfitte + pareggi + corner fatti in casa) / 3
                    if (homeLost.HasValue || homeDraw.HasValue || homeHome.HasValue)
                        pronCornersHome = ((homeLost ?? 0m) + (homeDraw ?? 0m) + (homeHome ?? 0m)) / 3m;

                    // Ospite: (vittorie + pareggi + corner fatti in trasferta) / 3
                    if (awayWon.HasValue || awayDraw.HasValue || awayAway.HasValue)
                        pronCornersAway = ((awayWon ?? 0m) + (awayDraw ?? 0m) + (awayAway ?? 0m)) / 3m;
                    break;

                case "X":
                    // Se vuoi considerare anche X: media tra pareggi e contesto campo
                    if (homeDraw.HasValue || homeHome.HasValue)
                        pronCornersHome = ((homeDraw ?? 0m) + (homeHome ?? 0m)) / 2m;

                    if (awayDraw.HasValue || awayAway.HasValue)
                        pronCornersAway = ((awayDraw ?? 0m) + (awayAway ?? 0m)) / 2m;
                    break;
            }

            if (pronCornersHome.HasValue && pronCornersAway.HasValue)
                pronCornersTotal = pronCornersHome + pronCornersAway;
        }
    }


    @if (pronCornersHome.HasValue || pronCornersAway.HasValue || pronCornersTotal.HasValue)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Corner Home</span>
                    <span class="fs-5">@pronCornersHome?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Corner Away</span>
                    <span class="fs-5">@pronCornersAway?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Corner Totali</span>
                    <span class="fs-5">@pronCornersTotal?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-12">
                <small class="text-muted">
                    Calcolati da Esito (@esitoCorners) usando le medie corner nelle partite vinte / pareggiate / perse.
                </small>
            </div>
                           @* 🔹 QUOTE CORNER (da Odds, Description LIKE '%Corner%') *@
                @if (Model.Data.Odds != null && Model.Data.Odds.Any())
                {
                    var cornerOdds = Model.Data.Odds
                        .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                                    && o.Description.IndexOf("corner", StringComparison.OrdinalIgnoreCase) >= 0)
                        .ToList();

                    if (cornerOdds.Any())
                    {
                        var cornerMarkets = cornerOdds
                            .GroupBy(o => new { o.BetId, o.Description })
                            .OrderBy(g => g.Key.BetId)
                            .ToList();

                        <div class="card mt-4">
                            <div class="card-header">
                                Quote Corner (dati dai bookmaker)
                            </div>
                            <div class="card-body">
                                <div class="row g-3 align-items-center mb-3">
                                    <div class="col-md-6">
                                        <label for="corner-odds-select" class="form-label mb-1 fw-semibold">
                                            Seleziona mercato Corner
                                        </label>
<select id="corner-odds-select" class="form-select form-select-sm">
    <option value="">-- Seleziona un mercato --</option>
    @foreach (var market in cornerMarkets)
    {
        var key = market.Key.Description ?? $"Bet {market.Key.BetId}";
        var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
        <option value="@key">
            @desc
        </option>
    }
</select>

                                    </div>
                                </div>

                                <div class="table-responsive d-none" id="corner-odds-wrapper">
                                    <table class="table table-sm table-striped align-middle mb-0" id="corner-odds-table">
                                        <thead>
                                            <tr>
                                                <th scope="col">Selezione</th>
                                                <th scope="col">Quota</th>
                                                <th scope="col">Bookmaker</th>
                                                <th scope="col" class="text-end">Telegram</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                @foreach (var market in cornerMarkets)
    {
        var key = market.Key.Description ?? $"Bet {market.Key.BetId}";
        foreach (var o in market.OrderBy(o => o.Value))
        {
            <tr data-market-key="@key">
                <td>@o.Value</td>
                <td>@o.Odd.ToString("0.00")</td>
                <td>
                    @if (o.Bookmaker == 8)
                    {
                        <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                    }
                    else
                    {
                        @o.Bookmaker
                    }
                </td>
                <td class="text-end">
                                                            @if (User.HasClaim("plan", "1"))
                                                            {
                                                                <form method="post"
                                                                      asp-page-handler="SendOddsIdea"
                                                                      class="d-inline">
                                                                    @Html.AntiForgeryToken()

                                                                    <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                                    <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                                    <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                                    <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                                    <input type="hidden" name="selectionValue" value="@o.Value" />
                                                                    <input type="hidden" name="odd" value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                                    <button type="submit"
                                                                            class="btn btn-sm btn-outline-success"
                                                                            title="Invia">
                                                                        🚀
                                                                    </button>
                                                                </form>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                }
        </div>
    }

 @if (Model.Data.Corners is null || Model.Data.Corners.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi corner disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Corners.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                    k != null && (
                        k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                        k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                    )
                );

                // 🔹 BLOCCO METRICHE (come prima)
                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th style="width:60%;">Metrica</th>
                                    <th class="text-end">Valore</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr>
                                        <td>@kv.Key</td>
                                        <td class="text-end">@kv.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                    {
                        ["Battuti"]            = "Media corner battuti",
                        ["Effettuati"]         = "Media corner a favore",
                        ["Subiti"]             = "Media corner concessi",
                        ["In Casa"]            = "Media corner a favore in casa",
                        ["Fuoricasa"]          = "Media corner a favore in trasferta",
                        ["Ultime 5"]           = "Media corner (ultime 5 partite)",
                        ["Partite Vinte"]      = "Media corner nelle partite vinte",
                        ["Partite Pareggiate"] = "Media corner nelle partite pareggiate",
                        ["Partite Perse"]      = "Media corner nelle partite perse"
                    };

                    var groups = metrics
                        .Select(kv =>
                        {
                            var key = kv.Key?.Trim() ?? "";
                            var lastDash = key.LastIndexOf('-');
                            var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                            var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                            return new { baseName, side, value = kv.Value };
                        })
                        .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                        .ToDictionary(
                            g => g.Key,
                            g => new
                            {
                                Casa = g.FirstOrDefault(i =>
                                    string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                                    string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase)
                                )?.value ?? "—",
                                Ospite = g.FirstOrDefault(i =>
                                    string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                                    string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase)
                                )?.value ?? "—"
                            },
                            StringComparer.OrdinalIgnoreCase
                        );

                    string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
                    var orderedKeys = groups.Keys
                        .OrderBy(k =>
                        {
                            var idx = Array.IndexOf(desiredOrder, k);
                            return idx < 0 ? int.MaxValue : idx;
                        })
                        .ThenBy(k => k);

                    var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
                    var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

 
            }
        </div>



<!-- ANALISI: Cartellini -->
<div class="tab-pane fade" id="tab-cards" role="tabpanel">
    @{
        decimal? pronCardsHome = null;
        decimal? pronCardsAway = null;
        decimal? pronCardsTotal = null;

        var esitoCards   = Model.Data.Prediction?.Esito;
        var cardsMetrics = Model.Data.Cards?.Metrics;

        if (!string.IsNullOrWhiteSpace(esitoCards) && cardsMetrics != null && cardsMetrics.Count > 0)
        {
            // 🔹 Helper: legge una metrica (baseName) per Home/Away (o Casa/Ospite)
            Func<string, string, decimal?> getCardsMetric = (baseName, side) =>
            {
                if (cardsMetrics is null) return null;

                var sideCandidates = side.Equals("Home", StringComparison.OrdinalIgnoreCase)
                    ? new[] { "Home", "Casa" }
                    : new[] { "Away", "Ospite" };

                foreach (var sc in sideCandidates)
                {
                    var key1 = baseName + "-" + sc;
                    var key2 = baseName + " - " + sc;

                    if (cardsMetrics.TryGetValue(key1, out var raw) || cardsMetrics.TryGetValue(key2, out raw))
                    {
                        if (raw is null) continue;

                        var s = raw.ToString() ?? "";

                        // Prova prima con cultura locale (it-IT), poi invariant
                        var cultureLocal = System.Globalization.CultureInfo.CurrentCulture;
                        var cultureInv   = System.Globalization.CultureInfo.InvariantCulture;

                        if (decimal.TryParse(s, System.Globalization.NumberStyles.Any, cultureLocal, out var val) ||
                            decimal.TryParse(s, System.Globalization.NumberStyles.Any, cultureInv,   out val))
                        {
                            // Eventuale normalizzazione tipo "420" → 4.20
                            if (val > 50m) val /= 100m;
                            return val;
                        }
                    }
                }

                return null;
            };

            // 🔹 Medie su vinte/pareggiate/perse
            var homeWon  = getCardsMetric("Partite Vinte",      "Home");
            var homeDraw = getCardsMetric("Partite Pareggiate", "Home");
            var homeLost = getCardsMetric("Partite Perse",      "Home");

            var awayWon  = getCardsMetric("Partite Vinte",      "Away");
            var awayDraw = getCardsMetric("Partite Pareggiate", "Away");
            var awayLost = getCardsMetric("Partite Perse",      "Away");

            // 🔹 Nuove medie:
            //  - "In Casa"     → cartellini a favore in casa
            //  - "Fuoricasa"   → cartellini a favore in trasferta
            //  - "Fatti"/"Effettuati" → cartellini ottenuti
            var homeInCasa    = getCardsMetric("In Casa",   "Home");
            var awayFuoricasa = getCardsMetric("Fuoricasa", "Away");

            var homeFatti = getCardsMetric("Fatti", "Home")
                            ?? getCardsMetric("Effettuati", "Home");
            var awayFatti = getCardsMetric("Fatti", "Away")
                            ?? getCardsMetric("Effettuati", "Away");

switch (esitoCards)
{
    case "1":
        // Casa favorita:
        //  (In Casa + Partite Vinte + Fatti) / 3
        if (homeInCasa.HasValue || homeWon.HasValue || homeFatti.HasValue)
        {
            var hIn  = homeInCasa ?? 0m;
            var hWin = homeWon    ?? 0m;
            var hFat = homeFatti  ?? 0m;
            pronCardsHome = (hIn + hWin + hFat) / 3m;
        }

        // Ospite sfavorita:
        //  (Fuoricasa + Partite Perse + Fatti) / 3
        if (awayFuoricasa.HasValue || awayLost.HasValue || awayFatti.HasValue)
        {
            var aOut = awayFuoricasa ?? 0m;
            var aLos = awayLost      ?? 0m;
            var aFat = awayFatti     ?? 0m;
            pronCardsAway = (aOut + aLos + aFat) / 3m;
        }
        break;

    case "2":
        // Casa sfavorita:
        //  (In Casa + Partite Perse + Fatti) / 3
        if (homeInCasa.HasValue || homeLost.HasValue || homeFatti.HasValue)
        {
            var hIn  = homeInCasa ?? 0m;
            var hLos = homeLost   ?? 0m;
            var hFat = homeFatti  ?? 0m;
            pronCardsHome = (hIn + hLos + hFat) / 3m;
        }

        // Ospite favorita:
        //  (Fuoricasa + Partite Vinte + Fatti) / 3
        if (awayFuoricasa.HasValue || awayWon.HasValue || awayFatti.HasValue)
        {
            var aOut = awayFuoricasa ?? 0m;
            var aWin = awayWon       ?? 0m;
            var aFat = awayFatti     ?? 0m;
            pronCardsAway = (aOut + aWin + aFat) / 3m;
        }
        break;

    case "1X":
        // Casa non perde:
        //  (In Casa + Partite Vinte + Partite Pareggiate + Fatti) / 4
        if (homeInCasa.HasValue || homeWon.HasValue || homeDraw.HasValue || homeFatti.HasValue)
        {
            var hIn   = homeInCasa ?? 0m;
            var hWin  = homeWon    ?? 0m;
            var hDraw = homeDraw   ?? 0m;
            var hFat  = homeFatti  ?? 0m;
            pronCardsHome = (hIn + hWin + hDraw + hFat) / 4m;
        }

        // Ospite (meno favorevole):
        //  (Fuoricasa + Partite Perse + Partite Pareggiate + Fatti) / 4
        if (awayFuoricasa.HasValue || awayLost.HasValue || awayDraw.HasValue || awayFatti.HasValue)
        {
            var aOut  = awayFuoricasa ?? 0m;
            var aLos  = awayLost      ?? 0m;
            var aDraw = awayDraw      ?? 0m;
            var aFat  = awayFatti     ?? 0m;
            pronCardsAway = (aOut + aLos + aDraw + aFat) / 4m;
        }
        break;

    case "X2":
        // Casa (sfavorita / può soffrire):
        //  (In Casa + Partite Pareggiate + Partite Perse + Fatti) / 4
        if (homeInCasa.HasValue || homeDraw.HasValue || homeLost.HasValue || homeFatti.HasValue)
        {
            var hIn   = homeInCasa ?? 0m;
            var hDraw = homeDraw   ?? 0m;
            var hLos  = homeLost   ?? 0m;
            var hFat  = homeFatti  ?? 0m;
            pronCardsHome = (hIn + hDraw + hLos + hFat) / 4m;
        }

        // Trasferta (favorita):
        //  (Fuoricasa + Partite Vinte + Partite Pareggiate + Fatti) / 4
        if (awayFuoricasa.HasValue || awayWon.HasValue || awayDraw.HasValue || awayFatti.HasValue)
        {
            var aOut  = awayFuoricasa ?? 0m;
            var aWin  = awayWon       ?? 0m;
            var aDraw = awayDraw      ?? 0m;
            var aFat  = awayFatti     ?? 0m;
            pronCardsAway = (aOut + aWin + aDraw + aFat) / 4m;
        }
        break;

    case "X":
        // Pareggio secco:
        // Casa:  (In Casa + Partite Pareggiate + Fatti) / 3
        if (homeInCasa.HasValue || homeDraw.HasValue || homeFatti.HasValue)
        {
            var hIn   = homeInCasa ?? 0m;
            var hDraw = homeDraw   ?? 0m;
            var hFat  = homeFatti  ?? 0m;
            pronCardsHome = (hIn + hDraw + hFat) / 3m;
        }

        // Ospite: (Fuoricasa + Partite Pareggiate + Fatti) / 3
        if (awayFuoricasa.HasValue || awayDraw.HasValue || awayFatti.HasValue)
        {
            var aOut  = awayFuoricasa ?? 0m;
            var aDraw = awayDraw      ?? 0m;
            var aFat  = awayFatti     ?? 0m;
            pronCardsAway = (aOut + aDraw + aFat) / 3m;
        }
        break;

    default:
        pronCardsHome = null;
        pronCardsAway = null;
        break;
}


            if (pronCardsHome.HasValue && pronCardsAway.HasValue)
                pronCardsTotal = pronCardsHome + pronCardsAway;
        }
    }

 @* BOX PRONOSTICO CARTELLINI + QUOTE CARTELLINI *@
@if (pronCardsHome.HasValue || pronCardsAway.HasValue || pronCardsTotal.HasValue)
{
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="p-3 rounded bg-light d-flex flex-column">
                <span class="fw-semibold">Pronostico Cartellini Home</span>
                <span class="fs-5">@pronCardsHome?.ToString("0.00")</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-3 rounded bg-light d-flex flex-column">
                <span class="fw-semibold">Pronostico Cartellini Away</span>
                <span class="fs-5">@pronCardsAway?.ToString("0.00")</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-3 rounded bg-light d-flex flex-column">
                <span class="fw-semibold">Pronostico Cartellini Totali</span>
                <span class="fs-5">@pronCardsTotal?.ToString("0.00")</span>
            </div>
        </div>
        <div class="col-12">
            <small class="text-muted">
                Per X2: media di In Casa/Fuoricasa, partite vinte/pareggiate/perse e cartellini ottenuti (diviso 4).
            </small>
        </div>

        @* 🔹 QUOTE CARTELLINI (da Odds, Description LIKE '%card%') *@
        @if (Model.Data.Odds != null && Model.Data.Odds.Any())
        {
            var cardsOdds = Model.Data.Odds
                .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                            && o.Description.IndexOf("card", StringComparison.OrdinalIgnoreCase) >= 0)
                .ToList();

            if (cardsOdds.Any())
            {
                var cardsMarkets = cardsOdds
                    .GroupBy(o => new { o.BetId, o.Description })
                    .OrderBy(g => g.Key.BetId)
                    .ToList();

                <div class="card mt-4">
                    <div class="card-header">
                        Quote Cartellini (dati dai bookmaker)
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-6">
                                <label for="cards-odds-select" class="form-label mb-1 fw-semibold">
                                    Seleziona mercato Cartellini
                                </label>
                                <select id="cards-odds-select" class="form-select form-select-sm">
                                    <option value="">-- Seleziona un mercato --</option>
                                    @foreach (var market in cardsMarkets)
                                    {
                                        var key  = $"{market.Key.BetId}_{market.Key.Description}";
                                        var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                        <option value="@key">
                                            @desc (@market.Key.BetId)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive d-none" id="cards-odds-wrapper">
                            <table class="table table-sm table-striped align-middle mb-0" id="cards-odds-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Selezione</th>
                                        <th scope="col">Quota</th>
                                        <th scope="col">Bookmaker</th>
                                        <th scope="col" class="text-end">Telegram</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var market in cardsMarkets)
                                    {
                                        var key = $"{market.Key.BetId}_{market.Key.Description}";
                                        foreach (var o in market.OrderBy(o => o.Value))
                                        {
                                            <tr data-market-key="@key">
                                                <td>@o.Value</td>
                                                <td>@o.Odd.ToString("0.00")</td>
                                                <td>
                                                    @if (o.Bookmaker == 8)
                                                    {
                                                        <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                                                    }
                                                    else
                                                    {
                                                        @o.Bookmaker
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    @if (User.HasClaim("plan", "1"))
                                                    {
                                                        <form method="post"
                                                              asp-page-handler="SendOddsIdea"
                                                              class="d-inline">
                                                            @Html.AntiForgeryToken()

                                                            <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                            <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                            <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                            <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                            <input type="hidden" name="selectionValue" value="@o.Value" />
                                                            <input type="hidden" name="odd"
                                                                   value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                            <button type="submit"
                                                                    class="btn btn-sm btn-outline-warning"
                                                                    title="Invia cartellini">
                                                                🚀
                                                            </button>
                                                        </form>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            }
        }
    </div>
}


    @* BLOCCO METRICHE (come prima) *@
    @if (Model.Data.Cards is null || Model.Data.Cards.Metrics.Count == 0)
    {
        <div class="text-muted">Nessuna analisi cartellini disponibile.</div>
    }
    else
    {
        var metrics = Model.Data.Cards.Metrics;

        bool hasSides = metrics.Keys.Any(k =>
            k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
            )
        );

        if (!hasSides)
        {
            <div class="table-responsive mt-3">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="width:60%;">Metrica</th>
                            <th class="text-end">Valore</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var kv in metrics)
                        {
                            <tr>
                                <td>@kv.Key</td>
                                <td class="text-end">@kv.Value</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                ["Fatti"]              = "Media cartellini ottenuti",
                ["Gialli"]             = "Media cartellini gialli",
                ["Rossi"]              = "Media cartellini rossi",
                ["Effettuati"]         = "Media cartellini a favore",
                ["Subiti"]             = "Media cartellini avversari",
                ["In Casa"]            = "Media cartellini a favore in casa",
                ["Fuoricasa"]          = "Media cartellini a favore in trasferta",
                ["Ultime 5"]           = "Media cartellini (ultime 5 partite)",
                ["Partite Vinte"]      = "Media cartellini nelle partite vinte",
                ["Partite Pareggiate"] = "Media cartellini nelle partite pareggiate",
                ["Partite Perse"]      = "Media cartellini nelle partite perse"
            };

            var groups = metrics
                .Select(kv =>
                {
                    var key = kv.Key?.Trim() ?? "";
                    var lastDash = key.LastIndexOf('-');
                    var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                    var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                    return new { baseName, side, value = kv.Value };
                })
                .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase)
                        )?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase)
                        )?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                );

            string[] desiredOrder = {
                "Gialli", "Rossi", "Effettuati", "Subiti",
                "In Casa", "Fuoricasa", "Ultime 5",
                "Partite Vinte", "Partite Pareggiate", "Partite Perse"
            };

            var orderedKeys = groups.Keys
                .OrderBy(k =>
                {
                    var idx = Array.IndexOf(desiredOrder, k);
                    return idx < 0 ? int.MaxValue : idx;
                })
                .ThenBy(k => k);

            var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
            var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

            <div class="vstack gap-3 mt-3">
                @foreach (var key in orderedKeys)
                {
                    var row = groups[key];
                    var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                    <div class="mb-2">
                        <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                        <div class="row g-2 pt-2">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@homeName</span>
                                    <span class="fw-bold">@row.Casa</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@awayName</span>
                                    <span class="fw-bold">@row.Ospite</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }

</div>


<!-- ANALISI: Falli -->
<div class="tab-pane fade" id="tab-fouls" role="tabpanel">
    @{
        decimal? pronFoulsHome = null;
        decimal? pronFoulsAway = null;
        decimal? pronFoulsTotal = null;

        var esitoFouls = Model.Data.Prediction?.Esito;
        var foulsMetrics = Model.Data.Fouls?.Metrics;

        if (!string.IsNullOrWhiteSpace(esitoFouls) && foulsMetrics != null && foulsMetrics.Count > 0)
        {
            Func<string, string, decimal?> getFoulsMetric = (baseName, side) =>
            {
                var sideCandidates = side.Equals("Home", StringComparison.OrdinalIgnoreCase)
                    ? new[] { "Home", "Casa" }
                    : new[] { "Away", "Ospite" };

                foreach (var sc in sideCandidates)
                {
                    var key1 = baseName + "-" + sc;
                    var key2 = baseName + " - " + sc;

                    if (foulsMetrics.TryGetValue(key1, out var raw) || foulsMetrics.TryGetValue(key2, out raw))
                    {
                        if (raw is null) continue;

                        if (decimal.TryParse(
                                Convert.ToString(raw, System.Globalization.CultureInfo.InvariantCulture),
                                System.Globalization.NumberStyles.Any,
                                System.Globalization.CultureInfo.InvariantCulture,
                                out var val))
                        {
                            if (val > 50m) val /= 100m;
                            return val;
                        }
                    }
                }

                return null;
            };

            var homeWon  = getFoulsMetric("Partite Vinte",      "Home");
            var homeDraw = getFoulsMetric("Partite Pareggiate", "Home");
            var homeLost = getFoulsMetric("Partite Perse",      "Home");

            var awayWon  = getFoulsMetric("Partite Vinte",      "Away");
            var awayDraw = getFoulsMetric("Partite Pareggiate", "Away");
            var awayLost = getFoulsMetric("Partite Perse",      "Away");

            switch (esitoFouls)
            {
                case "1":
                    pronFoulsHome = homeWon;
                    pronFoulsAway = awayLost;
                    break;

                case "1X":
                    if (homeWon.HasValue || homeDraw.HasValue)
                        pronFoulsHome = ((homeWon ?? 0m) + (homeDraw ?? 0m)) / 2m;

                    if (awayLost.HasValue || awayDraw.HasValue)
                        pronFoulsAway = ((awayLost ?? 0m) + (awayDraw ?? 0m)) / 2m;
                    break;

                case "X2":
                    if (homeLost.HasValue || homeDraw.HasValue)
                        pronFoulsHome = ((homeLost ?? 0m) + (homeDraw ?? 0m)) / 2m;

                    if (awayWon.HasValue || awayDraw.HasValue)
                        pronFoulsAway = ((awayWon ?? 0m) + (awayDraw ?? 0m)) / 2m;
                    break;

                case "2":
                    pronFoulsHome = homeLost;
                    pronFoulsAway = awayWon;
                    break;
            }

            if (pronFoulsHome.HasValue && pronFoulsAway.HasValue)
                pronFoulsTotal = pronFoulsHome + pronFoulsAway;
        }
    }

    @if (pronFoulsHome.HasValue || pronFoulsAway.HasValue || pronFoulsTotal.HasValue)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Falli Home</span>
                    <span class="fs-5">@pronFoulsHome?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Falli Away</span>
                    <span class="fs-5">@pronFoulsAway?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Falli Totali</span>
                    <span class="fs-5">@pronFoulsTotal?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-12">
                <small class="text-muted">
                    Calcolati da Esito (@esitoFouls) usando le medie falli nelle partite vinte / pareggiate / perse.
                </small>
            </div>
                @* 🔹 QUOTE FALLI (da Odds, Description LIKE '%Foul%') *@
    @if (Model.Data.Odds != null && Model.Data.Odds.Any())
    {
        var foulOdds = Model.Data.Odds
            .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                        && o.Description.IndexOf("foul", StringComparison.OrdinalIgnoreCase) >= 0)
            .ToList();

        if (foulOdds.Any())
        {
            var foulMarkets = foulOdds
                .GroupBy(o => new { o.BetId, o.Description })
                .OrderBy(g => g.Key.BetId)
                .ToList();

            <div class="card mt-4">
                <div class="card-header">
                    Quote Falli (dati dai bookmaker)
                </div>

                <div class="card-body">

                    <div class="row g-3 align-items-center mb-3">
                        <div class="col-md-6">
                            <label for="foul-odds-select" class="form-label mb-1 fw-semibold">
                                Seleziona mercato Falli
                            </label>
                            <select id="foul-odds-select" class="form-select form-select-sm">
                                <option value="">-- Seleziona un mercato --</option>
                                @foreach (var market in foulMarkets)
                                {
                                    var key = $"{market.Key.BetId}_{market.Key.Description}";
                                    var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                    <option value="@key">
                                        @desc (@market.Key.BetId)
                                    </option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive d-none" id="foul-odds-wrapper">
                        <table class="table table-sm table-striped align-middle mb-0" id="foul-odds-table">
                            <thead>
                                <tr>
                                    <th scope="col">Selezione</th>
                                    <th scope="col">Quota</th>
                                    <th scope="col">Bookmaker</th>
                                    <th scope="col" class="text-end">Telegram</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var market in foulMarkets)
                                {
                                    var key = $"{market.Key.BetId}_{market.Key.Description}";
                                    foreach (var o in market.OrderBy(o => o.Value))
                                    {
                                        <tr data-market-key="@key">
                                            <td>@o.Value</td>
                                            <td>@o.Odd.ToString("0.00")</td>
                                            <td>
                                                @if (o.Bookmaker == 8)
                                                {
                                                    <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                                                }
                                                else
                                                {
                                                    @o.Bookmaker
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (User.HasClaim("plan", "1"))
                                                {
                                                    <form method="post"
                                                          asp-page-handler="SendOddsIdea"
                                                          class="d-inline">
                                                        @Html.AntiForgeryToken()

                                                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                        <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                        <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                        <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                        <input type="hidden" name="selectionValue" value="@o.Value" />
                                                        <input type="hidden" name="odd"
                                                               value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                        <button type="submit"
                                                                class="btn btn-sm btn-outline-success"
                                                                title="Invia su Telegram">
                                                            🚀
                                                        </button>
                                                    </form>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        }
    }

        </div>
    }

    @if (Model.Data.Fouls is null || Model.Data.Fouls.Metrics.Count == 0)
    {
        <div class="text-muted">Nessuna analisi falli disponibile.</div>
    }
    else
    {
        var metrics = Model.Data.Fouls.Metrics;

        bool hasSides = metrics.Keys.Any(k =>
            k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
            )
        );

        if (!hasSides)
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                    <tbody>
                        @foreach (var kv in metrics)
                        {
                            <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                ["Effettuati"] = "Media falli commessi",
                ["Fatti"] = "Media falli commessi",
                ["Subiti"] = "Media falli subiti",
                ["In Casa"] = "Media falli commessi in casa",
                ["Fuoricasa"] = "Media falli commessi in trasferta",
                ["Ultime 5"] = "Media falli (ultime 5 partite)",
                ["Partite Vinte"] = "Media falli nelle partite vinte",
                ["Partite Pareggiate"] = "Media falli nelle partite pareggiate",
                ["Partite Perse"] = "Media falli nelle partite perse"
            };

            var groups = metrics
                .Select(kv =>
                {
                    var key = kv.Key?.Trim() ?? "";
                    var lastDash = key.LastIndexOf('-');
                    var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                    var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                    return new { baseName, side, value = kv.Value };
                })
                .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                );

            string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
            var orderedKeys = groups.Keys
                .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                .ThenBy(k => k);

            var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
            var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

            <div class="vstack gap-3">
                @foreach (var key in orderedKeys)
                {
                    var row = groups[key];
                    var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                    <div class="mb-2">
                        <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                        <div class="row g-2 pt-2">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>



<!-- ANALISI: Fuorigioco -->
<div class="tab-pane fade" id="tab-offsides" role="tabpanel">
    @{
        decimal? pronOffsHome = null;
        decimal? pronOffsAway = null;
        decimal? pronOffsTotal = null;

        var esitoOffs = Model.Data.Prediction?.Esito;
        var offsMetrics = Model.Data.Offsides?.Metrics;

        if (!string.IsNullOrWhiteSpace(esitoOffs) && offsMetrics != null && offsMetrics.Count > 0)
        {
            Func<string, string, decimal?> getOffsMetric = (baseName, side) =>
            {
                var sideCandidates = side.Equals("Home", StringComparison.OrdinalIgnoreCase)
                    ? new[] { "Home", "Casa" }
                    : new[] { "Away", "Ospite" };

                foreach (var sc in sideCandidates)
                {
                    var key1 = baseName + "-" + sc;
                    var key2 = baseName + " - " + sc;

                    if (offsMetrics.TryGetValue(key1, out var raw) || offsMetrics.TryGetValue(key2, out raw))
                    {
                        if (raw is null) continue;

                        if (decimal.TryParse(
                                Convert.ToString(raw, System.Globalization.CultureInfo.InvariantCulture),
                                System.Globalization.NumberStyles.Any,
                                System.Globalization.CultureInfo.InvariantCulture,
                                out var val))
                        {
                            if (val > 50m) val /= 100m;
                            return val;
                        }
                    }
                }

                return null;
            };

            var homeWon  = getOffsMetric("Partite Vinte",      "Home");
            var homeDraw = getOffsMetric("Partite Pareggiate", "Home");
            var homeLost = getOffsMetric("Partite Perse",      "Home");

            var awayWon  = getOffsMetric("Partite Vinte",      "Away");
            var awayDraw = getOffsMetric("Partite Pareggiate", "Away");
            var awayLost = getOffsMetric("Partite Perse",      "Away");

            switch (esitoOffs)
            {
                case "1":
                    pronOffsHome = homeWon;
                    pronOffsAway = awayLost;
                    break;

                case "1X":
                    if (homeWon.HasValue || homeDraw.HasValue)
                        pronOffsHome = ((homeWon ?? 0m) + (homeDraw ?? 0m)) / 2m;

                    if (awayLost.HasValue || awayDraw.HasValue)
                        pronOffsAway = ((awayLost ?? 0m) + (awayDraw ?? 0m)) / 2m;
                    break;

                case "X2":
                    if (homeLost.HasValue || homeDraw.HasValue)
                        pronOffsHome = ((homeLost ?? 0m) + (homeDraw ?? 0m)) / 2m;

                    if (awayWon.HasValue || awayDraw.HasValue)
                        pronOffsAway = ((awayWon ?? 0m) + (awayDraw ?? 0m)) / 2m;
                    break;

                case "2":
                    pronOffsHome = homeLost;
                    pronOffsAway = awayWon;
                    break;
            }

            if (pronOffsHome.HasValue && pronOffsAway.HasValue)
                pronOffsTotal = pronOffsHome + pronOffsAway;
        }
    }

    @if (pronOffsHome.HasValue || pronOffsAway.HasValue || pronOffsTotal.HasValue)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Fuorigioco Home</span>
                    <span class="fs-5">@pronOffsHome?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Fuorigioco Away</span>
                    <span class="fs-5">@pronOffsAway?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Fuorigioco Totali</span>
                    <span class="fs-5">@pronOffsTotal?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-12">
                <small class="text-muted">
                    Calcolati da Esito (@esitoOffs) usando le medie fuorigioco nelle partite vinte / pareggiate / perse.
                </small>
            </div>
                @* 🔹 QUOTE FUORIGIOCO (da Odds, Description LIKE '%Offside%') *@
    @if (Model.Data.Odds != null && Model.Data.Odds.Any())
    {
        var offsidesOdds = Model.Data.Odds
            .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                        && o.Description.IndexOf("offside", StringComparison.OrdinalIgnoreCase) >= 0)
            .ToList();

        if (offsidesOdds.Any())
        {
            var offsidesMarkets = offsidesOdds
                .GroupBy(o => new { o.BetId, o.Description })
                .OrderBy(g => g.Key.BetId)
                .ToList();

            <div class="card mt-4">
                <div class="card-header">
                    Quote Fuorigioco (dati dai bookmaker)
                </div>

                <div class="card-body">

                    <div class="row g-3 align-items-center mb-3">
                        <div class="col-md-6">
                            <label for="offsides-odds-select" class="form-label mb-1 fw-semibold">
                                Seleziona mercato Fuorigioco
                            </label>
                            <select id="offsides-odds-select" class="form-select form-select-sm">
                                <option value="">-- Seleziona un mercato --</option>
                                @foreach (var market in offsidesMarkets)
                                {
                                    var key = $"{market.Key.BetId}_{market.Key.Description}";
                                    var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                    <option value="@key">
                                        @desc (@market.Key.BetId)
                                    </option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive d-none" id="offsides-odds-wrapper">
                        <table class="table table-sm table-striped align-middle mb-0" id="offsides-odds-table">
                            <thead>
                                <tr>
                                    <th scope="col">Selezione</th>
                                    <th scope="col">Quota</th>
                                    <th scope="col">Bookmaker</th>
                                    <th scope="col" class="text-end">Telegram</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var market in offsidesMarkets)
                                {
                                    var key = $"{market.Key.BetId}_{market.Key.Description}";
                                    foreach (var o in market.OrderBy(o => o.Value))
                                    {
                                        <tr data-market-key="@key">
                                            <td>@o.Value</td>
                                            <td>@o.Odd.ToString("0.00")</td>
                                            <td>
                                                @if (o.Bookmaker == 8)
                                                {
                                                    <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                                                }
                                                else
                                                {
                                                    @o.Bookmaker
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (User.HasClaim("plan", "1"))
                                                {
                                                    <form method="post"
                                                          asp-page-handler="SendOddsIdea"
                                                          class="d-inline">
                                                        @Html.AntiForgeryToken()

                                                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                        <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                        <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                        <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                        <input type="hidden" name="selectionValue" value="@o.Value" />
                                                        <input type="hidden" name="odd"
                                                               value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                        <button type="submit"
                                                                class="btn btn-sm btn-outline-success"
                                                                title="Invia su Telegram">
                                                            🚀
                                                        </button>
                                                    </form>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        }
    }

        </div>
    }

    @if (Model.Data.Offsides is null || Model.Data.Offsides.Metrics.Count == 0)
    {
        <div class="text-muted">Nessuna analisi fuorigioco disponibile.</div>
    }
    else
    {
        var metrics = Model.Data.Offsides.Metrics;

        bool hasSides = metrics.Keys.Any(k =>
            k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
            )
        );

        if (!hasSides)
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                    <tbody>
                        @foreach (var kv in metrics)
                        {
                            <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                ["Fatti"] = "Media fuorigioco commessi",
                ["Effettuati"] = "Media fuorigioco commessi",
                ["Subiti"] = "Media fuorigioco avversari",
                ["In Casa"] = "Media fuorigioco commessi in casa",
                ["Fuoricasa"] = "Media fuorigioco commessi in trasferta",
                ["Ultime 5"] = "Media fuorigioco (ultime 5 partite)",
                ["Partite Vinte"] = "Media fuorigioco nelle partite vinte",
                ["Partite Pareggiate"] = "Media fuorigioco nelle partite pareggiate",
                ["Partite Perse"] = "Media fuorigioco nelle partite perse"
            };

            var groups = metrics
                .Select(kv =>
                {
                    var key = kv.Key?.Trim() ?? "";
                    var lastDash = key.LastIndexOf('-');
                    var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                    var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                    return new { baseName, side, value = kv.Value };
                })
                .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i => string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i => string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) || string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                );

            string[] desiredOrder = { "Effettuati", "Subiti", "In Casa", "Fuoricasa", "Ultime 5", "Partite Vinte", "Partite Pareggiate", "Partite Perse" };
            var orderedKeys = groups.Keys
                .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                .ThenBy(k => k);

            var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
            var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

            <div class="vstack gap-3">
                @foreach (var key in orderedKeys)
                {
                    var row = groups[key];
                    var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                    <div class="mb-2">
                        <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                        <div class="row g-2 pt-2">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>



<!-- ANALISI: Tiri -->
<div class="tab-pane fade" id="tab-shots" role="tabpanel">
    @{
        decimal? pronShotsHome = null;
        decimal? pronShotsAway = null;
        decimal? pronShotsTotal = null;

        var esitoShots = (Model.Data.Prediction?.Esito ?? "")
            .Trim()
            .ToUpperInvariant();

        var shotsMetrics = Model.Data.Shots?.Metrics;

        if (!string.IsNullOrWhiteSpace(esitoShots) && shotsMetrics != null && shotsMetrics.Count > 0)
        {
            // Helper per leggere le metriche tiri (Effettuati, In Casa, Fuoricasa, Partite Vinte/Pareggiate/Perse)
            Func<string, string, decimal?> getShotsMetric = (baseName, side) =>
            {
                var sideCandidates = side.Equals("Home", StringComparison.OrdinalIgnoreCase)
                    ? new[] { "Home", "Casa" }
                    : new[] { "Away", "Ospite" };

                foreach (var sc in sideCandidates)
                {
                    var key1 = baseName + "-" + sc;
                    var key2 = baseName + " - " + sc;

                    if (shotsMetrics.TryGetValue(key1, out var raw) || shotsMetrics.TryGetValue(key2, out raw))
                    {
                        if (raw is null) continue;

                        if (decimal.TryParse(
                                Convert.ToString(raw, System.Globalization.CultureInfo.InvariantCulture),
                                System.Globalization.NumberStyles.Any,
                                System.Globalization.CultureInfo.InvariantCulture,
                                out var val))
                        {
                            // Protezione caso valori scalati x100
                            if (val > 50m) val /= 100m;
                            return val;
                        }
                    }
                }

                return null;
            };

            // 🔹 HOME: medie generali + per esito
            var homeEff       = getShotsMetric("Effettuati",         "Home"); // media tiri effettuati totali
            var homeInCasa    = getShotsMetric("In Casa",            "Home"); // media tiri effettuati in casa
            var homeWon       = getShotsMetric("Partite Vinte",      "Home");
            var homeDraw      = getShotsMetric("Partite Pareggiate", "Home");
            var homeLost      = getShotsMetric("Partite Perse",      "Home");

            // 🔹 AWAY: medie generali + per esito
            var awayEff       = getShotsMetric("Effettuati",         "Away"); // media tiri effettuati totali
            var awayFuoriCasa = getShotsMetric("Fuoricasa",          "Away"); // media tiri effettuati in trasferta
            var awayWon       = getShotsMetric("Partite Vinte",      "Away");
            var awayDraw      = getShotsMetric("Partite Pareggiate", "Away");
            var awayLost      = getShotsMetric("Partite Perse",      "Away");

            switch (esitoShots)
            {
                case "1":
                    // Casa favorita:
                    // (Effettuati + In Casa + Partite Vinte + Partite Pareggiate) / 4
                    if (homeEff.HasValue || homeInCasa.HasValue || homeWon.HasValue || homeDraw.HasValue)
                    {
                        var hEff  = homeEff    ?? 0m;
                        var hHome = homeInCasa ?? 0m;
                        var hWin  = homeWon    ?? 0m;
                        var hDraw = homeDraw   ?? 0m;
                        pronShotsHome = (hEff + hHome + hWin + hDraw) / 4m;
                    }

                    // Ospite sfavorita:
                    // (Effettuati + Fuoricasa + Partite Perse + Partite Pareggiate) / 4
                    if (awayEff.HasValue || awayFuoriCasa.HasValue || awayLost.HasValue || awayDraw.HasValue)
                    {
                        var aEff  = awayEff       ?? 0m;
                        var aAway = awayFuoriCasa ?? 0m;
                        var aLos  = awayLost      ?? 0m;
                        var aDraw = awayDraw      ?? 0m;
                        pronShotsAway = (aEff + aAway + aLos + aDraw) / 4m;
                    }
                    break;

                case "2":
                    // Casa sfavorita:
                    // (Effettuati + In Casa + Partite Perse + Partite Pareggiate) / 4
                    if (homeEff.HasValue || homeInCasa.HasValue || homeLost.HasValue || homeDraw.HasValue)
                    {
                        var hEff  = homeEff    ?? 0m;
                        var hHome = homeInCasa ?? 0m;
                        var hLos  = homeLost   ?? 0m;
                        var hDraw = homeDraw   ?? 0m;
                        pronShotsHome = (hEff + hHome + hLos + hDraw) / 4m;
                    }

                    // Ospite favorita:
                    // (Effettuati + Fuoricasa + Partite Vinte + Partite Pareggiate) / 4
                    if (awayEff.HasValue || awayFuoriCasa.HasValue || awayWon.HasValue || awayDraw.HasValue)
                    {
                        var aEff  = awayEff       ?? 0m;
                        var aAway = awayFuoriCasa ?? 0m;
                        var aWin  = awayWon       ?? 0m;
                        var aDraw = awayDraw      ?? 0m;
                        pronShotsAway = (aEff + aAway + aWin + aDraw) / 4m;
                    }
                    break;

                case "1X":
                    // Casa non perde:
                    // (Effettuati + In Casa + Partite Vinte + Partite Pareggiate) / 4
                    if (homeEff.HasValue || homeInCasa.HasValue || homeWon.HasValue || homeDraw.HasValue)
                    {
                        var hEff  = homeEff    ?? 0m;
                        var hHome = homeInCasa ?? 0m;
                        var hWin  = homeWon    ?? 0m;
                        var hDraw = homeDraw   ?? 0m;
                        pronShotsHome = (hEff + hHome + hWin + hDraw) / 4m;
                    }

                    // Ospite (meno favorita):
                    // (Effettuati + Fuoricasa + Partite Perse + Partite Pareggiate) / 4
                    if (awayEff.HasValue || awayFuoriCasa.HasValue || awayLost.HasValue || awayDraw.HasValue)
                    {
                        var aEff  = awayEff       ?? 0m;
                        var aAway = awayFuoriCasa ?? 0m;
                        var aLos  = awayLost      ?? 0m;
                        var aDraw = awayDraw      ?? 0m;
                        pronShotsAway = (aEff + aAway + aLos + aDraw) / 4m;
                    }
                    break;

                case "X2":
                    // ✅ Casa (sfavorita / può soffrire) – come da tua regola:
                    //  Media tiri effettuati
                    //  + Media tiri effettuati in casa
                    //  + Media tiri nelle partite pareggiate
                    //  + Media tiri nelle partite perse
                    //  / 4
                    if (homeEff.HasValue || homeInCasa.HasValue || homeDraw.HasValue || homeLost.HasValue)
                    {
                        var hEff  = homeEff    ?? 0m;
                        var hHome = homeInCasa ?? 0m;
                        var hDraw = homeDraw   ?? 0m;
                        var hLos  = homeLost   ?? 0m;
                        pronShotsHome = (hEff + hHome + hDraw + hLos) / 4m;
                    }

                    // ✅ Trasferta (favorita) – come da tua regola:
                    //  Media tiri effettuati
                    //  + Media tiri effettuati in trasferta
                    //  + Media tiri nelle partite pareggiate
                    //  + Media tiri nelle partite vinte
                    //  / 4
                    if (awayEff.HasValue || awayFuoriCasa.HasValue || awayDraw.HasValue || awayWon.HasValue)
                    {
                        var aEff  = awayEff       ?? 0m;
                        var aAway = awayFuoriCasa ?? 0m;
                        var aDraw = awayDraw      ?? 0m;
                        var aWin  = awayWon       ?? 0m;
                        pronShotsAway = (aEff + aAway + aDraw + aWin) / 4m;
                    }
                    break;

                case "X":
                    // Pareggio secco:
                    // Casa:  (Effettuati + In Casa + Partite Pareggiate) / 3
                    if (homeEff.HasValue || homeInCasa.HasValue || homeDraw.HasValue)
                    {
                        var hEff  = homeEff    ?? 0m;
                        var hHome = homeInCasa ?? 0m;
                        var hDraw = homeDraw   ?? 0m;
                        pronShotsHome = (hEff + hHome + hDraw) / 3m;
                    }

                    // Ospite: (Effettuati + Fuoricasa + Partite Pareggiate) / 3
                    if (awayEff.HasValue || awayFuoriCasa.HasValue || awayDraw.HasValue)
                    {
                        var aEff  = awayEff       ?? 0m;
                        var aAway = awayFuoriCasa ?? 0m;
                        var aDraw = awayDraw      ?? 0m;
                        pronShotsAway = (aEff + aAway + aDraw) / 3m;
                    }
                    break;

                default:
                    pronShotsHome = null;
                    pronShotsAway = null;
                    break;
            }

            if (pronShotsHome.HasValue && pronShotsAway.HasValue)
                pronShotsTotal = pronShotsHome + pronShotsAway;
        }
    }


    @* 🔹 Box pronostico tiri *@
    @if (pronShotsHome.HasValue || pronShotsAway.HasValue || pronShotsTotal.HasValue)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Tiri Home</span>
                    <span class="fs-5">@pronShotsHome?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Tiri Away</span>
                    <span class="fs-5">@pronShotsAway?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-light d-flex flex-column">
                    <span class="fw-semibold">Pronostico Tiri Totali</span>
                    <span class="fs-5">@pronShotsTotal?.ToString("0.00")</span>
                </div>
            </div>
            <div class="col-12">
                <small class="text-muted">
                    Calcolati da Esito (@esitoShots) usando le medie tiri nelle partite vinte / pareggiate / perse.
                </small>
            </div>
        </div>

        @* 🔹 QUOTE TIRI (da Odds, Description LIKE '%shot%') *@
        @if (Model.Data.Odds != null && Model.Data.Odds.Any())
        {
            var shotsOdds = Model.Data.Odds
                .Where(o => !string.IsNullOrWhiteSpace(o.Description)
                            && o.Description.IndexOf("shot", StringComparison.OrdinalIgnoreCase) >= 0)
                .ToList();

            if (shotsOdds.Any())
            {
                var shotsMarkets = shotsOdds
                    .GroupBy(o => new { o.BetId, o.Description })
                    .OrderBy(g => g.Key.BetId)
                    .ToList();

                <div class="card mt-4">
                    <div class="card-header">
                        Quote Tiri (dati dai bookmaker)
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-6">
                                <label for="shots-odds-select" class="form-label mb-1 fw-semibold">
                                    Seleziona mercato Tiri
                                </label>
                                <select id="shots-odds-select" class="form-select form-select-sm">
                                    <option value="">-- Seleziona un mercato --</option>
                                    @foreach (var market in shotsMarkets)
                                    {
                                        var key  = $"{market.Key.BetId}_{market.Key.Description}";
                                        var desc = market.Key.Description ?? $"Bet {market.Key.BetId}";
                                        <option value="@key">
                                            @desc (@market.Key.BetId)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive d-none" id="shots-odds-wrapper">
                            <table class="table table-sm table-striped align-middle mb-0" id="shots-odds-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Selezione</th>
                                        <th scope="col">Quota</th>
                                        <th scope="col">Bookmaker</th>
                                        <th scope="col" class="text-end">Telegram</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var market in shotsMarkets)
                                    {
                                        var key = $"{market.Key.BetId}_{market.Key.Description}";
                                        foreach (var o in market.OrderBy(o => o.Value))
                                        {
                                            <tr data-market-key="@key">
                                                <td>@o.Value</td>
                                                <td>@o.Odd.ToString("0.00")</td>
                                                <td>
                                                    @if (o.Bookmaker == 8)
                                                    {
                                                        <img src="/img/bet365.png" alt="Bet365" class="bookmaker-logo" />
                                                    }
                                                    else
                                                    {
                                                        @o.Bookmaker
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    @if (User.HasClaim("plan", "1"))
                                                    {
                                                        <form method="post"
                                                              asp-page-handler="SendOddsIdea"
                                                              class="d-inline">
                                                            @Html.AntiForgeryToken()

                                                            <input type="hidden" name="id" value="@Model.Data.MatchId" />
                                                            <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                                                            <input type="hidden" name="betId" value="@market.Key.BetId" />
                                                            <input type="hidden" name="marketDescription" value="@market.Key.Description" />
                                                            <input type="hidden" name="selectionValue" value="@o.Value" />
                                                            <input type="hidden" name="odd"
                                                                   value="@o.Odd.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

                                                            <button type="submit"
                                                                    class="btn btn-sm btn-outline-success"
                                                                    title="Invia">
                                                                🚀
                                                            </button>
                                                        </form>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

            }
        }
    }

    @* 🔹 Tabella metrica tiri *@
    @if (Model.Data.Shots is null || Model.Data.Shots.Metrics.Count == 0)
    {
        <div class="text-muted">Nessuna analisi tiri disponibile.</div>
    }
    else
    {
        var metrics = Model.Data.Shots.Metrics;

        bool hasSides = metrics.Keys.Any(k =>
            k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
            )
        );

        if (!hasSides)
        {
            <div class="table-responsive mt-3">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="width:60%;">Metrica</th>
                            <th class="text-end">Valore</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var kv in metrics)
                        {
                            <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            var labelMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                ["Effettuati"]       = "Media tiri effettuati",
                ["Subiti"]           = "Media tiri subiti",
                ["In Casa"]          = "Media tiri effettuati in casa",
                ["Fuoricasa"]        = "Media tiri effettuati in trasferta",
                ["Ultime 5"]         = "Media tiri (ultime 5 partite)",
                ["Partite Vinte"]    = "Media tiri nelle partite vinte",
                ["Partite Pareggiate"]= "Media tiri nelle partite pareggiate",
                ["Partite Perse"]    = "Media tiri nelle partite perse"
            };

            var groups = metrics
                .Select(kv =>
                {
                    var key = kv.Key?.Trim() ?? "";
                    var lastDash = key.LastIndexOf('-');
                    var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                    var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                    return new { baseName, side, value = kv.Value };
                })
                .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                                string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                                string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                                string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                                string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                );

            string[] desiredOrder = new[] {
                "Effettuati","Subiti","In Casa","Fuoricasa",
                "Ultime 5","Partite Vinte","Partite Pareggiate","Partite Perse"
            };

            var orderedKeys = groups.Keys
                .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                .ThenBy(k => k);

            var homeName = string.IsNullOrWhiteSpace(Model.Data.Home) ? "Casa" : Model.Data.Home;
            var awayName = string.IsNullOrWhiteSpace(Model.Data.Away) ? "Ospite" : Model.Data.Away;

            <div class="vstack gap-3 mt-3">
                @foreach (var key in orderedKeys)
                {
                    var row = groups[key];
                    var niceLabel = labelMap.TryGetValue(key, out var label) ? label : key;

                    <div class="mb-2">
                        <div class="fw-semibold border-bottom pb-1">@niceLabel</div>
                        <div class="row g-2 pt-2">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@homeName</span><span class="fw-bold">@row.Casa</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded d-flex justify-content-between">
                                    <span>@awayName</span><span class="fw-bold">@row.Ospite</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>



        <!-- PRONOSTICI: Exchange -->
        <div class="tab-pane fade" id="tab-exchange" role="tabpanel">
            @if (Model.Data.Exchange is null)
            {
                <div class="text-muted">Nessun dato Exchange disponibile.</div>
            }
            else
            {
                var e = Model.Data.Exchange;

                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Bancata consigliata</strong></span><span>@e.BancataConsigliata</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 1 – Affidabilità</span><span>@e.Banca1Affidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca X – Affidabilità</span><span>@e.BancaXAffidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 2 – Affidabilità</span><span>@e.Banca2Affidabilita%</span></li>
                    <li class="list-group-item"><strong>Top lay risultati esatti:</strong> @e.BancaRisultato1, @e.BancaRisultato2, @e.BancaRisultato3</li>
                </ul>

                    @if (canUseAi || User.IsInRole("SuperAdmin"))

                {
                    string? best1x2 = null;
                    if (e is not null)
                    {
                        var items = new List<(string key, int? val)>
                        { ("1", e.Banca1Affidabilita), ("X", e.BancaXAffidabilita), ("2", e.Banca2Affidabilita) };

                        var best = items.Where(i => i.val.HasValue)
                        .OrderByDescending(i => i.val!.Value)
                        .FirstOrDefault();

                        if (best.val.HasValue) best1x2 = best.key;
                    }

                    <form method="post" asp-page-handler="SendExchange" class="mt-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                        <input type="hidden" name="topicName" value="ExchangeDaPubblicare" />

                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Bancata consigliata</label>
                                <select name="customLay" class="form-select">
                                    <option value="">-- Seleziona --</option>
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato1))
                                    {
                                        <option value="@e.BancaRisultato1">@e.BancaRisultato1</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato2))
                                    {
                                        <option value="@e.BancaRisultato2">@e.BancaRisultato2</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato3))
                                    {
                                        <option value="@e.BancaRisultato3">@e.BancaRisultato3</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(best1x2))
                                    {
                                        <option value="@best1x2">@best1x2</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Livello di rischio</label>
                                <select name="riskLevel" class="form-select">
                                    <option value="Basso">Basso</option>
                                    <option value="Medio">Medio</option>
                                    <option value="Alto">Alto</option>
                                </select>
                            </div>

                            <div class="col-md-3 text-end">
                                <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                            </div>
                        </div>
                    </form>
                }
            }
        </div>
    </div>

     <!-- Script per gruppi -->
    <script>
        (function () {
            const btnPron = document.getElementById('btnGroupPron');
            const btnAnal = document.getElementById('btnGroupAnal');
            const tabsUl  = document.getElementById('matchTabs');

            function showGroup(group) {
                tabsUl.querySelectorAll('.group-pron').forEach(li => li.classList.toggle('d-none', group !== 'pron'));
                tabsUl.querySelectorAll('.group-anal').forEach(li => li.classList.toggle('d-none', group !== 'anal'));

                if (group === 'pron') {
                    btnPron.classList.add('btn-primary'); btnPron.classList.remove('btn-outline-primary');
                    btnAnal.classList.add('btn-outline-primary'); btnAnal.classList.remove('btn-primary');
                } else {
                    btnAnal.classList.add('btn-primary'); btnAnal.classList.remove('btn-outline-primary');
                    btnPron.classList.add('btn-outline-primary'); btnPron.classList.remove('btn-primary');
                }

                const activeBtn = tabsUl.querySelector('.nav-link.active');
                const activeLi  = activeBtn ? activeBtn.closest('li') : null;
                const activeIsInGroup = activeLi && !activeLi.classList.contains('d-none');

                if (!activeIsInGroup) {
                    const firstVisible = tabsUl.querySelector(group === 'pron' ? '.group-pron .nav-link' : '.group-anal .nav-link');
                    if (firstVisible) firstVisible.click();
                }
            }

            btnPron?.addEventListener('click', () => showGroup('pron'));
            btnAnal?.addEventListener('click', () => showGroup('anal'));

            document.addEventListener('DOMContentLoaded', () => showGroup('pron'));
        })();

                // 🔹 Analisi → Tiri → Odds
        (function () {
            const select  = document.getElementById('shots-odds-select');
            const wrapper = document.getElementById('shots-odds-wrapper');
            const rows    = document.querySelectorAll('#shots-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateShotsOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateShotsOdds);
            updateShotsOdds();
        })();

    </script>

    </div> <!-- chiude .container -->
</div> <!-- chiude .details-page -->

<!-- Overlay caricamento AI -->
<div id="aiLoadingOverlay" class="loading-overlay d-none" aria-hidden="true">
    <div class="loading-panel">
        <div class="spinner-border" role="status" aria-label="Caricamento"></div>
        <div id="aiLoadingMessage" class="fw-semibold">Caricamento…</div>
    </div>
</div>

@section Scripts {
    <script type="module" src="https://widgets.api-sports.io/3.1.0/widgets.js"></script>
    <script>
        // 🔹 Filtro BetId nel tab Quote
        (function () {
            const select = document.getElementById('betid-filter');
            const rows = document.querySelectorAll('#odds-table tbody tr');
            if (!select || !rows.length) return;

            select.addEventListener('change', function () {
                const val = this.value;
                rows.forEach(row => {
                    const rowBetId = row.getAttribute('data-betid');
                    if (!val || rowBetId === val) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        })();

        // 🔹 Pronostici → Odds
        (function () {
            const select  = document.getElementById('pronostici-odds-select');
            const wrapper = document.getElementById('pronostici-odds-wrapper');
            const rows    = document.querySelectorAll('#pronostici-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updatePronosticiOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updatePronosticiOdds);
            updatePronosticiOdds();
        })();

         // 🔹 Analisi → Cartellini → Odds
        (function () {
            const select  = document.getElementById('cards-odds-select');
            const wrapper = document.getElementById('cards-odds-wrapper');
            const rows    = document.querySelectorAll('#cards-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateCardsOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateCardsOdds);
            updateCardsOdds();
        })();

                // 🔹 FALLI – filtro quote per mercato
        (function () {
            const select  = document.getElementById('foul-odds-select');
            const wrapper = document.getElementById('foul-odds-wrapper');
            const rows    = document.querySelectorAll('#foul-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateFoulOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateFoulOdds);
            updateFoulOdds();
        })();

        // 🔹 FUORIGIOCO – filtro quote per mercato
        (function () {
            const select  = document.getElementById('offsides-odds-select');
            const wrapper = document.getElementById('offsides-odds-wrapper');
            const rows    = document.querySelectorAll('#offsides-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateOffsidesOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateOffsidesOdds);
            updateOffsidesOdds();
        })();

        // 🔹 Analisi → Goal Attesi → Odds
        (function () {
            const select  = document.getElementById('goal-odds-select');
            const wrapper = document.getElementById('goal-odds-wrapper');
            const rows    = document.querySelectorAll('#goal-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateGoalOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateGoalOdds);
            updateGoalOdds();
        })();
                // 🔹 Analisi → Corner → Odds
        (function () {
            const select  = document.getElementById('corner-odds-select');
            const wrapper = document.getElementById('corner-odds-wrapper');
            const rows    = document.querySelectorAll('#corner-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateCornerOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateCornerOdds);
            updateCornerOdds();
        })();


        // 🔹 Analisi → Cartellini → Odds
        (function () {
            const select  = document.getElementById('card-odds-select');
            const wrapper = document.getElementById('card-odds-wrapper');
            const rows    = document.querySelectorAll('#card-odds-table tbody tr');
            if (!select || !rows.length || !wrapper) return;

            function updateCardOdds() {
                const key = select.value;

                if (!key) {
                    wrapper.classList.add('d-none');
                    rows.forEach(row => {
                        row.style.display = 'none';
                    });
                    return;
                }

                wrapper.classList.remove('d-none');
                rows.forEach(row => {
                    const rowKey = row.getAttribute('data-market-key');
                    row.style.display = (rowKey === key) ? '' : 'none';
                });
            }

            select.addEventListener('change', updateCardOdds);
            updateCardOdds();
        })();
    </script>
    <script>
(function () {
    let SNOW_COUNT = 50;

    // Se mobile / viewport piccola, riduci i fiocchi
    if (window.matchMedia('(max-width: 768px)').matches) {
        SNOW_COUNT = 15; // o 10, prova tu
    }

    const container = document.getElementById('snow-container');
    if (!container) return;

    for (let i = 0; i < SNOW_COUNT; i++) {
        createSnowflake();
    }

    function createSnowflake() {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = '❄';

        const size = Math.random() * 12 + 8; // 8px - 20px
        flake.style.fontSize = size + 'px';

        flake.style.left = Math.random() * 100 + 'vw';
        flake.style.animationDuration = (Math.random() * 10 + 10) + 's';
        flake.style.opacity = Math.random();
        flake.style.transform = `translateX(${Math.random() * 40 - 20}px)`;

        container.appendChild(flake);

        flake.addEventListener('animationend', () => {
            flake.remove();
            createSnowflake();
        });
    }
})();

    </script>
}



@section Styles {
    <text>
        <style>
            /* Stile generale (preso dal Layout) */
            body {
                background: linear-gradient(135deg, #252e40 0%, #1a2230 100%);
                color: #e9edf3;
                font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            }

            /* Card/list nel tema scuro */
            .details-page .card,
            .details-page .list-group-item,
            .details-page .dropdown-menu,
            .details-page .modal-content {
                background: rgba(255,255,255,0.06);
                border: 1px solid rgba(255,255,255,0.16);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                color: #e9edf3;
            }

            .details-page .card-header {
                background: rgba(255,255,255,0.06);
                border-bottom: 1px solid rgba(255,255,255,0.14);
            }

            /* 🛑 CORREZIONE FILTRI/OPACITÀ SUI CONTENITORI (Neutralizzazione) */
            /* Se un file esterno applica un filtro/opacità ad un genitore, questa lo annulla. */
            .details-page,
            .details-page .container,
            .details-page .tab-content {
                opacity: 1 !important;
                filter: none !important;
                -webkit-filter: none !important;
            }

 

                /* 🔧 REGOLA BASE PER LE TABELLE (Zebratura/Divisori Grigio Scuro) */
                .details-page .table {
                    --bs-table-color: #e9edf3;
                    --bs-table-bg: transparent;
                    --bs-table-border-color: rgba(255,255,255,.14);
                    --bs-table-striped-color: #e9edf3;
                    --bs-table-hover-bg: rgba(255,255,255,.10);
                    --bs-table-hover-color: #fff;
                }

                    /* Intestazione e testo generale */
                    .details-page .table thead th {
                        color: #f4f7fb;
                        background: rgba(255,255,255,.08);
                        border-bottom-color: rgba(255,255,255,.18);
                        white-space: nowrap;
                    }

                    /* Logica Zebratura */
                    .details-page .table tbody tr > * {
                        color: #e9edf3 !important;
                        border-top-color: rgba(255,255,255,.10);
                    }

                    .details-page .table.table-striped > tbody > tr:nth-of-type(odd) > * {
                        background-color: rgba(255,255,255,.08) !important;
                    }

                    .details-page .table.table-striped > tbody > tr:nth-of-type(even) > * {
                        background-color: rgba(0,0,0,.18) !important;
                    }

                /* --- FIX ANALISI: Sfondo Scuro e Testo Chiaro per BOX/STATISTICHE (.bg-light) --- */
                .details-page .bg-light,
                .details-page .p-2.bg-light,
                .details-page .vstack .bg-light {
                    background-color: rgba(255,255,255,.12) !important; /* Grisio scuro per il box */
                    color: #e9edf3 !important; /* Testo chiaro */
                    border: 1px solid rgba(255,255,255,.18);
                }


                /* --- Altri stili minori (per completezza) --- */
                .details-page .card-header {
                    border-bottom: 1px solid rgba(255,255,255,0.14);
                }

                .details-page .badge.bg-light.text-dark {
                    background: rgba(255,255,255,.85) !important;
                    color: #111 !important;
                }

                .details-page a {
                    color: #7bd3ff;
                }

                    .details-page a:hover {
                        color: #9be0ff;
                    }

                .details-page .form-control, .details-page .form-select {
                    background: rgba(255,255,255,.10);
                    border: 1px solid rgba(255,255,255,.24);
                    color: #fff;
                }

                    .details-page .form-control:focus, .details-page .form-select:focus {
                        border-color: #00c3ff;
                        box-shadow: 0 0 0 4px rgba(0,195,255,.18);
                    }

                .details-page .btn-primary {
                    background: #00baff;
                    border-color: #00baff;
                }

                    .details-page .btn-primary:hover {
                        background: #009cdc;
                        border-color: #009cdc;
                    }

                .details-page .btn-outline-secondary {
                    color: #e9edf3;
                    border-color: rgba(255,255,255,.28);
                }

                    .details-page .btn-outline-secondary:hover {
                        background: rgba(255,255,255,.10);
                    }

                .details-page .bg-light .fw-bold, .details-page .bg-light span, .details-page .bg-light small {
                    color: #e9edf3 !important;
                }
                

            .loading-overlay {
                position: fixed;
                inset: 0;
                background: rgba(10,14,20,0.65);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 5000;
                backdrop-filter: blur(2px);
            }

            .loading-panel {
                background: rgba(20,26,36,0.92);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.18);
                border-radius: .75rem;
                box-shadow: 0 12px 36px rgba(0,0,0,.35);
                padding: 1.25rem 1.5rem;
                display: flex;
                align-items: center;
                gap: .75rem;
                max-width: 90vw;
            }

                .loading-panel .spinner-border {
                    color: #fff;
                }

                            /* Fix leggibilità opzioni select in tema scuro */
            .details-page .form-select option {
                background-color: #1a2230;
                color: #e9edf3;
            }
            /* Evita che i tab si tengano l'altezza massima mai avuta (buco sotto i contenuti) */
.details-page .tab-content,
.details-page .tab-pane {
    min-height: 0 !important;
    height: auto !important;
}
/* 🔨 Hard reset di altezze e margini sulla pagina dettagli */
.details-page {
    min-height: 0 !important;
    height: auto !important;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
}

/* Il container centrale non deve forzare altezza */
.details-page > .container {
    min-height: 0 !important;
    height: auto !important;
    margin-bottom: 0 !important;
    padding-bottom: 1rem !important;
}

/* I tab non devono tenersi l'altezza “massima” mai avuta */
.details-page .tab-content {
    min-height: 0 !important;
    height: auto !important;
    margin-bottom: 0 !important;
    padding-bottom: 0.5rem !important;
}

/* Stessa cosa per ogni tab-pane */
.details-page .tab-pane {
    min-height: 0 !important;
    height: auto !important;
    margin-bottom: 0 !important;
}

/* Elimina eventuali margini collassati sotto l’ultimo elemento */
.details-page .tab-pane > :last-child {
    margin-bottom: 0 !important;
}
.details-page .bookmaker-logo {
    height: 30px;      /* abbastanza piccolo da non alzare la riga */
    width: auto;
    display: inline-block;
    vertical-align: middle;
}
    #snow-container-details {
        pointer-events: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        overflow: hidden;
    }

.snowflake {
    position: absolute;
    top: -10px;
    color: white;
    font-size: 1rem;
    user-select: none;
    animation: fall linear infinite;
    opacity: 0.9;
}

/* Su schermi piccoli: togli il drop-shadow e riduci dimensione */
@@media (max-width: 768px) {
    .snowflake {
        filter: none;           /* niente drop-shadow */
        font-size: 0.8rem;      /* più piccoli */
    }
}

@@media (prefers-reduced-motion: reduce) {
    .snowflake {
        animation: none !important;
    }
}

    @@keyframes fall-details {
        to {
            transform: translateY(110vh);
        }
    }
        </style>



    </text>
}