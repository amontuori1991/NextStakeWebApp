@page "/Match/Details"

@model NextStakeWebApp.Pages.Match.DetailsModel
@using System.Text.Json
@using System.Text.Encodings.Web
@using System.Text.Unicode

@{
    ViewData["Title"] = "Dettaglio Match";
}

<div class="container py-4">
    @* Messaggio di stato (TempData) *@
    @if (TempData["StatusMessage"] is string sm && !string.IsNullOrWhiteSpace(sm))
    {
        <div class="alert alert-info d-flex align-items-center gap-2">
            <span>ℹ️</span><span>@sm</span>
        </div>
    }

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
            @if (!string.IsNullOrWhiteSpace(Model.Data.LeagueLogo))
            {
                <img src="@Model.Data.LeagueLogo" alt="logo lega" style="height:22px;width:auto;" />
            }
            <h5 class="mb-0">@Model.Data.LeagueName</h5>
            @if (!string.IsNullOrWhiteSpace(Model.Data.CountryName))
            {
                <span class="badge bg-light text-dark">@Model.Data.CountryName</span>
            }
        </div>

        <div class="text-muted">
            @Model.Data.KickoffUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <!-- Match Widget (API-SPORTS) -->
    <div class="card mb-3">
        <div class="card-body">
            <api-sports-widget data-type="config"
                               data-key="9146b11baf44d94af6e14d347213d63a"
                               data-sport="football"
                               data-lang="it"
                               data-theme="white"
                               data-show-logos="true">
            </api-sports-widget>

            <api-sports-widget data-type="game"
                               data-game-id="@Model.Data.MatchId"
                               data-show-logos="true">
            </api-sports-widget>

            <noscript class="text-muted">
                Abilita JavaScript per visualizzare il widget della partita.
            </noscript>
        </div>
    </div>
    @{
        var aiPayloadObj = new
        {
            matchId = Model.Data.MatchId,
            leagueId = Model.Data.LeagueId,
            season = Model.Data.Season,
            home = Model.Data.Home,
            away = Model.Data.Away,

            goals = Model.Data.Goals?.Metrics,
            shots = Model.Data.Shots?.Metrics,
            corners = Model.Data.Corners?.Metrics,
            fouls = Model.Data.Fouls?.Metrics,
            cards = Model.Data.Cards?.Metrics,
            offsides = Model.Data.Offsides?.Metrics
        };

        // Encoder “safe” che non scappa i caratteri latini/italiani
        var aiPayloadJson = JsonSerializer.Serialize(
        aiPayloadObj,
        new JsonSerializerOptions
        {
            Encoder = JavaScriptEncoder.Create(UnicodeRanges.BasicLatin, UnicodeRanges.Latin1Supplement, UnicodeRanges.LatinExtendedA)
        }
        );
    }

    <!-- Azioni -->
    <div class="mb-3 d-flex gap-2">
        <form method="post" action="/Match/Details?handler=ToggleFavorite&id=@Model.Data.MatchId">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn @(Model.Data.IsFavorite ? "btn-warning" : "btn-outline-secondary")">⭐ Preferito</button>
        </form>

        <a class="btn btn-outline-secondary" href="/Events">← Torna agli eventi</a>

        @* === NUOVO: bottone AI pronostico (solo Admin/SuperAdmin) *@
        @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
        {
            <form method="post" asp-page-handler="PreviewAiPick" class="ms-auto">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Data.MatchId" />
                <textarea name="analysisPayload" hidden>@aiPayloadJson</textarea>
                <button type="submit" class="btn btn-primary">
                    🤖 Genera anteprima (AI)
                </button>
            </form>
        }

    </div>
    @* ANTEPRIMA AI (se presente in TempData) *@
    @if (TempData["AiPreview"] is string aiPrev && !string.IsNullOrWhiteSpace(aiPrev))
    {
        <div class="card border-success mb-3">
            <div class="card-header bg-success text-white">Anteprima messaggio (AI)</div>
            <div class="card-body">
                <div class="mb-3">
                    @* Mostra come HTML Telegram (abbiamo usato <b>, <em>, ecc.) *@
                    @Html.Raw(aiPrev.Replace("\n", "<br/>"))
                </div>

                <form method="post" asp-page-handler="SendAiPick" class="d-flex gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Data.MatchId" />
                    <input type="hidden" name="preview" value="@aiPrev" />
                    <button type="submit" class="btn btn-success">🚀 Invia su Telegram (Idee)</button>
                    <a class="btn btn-outline-secondary" href="/Match/Details?id=@Model.Data.MatchId">Annulla</a>
                </form>
            </div>
        </div>
    }


    <!-- Selettore gruppi -->
    <div class="d-flex justify-content-center">
        <div class="btn-group mb-2" role="group" aria-label="Selettore gruppi tab">
            <button id="btnGroupPron" type="button" class="btn btn-primary">Pronostici</button>
            <button id="btnGroupAnal" type="button" class="btn btn-outline-primary">Analisi</button>
        </div>
    </div>
    <div class="text-center text-danger fw-bold mb-3">
        GIORNATE MANCANTI: @Model.Data.RemainingMatches
    </div>

    <!-- Tabs contenuti -->
    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <!-- Gruppo: PRONOSTICI -->
        <li class="nav-item group-pron">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-picks" type="button" role="tab">
                Pronostici consigliati
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h" type="button" role="tab">
                Stato di forma (ultime 5)
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button" role="tab">
                Classifica
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" id="tab-exchange-tab" data-bs-toggle="tab" data-bs-target="#tab-exchange" type="button" role="tab">
                Exchange
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-h2h-all" type="button" role="tab">
                H2H
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-odds" type="button" role="tab">
                Quote
            </button>
        </li>

        <!-- Gruppo: ANALISI -->
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-shots" type="button" role="tab">
                Tiri
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-fouls" type="button" role="tab">
                Falli
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cards" type="button" role="tab">
                Cartellini
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-offsides" type="button" role="tab">
                Fuorigioco
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-goals" type="button" role="tab">
                Goal Attesi
            </button>
        </li>
        <li class="nav-item group-anal">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-corners" type="button" role="tab">
                Corner
            </button>
        </li>
        <li class="nav-item group-pron">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-club" type="button" role="tab">
                Statistiche Club
            </button>
        </li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3">
        <!-- PRONOSTICI: Pronostici consigliati -->
        <div class="tab-pane fade show active" id="tab-picks" role="tabpanel">
            @if (Model.Data.Prediction is null)
            {
                <div class="text-muted">Nessun pronostico disponibile.</div>
            }
            else
            {
                var p = Model.Data.Prediction;
                <div class="row g-3">
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Esito</strong></span><span>@p.Esito</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>GG/NG</strong></span><span>@p.GG_NG</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Over/Under</strong></span><span>@p.OverUnderRange</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Combo</strong></span><span>@p.ComboFinale</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span><strong>Goal simulati</strong></span>
                                <span>@p.GoalSimulatoCasa - @p.GoalSimulatoOspite (Tot: @p.TotaleGoalSimulati)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 1.5</strong></span><span>@p.Over1_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 2.5</strong></span><span>@p.Over2_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>% Over 3.5</strong></span><span>@p.Over3_5%</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Multigoal Casa</strong></span><span>@p.MultigoalCasa</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span><strong>Multigoal Ospite</strong></span><span>@p.MultigoalOspite</span></li>
                        </ul>
                    </div>
                </div>

                @if (User.IsInRole("Admin"))
                {
                    <form method="post" asp-page-handler="SendPrediction" class="mt-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                        <input type="hidden" name="topicName" value="PronosticiDaPubblicare" />

                        <div class="row g-2 align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Pronostico Consigliato (modificabile prima dell'invio)</label>
                                <input name="customPick" class="form-control" value="@Model.Data.Prediction?.ComboFinale" />
                            </div>
                            <div class="col-md-4 text-end">
                                <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                            </div>
                        </div>
                    </form>
                }
            }
        </div>

        <!-- PRONOSTICI: H2H (tutti) -->
        <div class="tab-pane fade" id="tab-h2h-all" role="tabpanel">
            <div class="card card-body text-center">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true">
                </api-sports-widget>

                <api-sports-widget data-type="h2h"
                                   data-h2h="@Model.Data.HomeId-@Model.Data.AwayId"
                                   data-show-logos="true">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare il widget H2H.
                </noscript>
            </div>
        </div>

        <!-- TAB: Statistiche Club -->
        <div class="tab-pane fade" id="tab-club" role="tabpanel">
            <div class="card card-body">
                <api-sports-widget data-type="config"
                                   data-key="9146b11baf44d94af6e14d347213d63a"
                                   data-sport="football"
                                   data-lang="it"
                                   data-theme="grey"
                                   data-show-logos="true"
                                   data-team-statistics="true">
                </api-sports-widget>

                <h5 class="text-center mt-3 mb-3 text-primary fw-bold">@Model.Data.Home</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.HomeId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <hr class="my-4" />

                <h5 class="text-center mt-3 mb-3 text-danger fw-bold">@Model.Data.Away</h5>
                <api-sports-widget data-type="team"
                                   data-team-id="@Model.Data.AwayId"
                                   data-league="@Model.Data.LeagueId"
                                   data-season="@Model.Data.Season"
                                   data-team-tab="statistics">
                </api-sports-widget>

                <noscript class="text-muted">
                    Abilita JavaScript per visualizzare le informazioni dettagliate delle squadre.
                </noscript>
            </div>
        </div>

        <!-- ANALISI: Goal Attesi -->
        <div class="tab-pane fade" id="tab-goals" role="tabpanel">
            @if (Model.Data.Goals is null || Model.Data.Goals.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi goal disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Goals.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th style="width:60%;">Metrica</th>
                                    <th class="text-end">Valore</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr>
                                        <td>@kv.Key</td>
                                        <td class="text-end">@kv.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    var orderedKeys = groups.Keys.OrderBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>Casa</span><span class="fw-bold">@row.Casa</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>Ospite</span><span class="fw-bold">@row.Ospite</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- PRONOSTICI: Stato di forma -->
        <div class="tab-pane fade" id="tab-h2h" role="tabpanel">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Home</h6>
                    @if (Model.Data.HomeForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.HomeForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>
                                            ;
                                        }
                                        else if (m.Result == "D")
                                        {

                                            <span class="badge bg-secondary">D</span>
                                            ;
                                        }
                                        else
                                        {

                                            <span class="badge bg-danger">L</span>
                                            ;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>

                <div class="col-md-6">
                    <h6 class="mb-2">Forma @Model.Data.Away</h6>
                    @if (Model.Data.AwayForm.Count == 0)
                    {
                        <div class="text-muted">Nessun dato.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var m in Model.Data.AwayForm)
                            {
                                <a asp-page="/Match/Details" asp-route-id="@m.MatchId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">@m.DateUtc.ToLocalTime().ToString("dd/MM")</small>
                                        <span class="ms-2">@m.Opponent</span>
                                        <span class="badge bg-light text-dark ms-2">@(m.IsHome ? "Casa" : "Trasferta")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span>@m.Score</span>
                                        @if (m.Result == "W")
                                        {
                                            <span class="badge bg-success">W</span>
                                            ;
                                        }
                                        else if (m.Result == "D")
                                        {

                                            <span class="badge bg-secondary">D</span>
                                            ;
                                        }
                                        else
                                        {

                                            <span class="badge bg-danger">L</span>
                                            ;
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- PRONOSTICI: Classifica -->
        <div class="tab-pane fade" id="tab-table" role="tabpanel">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="fw-semibold">Classifica</div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Vista classifica">
                    <button id="btnStandingsNative" type="button" class="btn btn-primary">Nativa</button>
                    <button id="btnStandingsWidget" type="button" class="btn btn-outline-primary">Widget</button>
                </div>
            </div>

            <div id="standings-native">
                @if (Model.Data.Standings.Count == 0)
                {
                    <div class="text-muted">Classifica non disponibile per questa lega/stagione.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Squadra</th>
                                    <th class="text-center">Punti</th>
                                    <th class="text-center">G</th>
                                    <th class="text-center">V</th>
                                    <th class="text-center">N</th>
                                    <th class="text-center">P</th>
                                    <th class="text-center">GF</th>
                                    <th class="text-center">GA</th>
                                    <th class="text-center">Diff</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in Model.Data.Standings)
                                {
                                    var isHome = s.TeamId == Model.Data.HomeId;
                                    var isAway = s.TeamId == Model.Data.AwayId;
                                    var rowClass = isHome ? "table-success" : (isAway ? "table-danger" : "");
                                    <tr class="@rowClass">
                                        <td>@s.Rank</td>
                                        <td>@s.TeamName</td>
                                        <td class="text-center fw-bold">@s.Points</td>
                                        <td class="text-center">@s.Played</td>
                                        <td class="text-center">@s.Win</td>
                                        <td class="text-center">@s.Draw</td>
                                        <td class="text-center">@s.Lose</td>
                                        <td class="text-center">@s.GF</td>
                                        <td class="text-center">@s.GA</td>
                                        <td class="text-center">@s.Diff</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            <div id="standings-widget" class="d-none">
                <div class="card card-body">
                    <api-sports-widget data-type="config"
                                       data-key="9146b11baf44d94af6e14d347213d63a"
                                       data-sport="football"
                                       data-lang="it"
                                       data-theme="grey"
                                       data-show-logos="true"
                                       data-standings="true">
                    </api-sports-widget>

                    <api-sports-widget data-type="standings"
                                       data-league="@Model.Data.LeagueId"
                                       data-season="@Model.Data.Season">
                    </api-sports-widget>

                    <noscript class="text-muted">
                        Abilita JavaScript per visualizzare la classifica del widget.
                    </noscript>
                </div>
            </div>
        </div>

        <!-- PRONOSTICI: Quote (placeholder) -->
        <div class="tab-pane fade" id="tab-odds" role="tabpanel">
            <div class="alert alert-secondary">
                <div class="d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                    <strong>Quote</strong>: integrazione in arrivo. Qui mostreremo le quote dei bookmaker.
                </div>
            </div>
        </div>

        <!-- ANALISI: Corner -->
        <div class="tab-pane fade" id="tab-corners" role="tabpanel">
            @if (Model.Data.Corners is null || Model.Data.Corners.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi corner disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Corners.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th style="width:60%;">Metrica</th>
                                    <th class="text-end">Valore</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    var orderedKeys = groups.Keys.OrderBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Casa</span><span class="fw-bold">@row.Casa</span></div></div>
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Ospite</span><span class="fw-bold">@row.Ospite</span></div></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- ANALISI: Cartellini -->
        <div class="tab-pane fade" id="tab-cards" role="tabpanel">
            @if (Model.Data.Cards is null || Model.Data.Cards.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi cartellini disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Cards.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    var orderedKeys = groups.Keys.OrderBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Casa</span><span class="fw-bold">@row.Casa</span></div></div>
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Ospite</span><span class="fw-bold">@row.Ospite</span></div></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- ANALISI: Falli -->
        <div class="tab-pane fade" id="tab-fouls" role="tabpanel">
            @if (Model.Data.Fouls is null || Model.Data.Fouls.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi falli disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Fouls.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    var orderedKeys = groups.Keys.OrderBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Casa</span><span class="fw-bold">@row.Casa</span></div></div>
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Ospite</span><span class="fw-bold">@row.Ospite</span></div></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- ANALISI: Fuorigioco -->
        <div class="tab-pane fade" id="tab-offsides" role="tabpanel">
            @if (Model.Data.Offsides is null || Model.Data.Offsides.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi fuorigioco disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Offsides.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    var orderedKeys = groups.Keys.OrderBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Casa</span><span class="fw-bold">@row.Casa</span></div></div>
                                    <div class="col-6"><div class="p-2 bg-light rounded d-flex justify-content-between"><span>Ospite</span><span class="fw-bold">@row.Ospite</span></div></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- ANALISI: Tiri -->
        <div class="tab-pane fade" id="tab-shots" role="tabpanel">
            @if (Model.Data.Shots is null || Model.Data.Shots.Metrics.Count == 0)
            {
                <div class="text-muted">Nessuna analisi tiri disponibile.</div>
            }
            else
            {
                var metrics = Model.Data.Shots.Metrics;

                bool hasSides = metrics.Keys.Any(k =>
                k != null && (
                k.EndsWith("-Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Home", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Away", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith("-Ospite", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Casa", StringComparison.OrdinalIgnoreCase) ||
                k.EndsWith(" - Ospite", StringComparison.OrdinalIgnoreCase)
                ));

                if (!hasSides)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead><tr><th style="width:60%;">Metrica</th><th class="text-end">Valore</th></tr></thead>
                            <tbody>
                                @foreach (var kv in metrics)
                                {
                                    <tr><td>@kv.Key</td><td class="text-end">@kv.Value</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    var groups = metrics
                    .Select(kv =>
                    {
                        var key = kv.Key?.Trim() ?? "";
                        var lastDash = key.LastIndexOf('-');
                        var baseName = lastDash > 0 ? key.Substring(0, lastDash).Trim() : key;
                        var side = lastDash > 0 ? key[(lastDash + 1)..].Trim() : "";
                        return new { baseName, side, value = kv.Value };
                    })
                    .GroupBy(x => x.baseName, StringComparer.OrdinalIgnoreCase)
                    .ToDictionary(
                    g => g.Key,
                    g => new
                    {
                        Casa = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Casa", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Home", StringComparison.OrdinalIgnoreCase))?.value ?? "—",
                        Ospite = g.FirstOrDefault(i =>
                            string.Equals(i.side, "Ospite", StringComparison.OrdinalIgnoreCase) ||
                            string.Equals(i.side, "Away", StringComparison.OrdinalIgnoreCase))?.value ?? "—"
                    },
                    StringComparer.OrdinalIgnoreCase
                    );

                    string[] desiredOrder = new[] {
                        "Effettuati","Subiti","In Casa","Fuoricasa",
                        "Ultime 5","Partite Vinte","Partite Pareggiate","Partite Perse"
                        };

                    var orderedKeys = groups.Keys
                    .OrderBy(k => { var idx = Array.IndexOf(desiredOrder, k); return idx < 0 ? int.MaxValue : idx; })
                    .ThenBy(k => k);

                    <div class="vstack gap-3">
                        @foreach (var key in orderedKeys)
                        {
                            var row = groups[key];
                            <div class="mb-2">
                                <div class="fw-semibold border-bottom pb-1">@key</div>
                                <div class="row g-2 pt-2">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>Casa</span><span class="fw-bold">@row.Casa</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded d-flex justify-content-between">
                                            <span>Ospite</span><span class="fw-bold">@row.Ospite</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- PRONOSTICI: Exchange -->
        <div class="tab-pane fade" id="tab-exchange" role="tabpanel">
            @if (Model.Data.Exchange is null)
            {
                <div class="text-muted">Nessun dato Exchange disponibile.</div>
            }
            else
            {
                var e = Model.Data.Exchange;

                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Bancata consigliata</strong></span><span>@e.BancataConsigliata</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 1 – Affidabilità</span><span>@e.Banca1Affidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca X – Affidabilità</span><span>@e.BancaXAffidabilita%</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Banca 2 – Affidabilità</span><span>@e.Banca2Affidabilita%</span></li>
                    <li class="list-group-item"><strong>Top lay risultati esatti:</strong> @e.BancaRisultato1, @e.BancaRisultato2, @e.BancaRisultato3</li>
                </ul>

                @if (User.IsInRole("SuperAdmin"))
                {
                    string? best1x2 = null;
                    if (e is not null)
                    {
                        var items = new List<(string key, int? val)>
                        { ("1", e.Banca1Affidabilita), ("X", e.BancaXAffidabilita), ("2", e.Banca2Affidabilita) };

                        var best = items.Where(i => i.val.HasValue)
                        .OrderByDescending(i => i.val!.Value)
                        .FirstOrDefault();

                        if (best.val.HasValue) best1x2 = best.key;
                    }

                    <form method="post" asp-page-handler="SendExchange" class="mt-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Data.MatchId" />
                        <input type="hidden" name="topicName" value="ExchangeDaPubblicare" />

                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Bancata consigliata</label>
                                <select name="customLay" class="form-select">
                                    <option value="">-- Seleziona --</option>
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato1))
                                    {
                                        <option value="@e.BancaRisultato1">@e.BancaRisultato1</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato2))
                                    {
                                        <option value="@e.BancaRisultato2">@e.BancaRisultato2</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(e?.BancaRisultato3))
                                    {
                                        <option value="@e.BancaRisultato3">@e.BancaRisultato3</option>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(best1x2))
                                    {
                                        <option value="@best1x2">@best1x2</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Livello di rischio</label>
                                <select name="riskLevel" class="form-select">
                                    <option value="Basso">Basso</option>
                                    <option value="Medio">Medio</option>
                                    <option value="Alto">Alto</option>
                                </select>
                            </div>

                            <div class="col-md-3 text-end">
                                <button type="submit" class="btn btn-success w-100">🚀 Invia su Telegram</button>
                            </div>
                        </div>
                    </form>
                }
            }
        </div>
    </div>

    <!-- Script per gruppi -->
    <script>
        (function () {
            const btnPron = document.getElementById('btnGroupPron');
            const btnAnal = document.getElementById('btnGroupAnal');
            const tabsUl  = document.getElementById('matchTabs');

            function showGroup(group) {
                tabsUl.querySelectorAll('.group-pron').forEach(li => li.classList.toggle('d-none', group !== 'pron'));
                tabsUl.querySelectorAll('.group-anal').forEach(li => li.classList.toggle('d-none', group !== 'anal'));

                if (group === 'pron') {
                    btnPron.classList.add('btn-primary'); btnPron.classList.remove('btn-outline-primary');
                    btnAnal.classList.add('btn-outline-primary'); btnAnal.classList.remove('btn-primary');
                } else {
                    btnAnal.classList.add('btn-primary'); btnAnal.classList.remove('btn-outline-primary');
                    btnPron.classList.add('btn-outline-primary'); btnPron.classList.remove('btn-primary');
                }

                const activeBtn = tabsUl.querySelector('.nav-link.active');
                const activeLi  = activeBtn ? activeBtn.closest('li') : null;
                const activeIsInGroup = activeLi && !activeLi.classList.contains('d-none');

                if (!activeIsInGroup) {
                    const firstVisible = tabsUl.querySelector(group === 'pron' ? '.group-pron .nav-link' : '.group-anal .nav-link');
                    if (firstVisible) firstVisible.click();
                }
            }

            btnPron?.addEventListener('click', () => showGroup('pron'));
            btnAnal?.addEventListener('click', () => showGroup('anal'));

            document.addEventListener('DOMContentLoaded', () => showGroup('pron'));
        })();
    </script>

    <script>
        (function () {
          const btnNative = document.getElementById('btnStandingsNative');
          const btnWidget = document.getElementById('btnStandingsWidget');
          const paneNative = document.getElementById('standings-native');
          const paneWidget = document.getElementById('standings-widget');

          function setMode(mode) {
            const isWidget = mode === 'widget';

            paneNative.classList.toggle('d-none',  isWidget);
            paneWidget.classList.toggle('d-none', !isWidget);

            btnNative.classList.toggle('btn-primary', !isWidget);
            btnNative.classList.toggle('btn-outline-primary', isWidget);
            btnWidget.classList.toggle('btn-primary', isWidget);
            btnWidget.classList.toggle('btn-outline-primary', !isWidget);

            try { localStorage.setItem('standingsView', mode); } catch {}
          }

          btnNative?.addEventListener('click', () => setMode('native'));
          btnWidget?.addEventListener('click', () => setMode('widget'));

          let saved = null;
          try { saved = localStorage.getItem('standingsView'); } catch {}
          setMode(saved === 'widget' ? 'widget' : 'native');
        })();
    </script>

    @section Scripts {
        <script type="module" src="https://widgets.api-sports.io/3.1.0/widgets.js"></script>
    }
</div>
