@page
@model NextStakeWebApp.Pages.Database.IndexModel

@{
    ViewData["Title"] = "Database";
}

<h2>Database</h2>

@if (!Model.IsPlan1)
{
    <div class="alert alert-warning">
        Accesso non consentito.
    </div>
}
else
{
    <div class="card p-3">
        <p class="mb-2">
            Questo comando calcola e salva i pronostici per <b>tutti i match di oggi</b> (Europe/Rome)
            nella tabella <code>NextMatchPredictionsCache</code>.
        </p>

        <form id="refreshForm" method="post" asp-page-handler="RefreshPredictionsStream">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-primary">
                Aggiorna Pronostici
            </button>
        </form>
 @if (Model.TodayCache != null && Model.TodayCache.Any())
{
    <hr />
    <h5 class="mt-3 mb-2">Pronostici salvati oggi (cache)</h5>

<div class="table-responsive">
    <table class="table table-sm table-striped table-dark align-middle mb-0">
        <thead>
            <tr>
                <th>MatchId</th>
                <th>Data</th>
                <th>GSC</th>
                <th>GSO</th>
                <th>TOT</th>
                <th>Esito</th>
                <th>OU</th>
                <th>GG/NG</th>
                <th>Combo</th>
            </tr>
        </thead>
        <tbody>
            @foreach (NextStakeWebApp.Pages.Database.IndexModel.CachedPredictionRow r in Model.TodayCache)
            {
                <tr>
                    <td>@r.MatchId</td>
                    <td>@(r.EventDate?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                    <td>@(r.GoalSimulatiCasa?.ToString() ?? "-")</td>
                    <td>@(r.GoalSimulatiOspite?.ToString() ?? "-")</td>
                    <td>@(r.TotaleGoalSimulati?.ToString() ?? "-")</td>
                    <td>@(r.Esito ?? "-")</td>
                    <td>@(r.OverUnderRange ?? "-")</td>
                    <td>@(r.GG_NG ?? "-")</td>
                    <td>@(r.ComboFinale ?? "-")</td>
                </tr>
            }
        </tbody>
    </table>
</div>

}


        <!-- Modal log (UNA SOLA VOLTA) -->
        <div class="modal fade" id="refreshLogModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Aggiornamento pronostici in corso…</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
                    </div>

                    <div class="modal-body">
                        <!-- PROGRESS -->
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="refreshProgressText">Progresso: 0/0</small>
                                <small class="text-muted" id="refreshProgressPct">0%</small>
                            </div>
                            <div class="progress" style="height:10px;">
                                <div id="refreshProgressBar"
                                     class="progress-bar"
                                     role="progressbar"
                                     style="width:0%;"
                                     aria-valuenow="0"
                                     aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>
                        </div>

                        <pre id="refreshLogBox"
                             style="white-space:pre-wrap; margin:0; font-size:.9rem; line-height:1.25; max-height:55vh;"></pre>
                    </div>

                    <div class="modal-footer">
                        <button id="btnCloseLog" type="button" class="btn btn-secondary" data-bs-dismiss="modal" disabled>
                            Chiudi
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.LastRun != null)
        {
            <hr />
            <div class="mt-2">
                <div><b>Ultima esecuzione:</b> @Model.LastRun.Value.ToString("yyyy-MM-dd HH:mm:ss") (ora server)</div>
                <div><b>Match trovati oggi:</b> @Model.TodayMatchesCount</div>
                <div><b>Righe salvate/aggiornate:</b> @Model.UpsertedCount</div>

                @if (!string.IsNullOrWhiteSpace(Model.Error))
                {
                    <div class="alert alert-danger mt-2">
                        @Model.Error
                    </div>
                }
            </div>
        }
    </div>
}

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('refreshForm');
            const modalEl = document.getElementById('refreshLogModal');
            const logBox = document.getElementById('refreshLogBox');
            const btnClose = document.getElementById('btnCloseLog');

            const progressText = document.getElementById('refreshProgressText');
            const progressPct = document.getElementById('refreshProgressPct');
            const progressBar = document.getElementById('refreshProgressBar');

            if (!form || !modalEl || !logBox || !btnClose) return;
            let lastIdx = 0;
let lastTotal = 0;


            function resetProgress() {
                if (progressText) progressText.textContent = 'Progresso: 0/0';
                if (progressPct) progressPct.textContent = '0%';
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', '0');
                }
            }

         function updateProgressFromText(fullText) {
            const all = fullText.match(/📦\s*Batch\s*(\d+)\s*\/\s*(\d+)/g);
            if (!all || !all.length) return;

            // LOG INVERSO (prepend): la riga più recente è la PRIMA nel testo
            const raw = all[0];
            const m = raw.match(/📦\s*Batch\s*(\d+)\s*\/\s*(\d+)/);
            if (!m) return;

            lastIdx = parseInt(m[1], 10);
            lastTotal = parseInt(m[2], 10);

            const pct = lastTotal > 0 ? Math.min(100, Math.round((lastIdx / lastTotal) * 100)) : 0;

            if (progressText) progressText.textContent = `Progresso: ${lastIdx}/${lastTotal}`;
            if (progressPct) progressPct.textContent = `${pct}%`;
            if (progressBar) {
                progressBar.style.width = `${pct}%`;
                progressBar.setAttribute('aria-valuenow', String(pct));
            }
        }


        // LOG INVERSO: scrivo sempre in TESTA
        function prependLog(chunk) {
            logBox.textContent = chunk + logBox.textContent;
            const bodyEl = modalEl.querySelector('.modal-body');
            if (bodyEl) bodyEl.scrollTop = 0;

            updateProgressFromText(logBox.textContent);
        }



            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                // reset UI
                logBox.textContent = '';
                btnClose.disabled = true;
                resetProgress();

                // apre modal (blocca click fuori + ESC)
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
                modal.show();

                // antiforgery token
                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenInput ? tokenInput.value : null;

                try {
                    const resp = await fetch(form.action, {
                        method: 'POST',
                        headers: token ? { 'RequestVerificationToken': token } : {},
                        body: new FormData(form)
                    });

                    if (!resp.ok) {
                        prependLog(`\n❌ HTTP ${resp.status}\n`);
                        btnClose.disabled = false;
                        return;
                    }

                    // streaming
                    if (!resp.body || !resp.body.getReader) {
                        const txt = await resp.text();
                        prependLog(txt);
                        btnClose.disabled = false;
                        return;
                    }

                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder('utf-8');

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        prependLog(chunk);
                    }

                           // completato
        prependLog("\n🏁 STREAM TERMINATO.\n");

        // se abbiamo un totale e siamo arrivati in fondo, forza 100%
        if (lastTotal > 0 && lastIdx >= lastTotal) {
            if (progressText) progressText.textContent = `Progresso: ${lastTotal}/${lastTotal}`;
            if (progressPct) progressPct.textContent = `100%`;
            if (progressBar) {
                progressBar.style.width = `100%`;
                progressBar.setAttribute('aria-valuenow', '100');
            }
        }



        // rileva errore nel log (se c'è, NON chiudere la modal)
        const hasError =
            logBox.textContent.includes("❌") ||
            logBox.textContent.includes("ERROR") ||
            logBox.textContent.includes("FAIL") ||
            logBox.textContent.includes("SQL ERROR") ||
            logBox.textContent.includes("EX:");

        btnClose.disabled = false;

        if (!hasError) {
            // ✅ SOLO SE NON CI SONO ERRORI: chiudi e ricarica
            setTimeout(() => {
                try { modal.hide(); } catch { }
                setTimeout(() => location.reload(), 250);
            }, 900);

            // fallback: se l’utente clicca “Chiudi”, ricarica
            btnClose.addEventListener('click', () => location.reload(), { once: true });
        } else {
            // ❌ ERRORE: resta aperta per copiare il log
            prependLog("\n🛑 ERRORE RILEVATO: finestra lasciata aperta per copia/incolla.\n");
            // opzionale: evidenzia log
            // logBox.style.color = "#ff6b6b";
        }


                } catch (err) {
                    prependLog(`\n❌ ERRORE JS: ${err}\n`);
                    btnClose.disabled = false;
                }
            });
        })();
    </script>
}
